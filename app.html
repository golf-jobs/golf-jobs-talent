<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Jobs - Premium Talent Pools</title>
    
    <!-- Add Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --augusta-green: #004d26;
            --fairway-green: #2d5f3f;
            --masters-green: #3a7858;
            --putting-green: #6b9080;
            --club-gold: #c9a961;
            --trophy-gold: #f4d03f;
            --sand-bunker: #f5e6d3;
            --morning-mist: #f8f9fa;
            --pro-shop-navy: #1a2332;
            --scorecard-white: #ffffff;
            --rough-gray: #6c757d;
            --hazard-red: #c9302c;
            --water-hazard: #2c5aa0;
        }

        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: var(--pro-shop-navy);
            background: linear-gradient(180deg, #f8f9fa 0%, #e8efe8 100%);
            min-height: 100vh;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--augusta-green);
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 450px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-title {
            text-align: center;
            color: var(--augusta-green);
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .login-subtitle {
            text-align: center;
            color: var(--rough-gray);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--pro-shop-navy);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e1e8e4;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--masters-green);
            box-shadow: 0 0 0 3px rgba(58, 120, 88, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--masters-green) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Poppins', sans-serif;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 77, 38, 0.3);
        }

        .login-error {
            background: #fee;
            color: var(--hazard-red);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        /* Main App */
        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--fairway-green) 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
        }

        .logo img {
            height: 60px;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 0.625rem 1.25rem;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: var(--club-gold);
            color: var(--augusta-green);
            font-weight: 600;
        }

        .shortlist-badge {
            background: rgba(255,255,255,0.3);
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            margin-left: 0.25rem;
            font-size: 0.875rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 12px;
        }

        .credits-badge {
            background: linear-gradient(135deg, var(--club-gold) 0%, var(--trophy-gold) 100%);
            color: var(--augusta-green);
            padding: 0.375rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
        }

        .btn-logout {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* View Sections */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Pools Grid */
        .pools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .pool-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .pool-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .pool-card.locked {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .pool-header {
            background: linear-gradient(135deg, var(--fairway-green) 0%, var(--masters-green) 100%);
            padding: 2rem;
            color: white;
            position: relative;
        }

        .pool-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .pool-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--club-gold);
            color: var(--augusta-green);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 700;
        }

        .pool-stats {
            padding: 2rem;
        }

        .pool-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .pool-stat:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        /* Candidates Grid */
        .candidates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 1.75rem;
            margin-bottom: 2rem;
        }

        .candidate-card {
            background: white;
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .candidate-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--augusta-green), var(--masters-green), var(--club-gold));
        }

        .candidate-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            border-color: var(--masters-green);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 35, 50, 0.95);
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            width: 90%;
            max-width: 700px;
            border-radius: 20px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--rough-gray);
        }

        .modal-close:hover {
            color: var(--pro-shop-navy);
        }

        /* Buttons */
        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--masters-green) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 77, 38, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--augusta-green);
            border: 2px solid var(--augusta-green);
        }

        .btn-secondary:hover {
            background: var(--augusta-green);
            color: white;
        }

        .section-box {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            color: var(--rough-gray);
        }

        .breadcrumb a {
            color: var(--masters-green);
            text-decoration: none;
            font-weight: 600;
        }

        .breadcrumb a:hover {
            color: var(--augusta-green);
        }

        .skills-text {
            color: var(--rough-gray);
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .pools-grid, .candidates-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div style="text-align: center; margin-bottom: 2rem;">
                <img src="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20black.png?updatedAt=1757017924442" alt="Golf Jobs" style="width: 200px;">
            </div>
            <h1 class="login-title">Talent Pool Access</h1>
            <p class="login-subtitle">Exclusive recruitment platform</p>
            
            <div id="loginError" class="login-error">Invalid credentials. Please try again.</div>
            
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="loginEmail" required placeholder="your@company.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn-login">Sign In</button>
            </form>
            
            <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e1e8e4;">
                <p style="color: var(--rough-gray); font-size: 0.85rem;">© 2024 Golf Jobs. Professional recruitment excellence.</p>
                <p style="margin-top: 0.5rem; color: var(--rough-gray); font-size: 0.85rem;">Need access? Contact <strong>talent@golf-jobs.com</strong></p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo" onclick="goHome()">
                    <img src="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20white.png?updatedAt=1758280288759" alt="Golf Jobs">
                </div>
                <nav class="nav-tabs">
                    <button class="nav-tab active" onclick="switchView('pools')">Talent Pools</button>
                    <button class="nav-tab" onclick="switchView('shortlist')">
                        Shortlist <span id="shortlistBadge" class="shortlist-badge" style="display: none;">0</span>
                    </button>
                    <button class="nav-tab" onclick="switchView('account')">My Account</button>
                    <button class="nav-tab" onclick="switchView('requests')">My Requests</button>
                    <button id="adminTab" class="nav-tab" onclick="switchView('admin')" style="display:none;">Admin</button>
                </nav>
                <div class="user-info">
                    <span id="userName">Welcome</span>
                    <div class="credits-badge">
                        Credits: <span id="creditsCount">0</span>
                    </div>
                    <button class="btn-logout" onclick="handleLogout()">Sign Out</button>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Pools View -->
            <div id="poolsView" class="view-section active">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Your Talent Pools</h1>
                <p style="color: var(--rough-gray); margin-bottom: 2rem; font-size: 1.1rem;">Select a talent pool to browse candidates</p>
                <div class="pools-grid" id="poolsGrid"></div>
                
                <div class="section-box">
                    <h2 style="font-size: 1.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Unlock More Talent Pools</h2>
                    <p style="color: var(--rough-gray); margin-bottom: 1.5rem;">Expand your recruitment reach with access to additional regions</p>
                    <button class="btn btn-primary" onclick="alert('Contact talent@golf-jobs.com for access to additional pools')">Request Access</button>
                </div>
            </div>

            <!-- Pool Detail View -->
            <div id="poolDetailView" class="view-section">
                <div class="breadcrumb">
                    <a href="#" onclick="switchView('pools')">Talent Pools</a>
                    <span>→</span>
                    <span id="currentPoolName">Pool Name</span>
                </div>
                
                <div class="section-box">
                    <input type="text" id="searchInput" placeholder="Search by name, role, skills, or location..." 
                           style="width: 100%; padding: 0.875rem; border: 2px solid #e1e8e4; border-radius: 12px; font-size: 1rem; margin-bottom: 1rem;">
                    
                    <!-- Filters -->
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-start;">
                        <select id="salaryFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Salaries</option>
                            <option value="0-30000">£20-30k</option>
                            <option value="30000-40000">£30-40k</option>
                            <option value="40000-50000">£40-50k</option>
                            <option value="50000-60000">£50-60k</option>
                            <option value="60000-70000">£60-70k</option>
                            <option value="70000+">£70k+</option>
                        </select>
                        
                        <select id="noticeFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Notice Periods</option>
                            <option value="immediately">Available Immediately</option>
                            <option value="1 week">1 Week</option>
                            <option value="1 month">1 Month</option>
                            <option value="2 months">2 Months</option>
                            <option value="3 months">3 Months</option>
                        </select>
                        
                        <select id="lookingFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">Active/Passive</option>
                            <option value="YES">Actively Looking</option>
                            <option value="NO">Not Actively Looking</option>
                        </select>
                        
                        <select id="categoryFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Categories</option>
                            <option value="greenkeeping">Greenkeeping</option>
                            <option value="management">Management</option>
                            <option value="sales">Sales & Business Dev</option>
                            <option value="marketing">Marketing & PR</option>
                            <option value="fandB">F&B / Hospitality</option>
                            <option value="professional">Golf Professional</option>
                            <option value="operations">Operations</option>
                            <option value="retail">Retail & Pro Shop</option>
                            <option value="maintenance">Maintenance & Facilities</option>
                            <option value="admin">Admin & Support</option>
                            <option value="other">Other</option>
                        </select>
                        
                        <!-- Location Filter Dropdown -->
                        <div style="position: relative;">
                            <button onclick="toggleLocationDropdown()" 
                                    style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; 
                                           font-size: 0.95rem; background: white; cursor: pointer; 
                                           min-width: 150px; text-align: left; display: flex; 
                                           justify-content: space-between; align-items: center;">
                                <span id="locationFilterText">All Locations</span>
                                <span style="font-size: 0.8rem;">▼</span>
                            </button>
                            <div id="locationDropdown" style="display: none; position: absolute; top: 100%; 
                                                              left: 0; right: 0; background: white; 
                                                              border: 2px solid #e1e8e4; border-radius: 8px; 
                                                              margin-top: 0.25rem; max-height: 300px; 
                                                              overflow-y: auto; z-index: 1000; min-width: 200px;">
                                <div style="padding: 0.5rem; border-bottom: 1px solid #e1e8e4;">
                                    <button onclick="selectAllLocations()" 
                                            style="margin-right: 0.5rem; padding: 0.25rem 0.5rem; 
                                                   border: 1px solid #e1e8e4; border-radius: 4px; 
                                                   background: white; cursor: pointer; font-size: 0.85rem;">
                                        Select All
                                    </button>
                                    <button onclick="clearAllLocations()" 
                                            style="padding: 0.25rem 0.5rem; border: 1px solid #e1e8e4; 
                                                   border-radius: 4px; background: white; cursor: pointer; 
                                                   font-size: 0.85rem;">
                                        Clear All
                                    </button>
                                </div>
                                <div id="locationCheckboxes" style="padding: 0.5rem;">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="applyFilters()" class="btn" style="padding: 0.5rem 1.25rem; background: var(--masters-green); color: white; font-size: 0.9rem;">
                            Apply Filters
                        </button>
                        <button onclick="clearFilters()" class="btn" style="padding: 0.5rem 1.25rem; background: #e5e7eb; color: var(--rough-gray); font-size: 0.9rem;">
                            Clear All
                        </button>
                    </div>
                </div>
                
                <div id="candidateCount" style="margin-bottom: 1rem; color: var(--rough-gray);"></div>
                <div class="candidates-grid" id="candidatesGrid"></div>
            </div>

            <!-- Shortlist View -->
            <div id="shortlistView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Your Shortlist</h1>
                <div id="shortlistContent"></div>
            </div>

            <!-- Account View -->
            <div id="accountView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 2rem;">My Account</h1>
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1rem;">Account Overview</h2>
                    <p style="margin-bottom: 1rem;"><strong>Name:</strong> <span id="accountName">-</span></p>
                    <p style="margin-bottom: 1rem;"><strong>Email:</strong> <span id="accountEmail">-</span></p>
                    <p style="margin-bottom: 1rem;"><strong>Credits Balance:</strong> <span id="accountCredits">0</span></p>
                    <p><strong>Total Requests:</strong> <span id="totalRequests">0</span></p>
                </div>
            </div>

            <!-- Requests View -->
            <div id="requestsView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 2rem;">My Requests</h1>
                <div class="section-box">
                    <div id="requestsList"></div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 2rem;">Admin Panel</h1>
                
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1rem;">All Users</h2>
                    <div id="adminUsersList"></div>
                </div>
                
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1rem;">All Requests</h2>
                    <div id="adminRequestsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Candidate Modal -->
    <div id="candidateModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">×</button>
            <h2 id="modalTitle" style="color: var(--augusta-green); margin-bottom: 1rem;"></h2>
            <div id="modalBody"></div>
            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="addToShortlist()">Save to Shortlist</button>
                <button class="btn btn-primary" onclick="requestContact()">Request Contact Details (1 Credit)</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://kbadedwbcjetxiertztv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtiYWRlZHdiY2pldHhpZXJ0enR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDAyNDMsImV4cCI6MjA3Mzg3NjI0M30.igm3XjM8l1OXfilQaAHtmJyCDe9eXILV_P9B3_sUzwg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state
        let currentUser = null;
        let currentPool = null;
        let currentCandidate = null;
        let userProfile = null;
        let userPools = [];
        let shortlist = [];
        let allCandidates = [];
        let selectedLocations = new Set();
        let availableLocations = new Set();

        // Utility functions
        function toTitleCase(str) {
            if (!str) return str;
            
            // List of acronyms that should always be uppercase
            const acronyms = ['UK', 'USA', 'US', 'CEO', 'CFO', 'COO', 'CTO', 'CIO', 'CMO', 
                             'PGA', 'PR', 'HR', 'IT', 'SEO', 'SEM', 'EMEA', 'APAC', 'B2B', 
                             'B2C', 'VP', 'SVP', 'EVP', 'GM', 'MD', 'PA', 'EA', 'F&B', 
                             'R&D', 'QA', 'UI', 'UX', 'API', 'CRM', 'ERP', 'KPI', 'ROI',
                             'P&L', 'M&A', 'IPO', 'MBA', 'PhD', 'CPA', 'LLP', 'LLC'];
            
            return str.toLowerCase().split(/(\s+|-)/).map(word => {
                // Check if word (without punctuation) is an acronym
                const cleanWord = word.replace(/[.,;:!?]/g, '');
                const upperClean = cleanWord.toUpperCase();
                
                if (acronyms.includes(upperClean)) {
                    return word.replace(cleanWord, upperClean);
                }
                
                // Otherwise, title case it
                if (word.length > 0) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }
                return word;
            }).join('');
        }

        function cleanAndFormatLocation(townCity, country) {
            const excludeTerms = ['England', 'United Kingdom', 'UK', 'Scotland', 'Wales', 'Northern Ireland', 
                                 'Great Britain', 'GB', 'Uk', 'england', 'united kingdom'];
            
            // Clean up the town/city field
            let cleanedTown = townCity ? townCity.trim() : '';
            
            // Remove any duplicates or extra info
            if (cleanedTown.includes(',')) {
                cleanedTown = cleanedTown.split(',')[0].trim();
            }
            
            // Check if country field contains useful non-excluded info
            let cleanedCountry = country ? country.trim() : '';
            
            // If country is in exclude list, ignore it
            if (excludeTerms.some(term => cleanedCountry.toLowerCase() === term.toLowerCase())) {
                cleanedCountry = '';
            }
            
            // If country contains a comma, it might have town info
            if (cleanedCountry && cleanedCountry.includes(',')) {
                const parts = cleanedCountry.split(',');
                const firstPart = parts[0].trim();
                if (!excludeTerms.some(term => firstPart.toLowerCase() === term.toLowerCase())) {
                    if (!cleanedTown) {
                        cleanedTown = firstPart;
                    }
                    cleanedCountry = '';
                }
            }
            
            // Handle all caps
            if (cleanedTown === cleanedTown.toUpperCase() && cleanedTown.length > 2) {
                cleanedTown = toTitleCase(cleanedTown);
            } else {
                cleanedTown = toTitleCase(cleanedTown);
            }
            
            // Final location
            if (cleanedTown) {
                return cleanedTown;
            }
            
            return 'Location Not Specified';
        }

        function formatSalaryExact(salary) {
            if (!salary) return 'Salary Negotiable';
            const num = parseFloat(salary);
            if (isNaN(num)) return 'Salary Negotiable';
            return `£${num.toLocaleString()}`;
        }

        function formatNoticePeriod(notice) {
            if (!notice) return 'Unknown Notice Period';
            const lowerNotice = notice.toLowerCase();
            if (lowerNotice.includes('immediately') || lowerNotice.includes('immediate')) return 'Available immediately';
            if (lowerNotice.includes('1 week')) return '1 week notice';
            if (lowerNotice.includes('2 week')) return '2 weeks notice';
            if (lowerNotice.includes('1 month')) return '1 month notice';
            if (lowerNotice.includes('2 month')) return '2 months notice';
            if (lowerNotice.includes('3 month')) return '3 months notice';
            return notice + ' notice';
        }

        function generateSummaryPreview(text, maxLength = 120) {
            if (!text) return '';
            
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            
            if (sentences.length === 0) return text.substring(0, maxLength) + '...';
            
            const keyPhrases = ['years experience', 'specializing in', 'expertise in', 'responsible for', 
                               'passionate about', 'skilled in', 'background in', 'focused on'];
            
            let bestSentence = sentences[0];
            for (let sentence of sentences) {
                if (keyPhrases.some(phrase => sentence.toLowerCase().includes(phrase))) {
                    bestSentence = sentence;
                    break;
                }
            }
            
            const summary = bestSentence.trim();
            if (summary.length > maxLength) {
                return summary.substring(0, maxLength) + '...';
            }
            return summary;
        }

        function formatSkillsDisplay(skillsString) {
            if (!skillsString) return '';
            
            // Check if it's paragraph-style text
            if (skillsString.length > 200 && !skillsString.includes(',') && !skillsString.includes('•')) {
                return `<p class="skills-text">${skillsString.substring(0, 100)}...</p>`;
            }
            
            // Check for bullet points
            let skills = [];
            if (skillsString.includes('•') || skillsString.includes('–')) {
                skills = skillsString.split(/[•–-]/).map(s => s.trim()).filter(s => s && s.length > 3);
            } else if (skillsString.includes(',')) {
                skills = skillsString.split(',').map(s => s.trim()).filter(s => s);
            } else {
                return `<p class="skills-text">${skillsString}</p>`;
            }
            
            // Return as tags only if we have clear skills
            if (skills.length > 0 && skills.length < 10) {
                return skills.slice(0, 3).map(skill => 
                    `<span style="background: rgba(45, 95, 63, 0.1); color: var(--fairway-green); 
                           padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.875rem; 
                           display: inline-block; margin-right: 0.5rem; margin-bottom: 0.5rem;">
                        ${skill.substring(0, 30)}${skill.length > 30 ? '...' : ''}
                    </span>`
                ).join('');
            }
            
            return `<p class="skills-text">${skillsString.substring(0, 100)}...</p>`;
        }

        function calculateWeightedCompleteness(candidate) {
            let score = 0;
            
            // High priority fields (weight: 10)
            const highPriority = {
                'About You': 10,  // Professional Summary
                'Your Skills': 8
            };
            
            // Medium priority fields (weight: 5)
            const mediumPriority = {
                'Current Job Title': 5,
                'Job Title': 5,
                'What are your salary expectations?': 5,
                'Salary Expectations': 5,
                'Notice Period': 5,
                'Actively looking for work': 5
            };
            
            // Low priority fields (weight: 2)
            const lowPriority = {
                'Name': 2,
                'Town/City': 2,
                'Country': 2,
                'Email': 2,
                'LinkedIn': 2,
                'GitHub': 2
            };
            
            // Calculate weighted score
            Object.entries(highPriority).forEach(([field, weight]) => {
                if (candidate[field] && candidate[field].toString().trim().length > 20) {
                    score += weight;
                    // Bonus points for longer, more detailed summaries
                    if (field === 'About You' && candidate[field].length > 200) {
                        score += 5; // Extra bonus for detailed summary
                    }
                }
            });
            
            Object.entries(mediumPriority).forEach(([field, weight]) => {
                if (candidate[field] && candidate[field].toString().trim()) {
                    score += weight;
                }
            });
            
            Object.entries(lowPriority).forEach(([field, weight]) => {
                if (candidate[field] && candidate[field].toString().trim()) {
                    score += weight;
                }
            });
            
            return score;
        }

        function detectJobCategory(jobTitle) {
            if (!jobTitle) return 'other';
            
            const title = jobTitle.toLowerCase();
            
            // Greenkeeping & Course Management
            const greenkeepingKeywords = [
                'greenkeep', 'green keep', 'course manager', 'turf', 'agronomist', 'superintendent',
                'groundsman', 'grounds', 'course maintenance', 'irrigation', 'horticultur',
                'course care', 'course condition', 'grounds crew', 'greens staff', 'deputy course',
                'assistant greenkeeper', 'head greenkeeper', 'spray technician', 'mechanic greenkeep'
            ];
            if (greenkeepingKeywords.some(keyword => title.includes(keyword))) {
                return 'greenkeeping';
            }
            
            // Management & Executive
            const managementKeywords = [
                'director', 'manager', 'head of', 'chief', 'ceo', 'coo', 'cfo', 'cto', 'cio',
                'president', 'vice president', 'vp ', 'svp', 'evp', 'executive', 'partner',
                'managing director', 'general manager', 'gm ', 'regional manager', 'area manager',
                'operations director', 'commercial director', 'finance director', 'managing partner',
                'owner', 'proprietor', 'chairman', 'board member', 'trustee', 'committee'
            ];
            if (managementKeywords.some(keyword => title.includes(keyword))) {
                return 'management';
            }
            
            // Sales & Business Development
            const salesKeywords = [
                'sales', 'business development', 'account manager', 'commercial', 'revenue',
                'client manager', 'customer success', 'relationship manager', 'account executive',
                'sales representative', 'sales exec', 'biz dev', 'partnerships', 'corporate sales',
                'membership sales', 'sales consultant', 'sales advisor', 'telesales', 'inside sales',
                'field sales', 'sales support', 'sales coordinator', 'key account', 'national account',
                'territory manager', 'district manager', 'business manager', 'development manager'
            ];
            if (salesKeywords.some(keyword => title.includes(keyword))) {
                return 'sales';
            }
            
            // Marketing & PR
            const marketingKeywords = [
                'marketing', 'pr ', 'public relations', 'communications', 'social media', 'brand',
                'digital marketing', 'content', 'copywriter', 'graphic design', 'designer',
                'creative', 'advertising', 'media', 'campaign', 'seo', 'sem', 'ppc', 'email marketing',
                'marketing exec', 'marketing assistant', 'marketing coordinator', 'marketing manager',
                'community manager', 'influence', 'affiliate', 'growth', 'acquisition', 'retention',
                'engagement', 'events', 'event manager', 'event coordinator', 'conference'
            ];
            if (marketingKeywords.some(keyword => title.includes(keyword))) {
                return 'marketing';
            }
            
            // F&B / Hospitality
            const fandBKeywords = [
                'chef', 'food', 'beverage', 'f&b', 'f & b', 'restaurant', 'bar', 'catering',
                'hospitality', 'waiter', 'waitress', 'server', 'barista', 'sommelier', 'kitchen',
                'cook', 'sous chef', 'head chef', 'pastry', 'baker', 'dining', 'banquet',
                'room service', 'food service', 'maitre', 'host', 'hostess', 'steward',
                'breakfast', 'lunch', 'dinner', 'cafe', 'bistro', 'clubhouse', 'halfway house',
                'beverage cart', 'snack bar', 'concession', 'catering manager', 'food manager'
            ];
            if (fandBKeywords.some(keyword => title.includes(keyword))) {
                return 'fandB';
            }
            
            // Golf Professional
            const professionalKeywords = [
                'golf professional', 'pga', 'teaching pro', 'head pro', 'assistant pro',
                'golf coach', 'golf instructor', 'golf teacher', 'club professional',
                'touring pro', 'tour professional', 'golf director', 'director of golf',
                'first assistant', 'second assistant', 'golf services', 'lesson', 'academy',
                'instruction', 'fitting', 'club fitter', 'custom fitting', 'golf shop'
            ];
            if (professionalKeywords.some(keyword => title.includes(keyword))) {
                return 'professional';
            }
            
            // Operations
            const operationsKeywords = [
                'operations', 'coordinator', 'administrator', 'duty manager', 'shift manager',
                'logistics', 'planning', 'scheduling', 'procurement', 'purchasing', 'buyer',
                'supply chain', 'inventory', 'warehouse', 'distribution', 'facilities manager',
                'office manager', 'project manager', 'program manager', 'compliance', 'quality',
                'health and safety', 'h&s', 'risk', 'audit', 'process', 'improvement', 'efficiency'
            ];
            if (operationsKeywords.some(keyword => title.includes(keyword)) && !title.includes('it ')) {
                return 'operations';
            }
            
            // Retail & Pro Shop
            const retailKeywords = [
                'retail', 'pro shop', 'golf shop', 'shop', 'merchandis', 'buyer', 'visual',
                'store manager', 'shop manager', 'retail manager', 'retail assistant',
                'shop assistant', 'sales assistant', 'cashier', 'till', 'stock', 'inventory',
                'display', 'window', 'fashion', 'apparel', 'clothing', 'equipment',
                'club sales', 'golf sales', 'retail supervisor', 'shop supervisor'
            ];
            if (retailKeywords.some(keyword => title.includes(keyword))) {
                return 'retail';
            }
            
            // Maintenance & Facilities
            const maintenanceKeywords = [
                'maintenance', 'mechanic', 'facilities', 'technician', 'engineer', 'electrical',
                'electrician', 'plumber', 'plumbing', 'hvac', 'carpenter', 'joiner', 'painter',
                'decorator', 'handyman', 'repair', 'service', 'workshop', 'machinery',
                'equipment tech', 'golf car', 'golf cart', 'buggy', 'vehicle', 'fleet',
                'building', 'property', 'estate', 'security', 'groundswork', 'landscap'
            ];
            if (maintenanceKeywords.some(keyword => title.includes(keyword))) {
                return 'maintenance';
            }
            
            // Admin & Support
            const adminKeywords = [
                'admin', 'assistant', 'reception', 'secretary', 'clerk', 'support', 'office',
                'pa ', 'personal assistant', 'executive assistant', 'ea ', 'bookkeep',
                'accounts', 'finance assistant', 'payroll', 'hr assistant', 'data entry',
                'customer service', 'call center', 'help desk', 'front desk', 'concierge',
                'coordinator', 'junior', 'trainee', 'apprentice', 'intern', 'entry level'
            ];
            if (adminKeywords.some(keyword => title.includes(keyword))) {
                return 'admin';
            }
            
            return 'other';
        }

        // Location filter functions
        function populateLocationFilter(candidates) {
            availableLocations.clear();
            
            candidates.forEach(candidate => {
                const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                if (location && location !== 'Location Not Specified') {
                    availableLocations.add(location);
                }
            });
            
            const sortedLocations = Array.from(availableLocations).sort();
            const checkboxesDiv = document.getElementById('locationCheckboxes');
            
            checkboxesDiv.innerHTML = sortedLocations.map(location => `
                <div style="margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${location}" 
                               onchange="updateLocationSelection(this)" 
                               style="margin-right: 0.5rem;">
                        <span style="font-size: 0.9rem;">${location}</span>
                    </label>
                </div>
            `).join('');
        }

        function toggleLocationDropdown() {
            const dropdown = document.getElementById('locationDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('locationDropdown');
            const button = e.target.closest('button');
            if (dropdown && !dropdown.contains(e.target) && 
                (!button || button.getAttribute('onclick') !== 'toggleLocationDropdown()')) {
                dropdown.style.display = 'none';
            }
        });

        function updateLocationSelection(checkbox) {
            if (checkbox.checked) {
                selectedLocations.add(checkbox.value);
            } else {
                selectedLocations.delete(checkbox.value);
            }
            updateLocationFilterText();
        }

        function updateLocationFilterText() {
            const text = document.getElementById('locationFilterText');
            if (selectedLocations.size === 0) {
                text.textContent = 'All Locations';
            } else if (selectedLocations.size === 1) {
                text.textContent = Array.from(selectedLocations)[0];
            } else {
                text.textContent = `${selectedLocations.size} locations selected`;
            }
        }

        function selectAllLocations() {
            const checkboxes = document.querySelectorAll('#locationCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                selectedLocations.add(cb.value);
            });
            updateLocationFilterText();
        }

        function clearAllLocations() {
            const checkboxes = document.querySelectorAll('#locationCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            selectedLocations.clear();
            updateLocationFilterText();
        }

        // Check authentication on load
        window.onload = async function() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                await loadUserData(session.user);
                showApp();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
            }
        }

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            } else {
                await loadUserData(data.user);
                showApp();
            }
        }

        // Load user data
        async function loadUserData(user) {
            currentUser = user;
            
            const { data: profile, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();
            
            if (profile) {
                userProfile = profile;
                document.getElementById('userName').textContent = profile.name || user.email;
                document.getElementById('creditsCount').textContent = profile.credits || 0;
                
                if (profile.role === 'admin') {
                    document.getElementById('adminTab').style.display = 'block';
                }
            }
            
            const { data: poolAccess } = await supabase
                .from('user_pool_access')
                .select('pool_id')
                .eq('user_id', user.id);
            
            userPools = poolAccess ? poolAccess.map(p => p.pool_id) : [];
            
            const { data: shortlistData } = await supabase
                .from('shortlists')
                .select('*, candidates(*)')
                .eq('user_id', user.id);
            
            shortlist = shortlistData || [];
            updateShortlistBadge();
        }

        // Show main app
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
            loadPools();
        }

        // Handle logout
        async function handleLogout() {
            await supabase.auth.signOut();
            location.reload();
        }

        // Switch views
        function switchView(view) {
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(view + 'View').classList.add('active');
            if (event && event.target) event.target.classList.add('active');
            
            if (view === 'pools') loadPools();
            else if (view === 'shortlist') loadShortlist();
            else if (view === 'account') loadAccount();
            else if (view === 'requests') loadRequests();
            else if (view === 'admin' && userProfile?.role === 'admin') loadAdmin();
        }

        // Load talent pools
        async function loadPools() {
            const { data: pools } = await supabase
                .from('talent_pools')
                .select('*');
            
            for (let pool of pools) {
                const { count } = await supabase
                    .from('candidates')
                    .select('*', { count: 'exact', head: true })
                    .eq('pool_id', pool.id);
                
                pool.total_candidates = count || 0;
            }
            
            const poolsGrid = document.getElementById('poolsGrid');
            poolsGrid.innerHTML = '';
            
            for (const pool of pools) {
                const hasAccess = userPools.includes(pool.id);
                
                const poolCard = document.createElement('div');
                poolCard.className = hasAccess ? 'pool-card' : 'pool-card locked';
                poolCard.innerHTML = `
                    <div class="pool-header">
                        <div class="pool-title">${pool.name}</div>
                        <div class="pool-badge">${hasAccess ? 'Available' : 'Locked'}</div>
                    </div>
                    <div class="pool-stats">
                        <div class="pool-stat">
                            <span>Total Candidates</span>
                            <span>${pool.total_candidates}</span>
                        </div>
                    </div>
                `;
                
                if (hasAccess) {
                    poolCard.onclick = () => openPool(pool);
                }
                
                poolsGrid.appendChild(poolCard);
            }
        }

        // Open a pool and show candidates
        async function openPool(pool) {
            currentPool = pool;
            document.getElementById('currentPoolName').textContent = pool.name;
            
            const { data: candidates, error } = await supabase
                .from('candidates')
                .select('*')
                .eq('pool_id', pool.id);
            
            console.log(`Loading candidates for ${pool.id}:`, candidates?.length, error);
            
            // Sort candidates by weighted completeness score
            allCandidates = (candidates || []).sort((a, b) => {
                const scoreA = calculateWeightedCompleteness(a);
                const scoreB = calculateWeightedCompleteness(b);
                
                // If one has a professional summary and the other doesn't, prioritize the one with summary
                const hasSummaryA = a["About You"] && a["About You"].length > 50;
                const hasSummaryB = b["About You"] && b["About You"].length > 50;
                
                if (hasSummaryA && !hasSummaryB) return -1;
                if (!hasSummaryA && hasSummaryB) return 1;
                
                // Otherwise sort by weighted score
                return scoreB - scoreA;
            });
            
            // Populate location filter
            populateLocationFilter(allCandidates);
            
            displayCandidates(allCandidates);
            updateCandidateCount(allCandidates.length);
            
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.getElementById('poolDetailView').classList.add('active');
        }

        // Display candidates in grid
        function displayCandidates(candidates) {
            const candidatesGrid = document.getElementById('candidatesGrid');
            
            if (!candidates || candidates.length === 0) {
                candidatesGrid.innerHTML = '<p style="text-align: center; color: var(--rough-gray);">No candidates match your criteria.</p>';
                updateCandidateCount(0);
                return;
            }
            
            updateCandidateCount(candidates.length);
            
            candidatesGrid.innerHTML = candidates.map(candidate => {
                const jobTitle = toTitleCase(candidate["Current Job Title"] || 
                               candidate["Job Title"] || 
                               candidate.Name || 
                               `Candidate #${candidate.ID}`);
                
                const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                const salary = formatSalaryExact(candidate["What are your salary expectations?"] || 
                                               candidate["Salary Expectations"]);
                const noticeRaw = candidate["Notice Period"];
                const notice = noticeRaw ? formatNoticePeriod(noticeRaw) : 'Unknown Notice Period';
                const activelyLooking = (candidate["Actively looking for work"] || '').toUpperCase() === 'YES';
                
                const about = candidate["About You"] || candidate.Summary || '';
                const summary = generateSummaryPreview(about);
                
                const skillsDisplay = formatSkillsDisplay(candidate["Your Skills"] || candidate.Skills || '');
                
                return `
                    <div class="candidate-card" onclick='openCandidate(${JSON.stringify(candidate).replace(/'/g, "&apos;")})'>
                        ${activelyLooking ? `
                            <div style="position: absolute; top: 1rem; right: 1rem; 
                                       background: linear-gradient(135deg, var(--masters-green), var(--putting-green)); 
                                       color: white; padding: 0.25rem 0.75rem; 
                                       border-radius: 20px; font-size: 0.75rem; 
                                       font-weight: 600; text-transform: uppercase;">
                                Actively Looking
                            </div>
                        ` : ''}
                        
                        <h3 style="color: var(--augusta-green); margin-bottom: 0.5rem; ${activelyLooking ? 'padding-right: 120px;' : ''}">
                            ${jobTitle}
                        </h3>
                        <p style="color: var(--rough-gray); font-size: 0.9rem; margin-bottom: 1rem;">
                            ${location}
                        </p>
                        ${summary ? `<p style="margin-bottom: 1rem; font-size: 0.95rem; color: var(--pro-shop-navy);">${summary}</p>` : ''}
                        ${skillsDisplay ? `<div style="margin-bottom: 1rem;">${skillsDisplay}</div>` : ''}
                        <div style="display: flex; justify-content: space-between; align-items: center; 
                                    padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                            <span style="color: var(--rough-gray); font-size: 0.9rem;">
                                ${salary} • ${notice}
                            </span>
                            <span style="color: var(--masters-green); font-weight: 600;">View →</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update candidate count display
        function updateCandidateCount(count) {
            const countElement = document.getElementById('candidateCount');
            if (countElement) {
                countElement.textContent = count > 0 ? `Showing ${count} candidate${count !== 1 ? 's' : ''}` : '';
            }
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const salaryFilter = document.getElementById('salaryFilter').value;
            const noticeFilter = document.getElementById('noticeFilter').value;
            const lookingFilter = document.getElementById('lookingFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            let filtered = [...allCandidates];
            
            if (searchTerm) {
                filtered = filtered.filter(c => 
                    (c.Name || '').toLowerCase().includes(searchTerm) ||
                    (c["Current Job Title"] || '').toLowerCase().includes(searchTerm) ||
                    (c["Town/City"] || '').toLowerCase().includes(searchTerm) ||
                    (c["Your Skills"] || '').toLowerCase().includes(searchTerm) ||
                    (c["About You"] || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (salaryFilter) {
                filtered = filtered.filter(c => {
                    const salary = parseFloat(c["What are your salary expectations?"]) || 0;
                    if (salaryFilter === '70000+') return salary >= 70000;
                    const [min, max] = salaryFilter.split('-').map(Number);
                    return salary >= min && salary <= max;
                });
            }
            
            if (noticeFilter) {
                filtered = filtered.filter(c => {
                    const notice = (c["Notice Period"] || '').toLowerCase();
                    return notice.includes(noticeFilter.toLowerCase());
                });
            }
            
            if (lookingFilter) {
                filtered = filtered.filter(c => 
                    (c["Actively looking for work"] || '').toUpperCase() === lookingFilter
                );
            }
            
            if (categoryFilter) {
                filtered = filtered.filter(c => {
                    const jobTitle = c["Current Job Title"] || c["Job Title"] || '';
                    return detectJobCategory(jobTitle) === categoryFilter;
                });
            }
            
            if (selectedLocations.size > 0) {
                filtered = filtered.filter(c => {
                    const location = cleanAndFormatLocation(c["Town/City"], c.Country);
                    return selectedLocations.has(location);
                });
            }
            
            displayCandidates(filtered);
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('salaryFilter').value = '';
            document.getElementById('noticeFilter').value = '';
            document.getElementById('lookingFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            clearAllLocations();
            displayCandidates(allCandidates);
        }

        // Search functionality (live search)
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    applyFilters();
                });
            }
        });

        // Open candidate modal
        function openCandidate(candidate) {
            currentCandidate = candidate;
            
            const jobTitle = toTitleCase(candidate["Current Job Title"] || 
                           candidate["Job Title"] || 
                           candidate.Name || 
                           `Candidate #${candidate.ID}`);
            
            const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
            const aboutRaw = candidate["About You"] || candidate.Summary || 'No summary provided';
            
            // Format the about section with line breaks
            const about = aboutRaw.replace(/\. /g, '.\n\n');
            
            const skillsString = candidate["Your Skills"] || candidate.Skills || '';
            let skillsHtml = '';
            
            if (skillsString) {
                if (skillsString.includes('•') || skillsString.includes('–')) {
                    const bulletPoints = skillsString.split(/[•–-]/).map(s => s.trim()).filter(s => s && s.length > 3);
                    skillsHtml = `
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Skills & Expertise</h3>
                            <ul style="margin-left: 1.5rem; line-height: 1.8;">
                                ${bulletPoints.map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                } else if (skillsString.length > 150 && !skillsString.includes(',')) {
                    skillsHtml = `
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Skills & Expertise</h3>
                            <p style="line-height: 1.6;">${skillsString}</p>
                        </div>
                    `;
                } else if (skillsString.includes(',')) {
                    const skills = skillsString.split(',').map(s => s.trim()).filter(s => s);
                    if (skills.length > 0) {
                        skillsHtml = `
                            <div style="margin-bottom: 2rem;">
                                <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Skills & Expertise</h3>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    ${skills.map(skill => 
                                        `<span style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); 
                                               color: var(--augusta-green); padding: 0.5rem 1rem; 
                                               border-radius: 20px; font-weight: 600; 
                                               border: 1px solid var(--putting-green);">
                                            ${skill}
                                        </span>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                    }
                } else if (skillsString) {
                    skillsHtml = `
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Skills & Expertise</h3>
                            <p style="line-height: 1.6;">${skillsString}</p>
                        </div>
                    `;
                }
            }
            
            const noticeRaw = candidate["Notice Period"];
            const notice = noticeRaw ? formatNoticePeriod(noticeRaw) : 'Unknown Notice Period';
            const salary = formatSalaryExact(candidate["What are your salary expectations?"] || 
                                           candidate["Salary Expectations"]);
            const activelyLooking = candidate["Actively looking for work"] || 'Not specified';
            
            document.getElementById('modalTitle').textContent = jobTitle;
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Professional Summary</h3>
                    <p style="line-height: 1.6; white-space: pre-wrap;">${about}</p>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Key Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                                Location
                            </div>
                            <div style="font-weight: 600;">${location}</div>
                        </div>
                        <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                                Salary Expectations
                            </div>
                            <div style="font-weight: 600;">${salary}</div>
                        </div>
                        <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                                Notice Period
                            </div>
                            <div style="font-weight: 600;">${notice}</div>
                        </div>
                        <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                                Actively Looking
                            </div>
                            <div style="font-weight: 600;">${activelyLooking}</div>
                        </div>
                    </div>
                </div>
                
                ${skillsHtml}
                
                <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; padding: 1rem; margin-top: 2rem;">
                    <p style="color: var(--hazard-red); font-weight: 600; text-align: center;">
                        Full contact details (Email, Phone, LinkedIn, GitHub) available upon request (1 credit)
                    </p>
                </div>
            `;
            
            document.getElementById('candidateModal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('candidateModal').classList.remove('active');
        }

        // Add to shortlist
        async function addToShortlist() {
            if (!currentCandidate) return;
            
            const { error } = await supabase
                .from('shortlists')
                .insert({
                    user_id: currentUser.id,
                    candidate_id: currentCandidate.ID,
                    saved_from_pool: currentPool.id
                });
            
            if (error) {
                alert('Already in shortlist or error occurred');
            } else {
                alert('Added to shortlist!');
                closeModal();
                
                const { data: shortlistData } = await supabase
                    .from('shortlists')
                    .select('*, candidates(*)')
                    .eq('user_id', currentUser.id);
                
                shortlist = shortlistData || [];
                updateShortlistBadge();
            }
        }

        // Request contact details
        async function requestContact() {
            if (!currentCandidate) return;
            
            if (userProfile.credits < 1) {
                alert('Insufficient credits! Contact talent@golf-jobs.com to purchase more.');
                return;
            }
            
            const { error: profileError } = await supabase
                .from('users')
                .update({ credits: userProfile.credits - 1 })
                .eq('id', currentUser.id);
            
            const { error: requestError } = await supabase
                .from('requests')
                .insert({
                    user_id: currentUser.id,
                    candidate_id: currentCandidate.ID,
                    credits_used: 1
                });
            
            if (!profileError && !requestError) {
                userProfile.credits--;
                document.getElementById('creditsCount').textContent = userProfile.credits;
                
                const currentModalBody = document.getElementById('modalBody').innerHTML;
                const detailsHtml = `
                    <div style="margin-top: 1rem; padding: 1rem; background: #d4edda; border-radius: 8px;">
                        <h4 style="color: var(--augusta-green); margin-bottom: 0.5rem;">Contact Details Revealed:</h4>
                        <p><strong>Email:</strong> ${currentCandidate.Email || 'Not provided'}</p>
                        <p><strong>LinkedIn:</strong> ${currentCandidate.LinkedIn || 'Not provided'}</p>
                        <p><strong>GitHub:</strong> ${currentCandidate.GitHub || 'Not provided'}</p>
                    </div>
                `;
                
                document.getElementById('modalBody').innerHTML = currentModalBody.replace(
                    /<div style="background: #fef2f2;.*?<\/div>/s,
                    detailsHtml
                );
                
                alert('Contact details revealed! 1 credit used.');
            }
        }

        // Other view functions
        async function loadShortlist() {
            const content = document.getElementById('shortlistContent');
            
            if (!shortlist || shortlist.length === 0) {
                content.innerHTML = `
                    <div class="section-box" style="text-align: center;">
                        <h2>No candidates saved yet</h2>
                        <p style="color: var(--rough-gray); margin-bottom: 1rem;">Browse talent pools and save candidates you're interested in.</p>
                        <button class="btn btn-primary" onclick="switchView('pools')">Browse Talent Pools</button>
                    </div>
                `;
            } else {
                content.innerHTML = '<div class="candidates-grid" id="shortlistGrid"></div>';
                const grid = document.getElementById('shortlistGrid');
                
                grid.innerHTML = shortlist.map(item => {
                    const candidate = item.candidates;
                    if (!candidate) return '';
                    
                    const jobTitle = toTitleCase(candidate["Current Job Title"] || 
                                   candidate["Job Title"] || 
                                   candidate.Name || 
                                   `Candidate #${candidate.ID}`);
                    const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                    
                    return `
                        <div class="candidate-card" style="position: relative;">
                            <button onclick="removeFromShortlist(${item.id})" 
                                    style="position: absolute; top: 1rem; right: 1rem; 
                                           background: #fee; color: var(--hazard-red); 
                                           border: none; padding: 0.5rem 1rem; 
                                           border-radius: 8px; cursor: pointer; z-index: 10;">
                                Remove
                            </button>
                            <div onclick='openCandidate(${JSON.stringify(candidate).replace(/'/g, "&apos;")})'> 
                                <h3 style="color: var(--augusta-green);">${jobTitle}</h3>
                                <p style="color: var(--rough-gray);">${location}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        async function removeFromShortlist(shortlistId) {
            if (!confirm('Remove this candidate from your shortlist?')) return;
            
            const { error } = await supabase
                .from('shortlists')
                .delete()
                .eq('id', shortlistId);
            
            if (!error) {
                const { data: shortlistData } = await supabase
                    .from('shortlists')
                    .select('*, candidates(*)')
                    .eq('user_id', currentUser.id);
                
                shortlist = shortlistData || [];
                updateShortlistBadge();
                loadShortlist();
            }
        }

        function updateShortlistBadge() {
            const badge = document.getElementById('shortlistBadge');
            if (shortlist.length > 0) {
                badge.style.display = 'inline';
                badge.textContent = shortlist.length;
            } else {
                badge.style.display = 'none';
            }
        }

        function loadAccount() {
            document.getElementById('accountName').textContent = userProfile?.name || '-';
            document.getElementById('accountEmail').textContent = currentUser?.email || '-';
            document.getElementById('accountCredits').textContent = userProfile?.credits || 0;
            
            supabase
                .from('requests')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', currentUser.id)
                .then(({ count }) => {
                    document.getElementById('totalRequests').textContent = count || 0;
                });
        }

        async function loadRequests() {
            const { data: requests } = await supabase
                .from('requests')
                .select('*, candidates(*)')
                .eq('user_id', currentUser.id)
                .order('request_date', { ascending: false });
            
            const content = document.getElementById('requestsList');
            
            if (!requests || requests.length === 0) {
                content.innerHTML = '<p style="text-align: center; color: var(--rough-gray);">No requests made yet.</p>';
            } else {
                content.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb;">
                                <th style="padding: 1rem; text-align: left;">Date</th>
                                <th style="padding: 1rem; text-align: left;">Candidate</th>
                                <th style="padding: 1rem; text-align: left;">Credits Used</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requests.map(req => {
                                const jobTitle = req.candidates ? toTitleCase(req.candidates["Current Job Title"] || 
                                               req.candidates.Name || 
                                               `Candidate #${req.candidate_id}`) : `Candidate #${req.candidate_id}`;
                                return `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 1rem;">${new Date(req.request_date).toLocaleDateString()}</td>
                                        <td style="padding: 1rem;">${jobTitle}</td>
                                        <td style="padding: 1rem;">${req.credits_used || 1}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }
        }

        async function loadAdmin() {
            const { data: allUsers } = await supabase
                .from('users')
                .select('*')
                .order('created_at', { ascending: false });
            
            const usersList = document.getElementById('adminUsersList');
            if (allUsers && allUsers.length > 0) {
                usersList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb;">
                                <th style="padding: 1rem; text-align: left;">Name</th>
                                <th style="padding: 1rem; text-align: left;">Email</th>
                                <th style="padding: 1rem; text-align: left;">Role</th>
                                <th style="padding: 1rem; text-align: left;">Credits</th>
                                <th style="padding: 1rem; text-align: left;">Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allUsers.map(user => `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 1rem;">${user.name || 'Not set'}</td>
                                    <td style="padding: 1rem;">${user.email}</td>
                                    <td style="padding: 1rem;">${user.role || 'viewer'}</td>
                                    <td style="padding: 1rem;">${user.credits || 0}</td>
                                    <td style="padding: 1rem;">${new Date(user.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                usersList.innerHTML = '<p style="text-align: center; color: var(--rough-gray);">No users found.</p>';
            }
            
            const { data: allRequests } = await supabase
                .from('requests')
                .select('*, users(name, email), candidates(*)')
                .order('request_date', { ascending: false })
                .limit(50);
            
            const requestsList = document.getElementById('adminRequestsList');
            if (allRequests && allRequests.length > 0) {
                requestsList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb;">
                                <th style="padding: 1rem; text-align: left;">Date</th>
                                <th style="padding: 1rem; text-align: left;">User</th>
                                <th style="padding: 1rem; text-align: left;">Candidate</th>
                                <th style="padding: 1rem; text-align: left;">Credits</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allRequests.map(req => {
                                const jobTitle = req.candidates ? toTitleCase(req.candidates["Current Job Title"] || 
                                               req.candidates.Name || 
                                               `Candidate #${req.candidate_id}`) : `Candidate #${req.candidate_id}`;
                                return `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 1rem;">${new Date(req.request_date).toLocaleDateString()}</td>
                                        <td style="padding: 1rem;">${req.users?.name || req.users?.email || 'Unknown'}</td>
                                        <td style="padding: 1rem;">${jobTitle}</td>
                                        <td style="padding: 1rem;">${req.credits_used || 1}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                requestsList.innerHTML = '<p style="text-align: center; color: var(--rough-gray);">No requests found.</p>';
            }
        }

        function goHome() {
            switchView('pools');
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });

        document.getElementById('candidateModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>
</body>
</html>
