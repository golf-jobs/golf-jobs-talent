<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Golf Jobs – Talent Pools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --augusta-green:#3a7858;
      --masters-green:#2e6f4e;
      --pro-shop-navy:#0f172a;
      --club-gold:#d4af37;
      --morning-mist:#f3f6f4;
      --rough-gray:#6b7280;
      --hazard-red:#b91c1c;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#e9ecef 100%)}
    .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}
    .login-box{background:#fff;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:2rem;max-width:420px;width:100%}
    .login-title{font-size:1.75rem;color:var(--augusta-green);margin:0 0 .25rem}
    .login-subtitle{color:var(--rough-gray);margin-bottom:1.5rem}
    .form-group{margin-bottom:1rem}
    .form-label{font-weight:600;color:var(--pro-shop-navy);display:block;margin-bottom:.4rem}
    .form-input{width:100%;padding:.8rem 1rem;border:1px solid #e5e7eb;border-radius:12px;background:#f9fafb}
    .btn-login{width:100%;padding:.9rem 1rem;border-radius:12px;background:var(--augusta-green);color:#fff;border:none;font-weight:700;cursor:pointer}
    .login-error{display:none;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;padding:.75rem 1rem;border-radius:10px;margin-bottom:1rem}
    .main-app{display:none}
    .main-app.active{display:block}
    header.header{background:var(--pro-shop-navy);color:#fff;padding:1rem 0}
    .header-content{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:0 1rem}
    .logo img{height:34px;cursor:pointer}
    .nav-tabs{display:flex;gap:.5rem;flex-wrap:wrap}
    .nav-tab{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:999px;padding:.5rem .9rem;cursor:pointer}
    .nav-tab.active{background:#fff;color:var(--pro-shop-navy);font-weight:700}
    .user-info{display:flex;align-items:center;gap:.75rem}
    .credits-badge{background:#fff;color:var(--pro-shop-navy);padding:.25rem .6rem;border-radius:999px;font-weight:700}
    .btn-logout{background:#fff;color:var(--pro-shop-navy);border:none;border-radius:10px;padding:.5rem .8rem;cursor:pointer}
    .container{max-width:1200px;margin:2rem auto;padding:0 1rem}
    .section-box{background:#fff;border-radius:16px;padding:2rem;box-shadow:0 4px 20px rgba(0,0,0,.08);margin-bottom:2rem}
    .pools-grid,.candidates-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
    .pool-card,.candidate-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:1.2rem;cursor:pointer}
    .skeleton{background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:shimmer 1.25s infinite}
    .skeleton-card{height:120px;border-radius:16px}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
    .view-section{display:none}
    .view-section.active{display:block}
    .shortlist-badge{margin-left:.35rem;background:#fff;color:var(--pro-shop-navy);padding:.1rem .45rem;border-radius:999px;font-size:.8rem}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-start;justify-content:center;padding:2rem;z-index:20}
    .modal.active{display:flex}
    .modal-content{background:#fff;border-radius:16px;max-width:900px;width:100%;padding:1.5rem;position:relative}
    .modal-close{position:absolute;top:.75rem;right:.75rem;background:#eee;border:none;border-radius:999px;width:34px;height:34px;font-size:20px;cursor:pointer}
    .note-textarea{width:100%;min-height:90px;border:1px solid #e5e7eb;border-radius:12px;padding:.75rem}
    .btn{border:none;border-radius:10px;padding:.7rem 1rem;cursor:pointer}
    .btn-primary{background:var(--augusta-green);color:#fff}
    .btn-secondary{background:#f3f6f4}
    .btn-secondary:hover{background:var(--augusta-green);color:#fff}
    .btn-small{padding:.5rem 1rem;font-size:.875rem}
    .dialog-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);display:none;z-index:30}
    .dialog-overlay.active{display:block}
    .confirmation-dialog{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border-radius:16px;max-width:540px;width:90%;padding:1.25rem;box-shadow:0 10px 30px rgba(0,0,0,.16);display:none;z-index:31}
    .confirmation-dialog.active{display:block}
    .request-status{display:inline-block;padding:.25rem .75rem;border-radius:12px;font-size:.75rem;font-weight:700;text-transform:uppercase}
    .request-status.pending{background:#fff3cd;color:#856404}
    .request-status.completed{background:#d4edda;color:#155724}
    @media (max-width:768px){
      .pools-grid,.candidates-grid{grid-template-columns:1fr}
      .header-content{flex-direction:column;align-items:stretch}
      .modal-content{margin:10% 1rem;width:calc(100% - 2rem)}
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginScreen" class="login-container">
    <div class="login-box">
      <div style="text-align:center;margin-bottom:2rem;">
        <img src="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20black.png?updatedAt=1757017924442" alt="Golf Jobs" style="width:200px;">
      </div>
      <h1 class="login-title">Talent Pool Access</h1>
      <p class="login-subtitle">Exclusive recruitment platform</p>
      <div id="loginError" class="login-error">Invalid credentials. Please try again.</div>
      <form onsubmit="handleLogin(event)">
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input id="loginEmail" type="email" class="form-input" required placeholder="your@company.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input id="loginPassword" type="password" class="form-input" required placeholder="••••••••">
        </div>
        <button class="btn-login" type="submit">Sign In</button>
      </form>
      <div style="text-align:center;margin-top:2rem;padding-top:2rem;border-top:1px solid #e1e8e4;">
        <p style="color:var(--rough-gray);font-size:.85rem;">© 2025 Golf Jobs.</p>
        <p style="margin-top:.5rem;color:var(--rough-gray);font-size:.85rem;">Need access? Contact <strong>graham@golf-jobs.com</strong></p>
      </div>
    </div>
  </div>

  <!-- App -->
  <div id="mainApp" class="main-app">
    <header class="header">
      <div class="header-content">
        <div class="logo" onclick="goHome()">
          <img src="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20white.png?updatedAt=1758280288759" alt="Golf Jobs">
        </div>
        <nav class="nav-tabs">
          <button class="nav-tab active" onclick="switchView('pools')">Talent Pools</button>
          <button class="nav-tab" onclick="switchView('shortlist')">Shortlist <span id="shortlistBadge" class="shortlist-badge" style="display:none;">0</span></button>
          <button class="nav-tab" onclick="switchView('account')">My Account</button>
          <button class="nav-tab" onclick="switchView('requests')">My Requests</button>
          <button id="adminTab" class="nav-tab" onclick="switchView('admin')" style="display:none;">Admin</button>
        </nav>
        <div class="user-info">
          <span id="userName">Welcome</span>
          <div class="credits-badge">Credits: <span id="creditsCount">0</span></div>
          <button class="btn-logout" onclick="handleLogout()">Sign Out</button>
        </div>
      </div>
    </header>

    <div class="container">
      <!-- POOLS -->
      <div id="poolsView" class="view-section active">
        <h1 style="font-size:2.25rem;color:var(--augusta-green);margin-bottom:.5rem;">Your Talent Pools</h1>
        <p style="color:var(--rough-gray);margin-bottom:1.25rem;font-size:1.05rem;">Select a talent pool to browse candidates</p>
        <div id="poolsGrid" class="pools-grid">
          <div class="skeleton skeleton-card"></div>
          <div class="skeleton skeleton-card"></div>
          <div class="skeleton skeleton-card"></div>
        </div>
      </div>

      <!-- CANDIDATES (filled on pool click) -->
      <div id="poolDetail" class="view-section">
        <div class="section-box">
          <div id="poolHeader"></div>
          <div class="candidates-grid" id="candidatesGrid">
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
          </div>
          <div id="loadMoreContainer" class="load-more-container" style="display:none;margin-top:1rem;">
            <button class="btn btn-secondary" onclick="loadMore()">Load More Candidates</button>
          </div>
        </div>
      </div>

      <!-- SHORTLIST -->
      <div id="shortlistView" class="view-section">
        <h1 style="font-size:2.25rem;color:var(--augusta-green);margin-bottom:1rem;">Your Shortlist</h1>
        <div style="margin-bottom:1rem;">
          <button class="btn btn-primary" onclick="exportShortlist()">Export Shortlist</button>
        </div>
        <div id="shortlistContent"></div>
      </div>

      <!-- ACCOUNT -->
      <div id="accountView" class="view-section">
        <h1 style="font-size:2.25rem;color:var(--augusta-green);margin-bottom:1rem;">My Account</h1>
        <div class="section-box">
          <h2 style="color:var(--augusta-green);margin-bottom:.75rem;">Account Overview</h2>
          <p><strong>Name:</strong> <span id="accountName">-</span></p>
          <p><strong>Email:</strong> <span id="accountEmail">-</span></p>
          <p><strong>Credits Balance:</strong> <span id="accountCredits">0</span></p>
          <p><strong>Total Requests:</strong> <span id="totalRequests">0</span></p>
        </div>
        <div class="section-box">
          <h2 style="color:var(--augusta-green);margin-bottom:.75rem;">Credits History</h2>
          <div id="creditsHistory"></div>
        </div>
      </div>

      <!-- REQUESTS -->
      <div id="requestsView" class="view-section">
        <h1 style="font-size:2.25rem;color:var(--augusta-green);margin-bottom:1rem;">My Requests</h1>
        <div class="section-box">
          <p style="margin-bottom:1rem;color:var(--rough-gray);">
            Your contact requests are processed within 24 hours. Graham will contact candidates on your behalf and share introductions by email.
          </p>
          <div id="requestsList"></div>
        </div>
      </div>

      <!-- ADMIN -->
      <div id="adminView" class="view-section">
        <h1 style="font-size:2.25rem;color:var(--augusta-green);margin-bottom:1rem;">Admin Panel</h1>
        <div class="section-box">
          <h2 style="color:var(--augusta-green);margin-bottom:.75rem;">All Users</h2>
          <div id="adminUsersList"></div>
        </div>
        <div class="section-box">
          <h2 style="color:var(--augusta-green);margin-bottom:.75rem;">All Requests</h2>
          <div id="adminRequestsList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Candidate Modal -->
  <div id="candidateModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">×</button>
      <h2 id="modalTitle" style="color:var(--augusta-green);margin-bottom:.75rem;"></h2>
      <div id="modalBody"></div>
      <div class="section-box" style="padding:1rem;margin-top:1rem;">
        <h4 style="color:var(--augusta-green);margin:.25rem 0 .5rem;">📝 Private Notes</h4>
        <textarea id="candidateNotes" class="note-textarea" placeholder="Add your notes about this candidate."></textarea>
        <button class="btn btn-small btn-secondary" style="margin-top:.5rem" onclick="saveNotes()">Save Notes</button>
      </div>
      <div style="margin-top:1rem;display:flex;gap:.75rem;justify-content:flex-end;flex-wrap:wrap;">
        <button class="btn btn-secondary" onclick="addToShortlist()">Save to Shortlist</button>
        <button class="btn btn-primary" onclick="showCreditConfirmation()">Request Contact Details (1 Credit)</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Dialog -->
  <div id="dialogOverlay" class="dialog-overlay"></div>
  <div id="confirmationDialog" class="confirmation-dialog">
    <h3 style="color:var(--augusta-green);margin-bottom:.5rem;">Confirm Contact Request</h3>
    <p style="margin-bottom:1rem;">You are about to use <strong>1 credit</strong> to request contact for this candidate.</p>
    <div style="background:#f0f8f4;padding:1rem;border-radius:8px;margin-bottom:1rem;">
      <p style="font-size:.95rem;line-height:1.6;">
        <strong>What happens next:</strong><br>
        • Graham will personally contact the candidate<br>
        • You'll receive their full contact details via email<br>
        • A tailored introduction will be facilitated<br>
        • Response typically within 24 hours
      </p>
    </div>
    <p style="margin-bottom:1rem;">Current balance: <strong id="currentCredits">0</strong> credits</p>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;">
      <button class="btn btn-secondary" onclick="hideConfirmation()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmCreditUse()">Confirm Request</button>
    </div>
  </div>

  <script>
    // ===== Supabase =====
    const SUPABASE_URL = 'https://kbadedwbcjetxiertztv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtiYWRlZHdiY2pldHhpZXJ0enR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDAyNDMsImV4cCI6MjA3Mzg3NjI0M30.igm3XjM8l1OXfilQaAHtmJyCDe9eXILV_P9B3_sUzwg';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== State =====
    let currentUser = null;
    let userProfile = null;
    let userPools = [];
    let shortlist = [];
    let currentPool = null;
    let allCandidates = [];
    let displayedCandidates = [];
    let filteredCandidates = [];
    let currentCandidate = null;
    let selectedLocations = new Set();
    let availableLocations = new Set();
    let candidateNotes = {};
    let searchTimeout = null;
    let currentPage = 0;
    const candidatesPerPage = 20;

    // ===== Auth / Login =====
    async function handleLogin(e){
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error){
        document.getElementById('loginError').style.display = 'block';
        setTimeout(()=>document.getElementById('loginError').style.display='none', 2500);
        return;
      }
      await loadUserData(data.user);
      showApp();
    }

    async function loadUserData(user){
      currentUser = user;
      const { data: profile } = await supabase.from('users').select('*').eq('id', user.id).single();
      if (profile){
        userProfile = profile;
        document.getElementById('userName').textContent = profile.name || user.email;
        document.getElementById('creditsCount').textContent = profile.credits || 0;
        if (profile.role === 'admin'){ document.getElementById('adminTab').style.display = 'block'; }
      }

      const { data: access } = await supabase.from('user_pool_access').select('pool_id').eq('user_id', user.id);
      userPools = access ? access.map(p=>p.pool_id) : [];

      const { data: shortlistData } = await supabase.from('shortlists').select('*, candidates(*)').eq('user_id', user.id);
      shortlist = shortlistData || [];
      updateShortlistBadge();

      const savedNotes = localStorage.getItem('candidateNotes_' + user.id);
      if (savedNotes){ candidateNotes = JSON.parse(savedNotes); }
    }

    function showApp(){
      document.getElementById('loginScreen').style.display='none';
      document.getElementById('mainApp').classList.add('active');
      loadPools();
    }

    async function handleLogout(){
      await supabase.auth.signOut();
      location.reload();
    }

    // ===== Navigation =====
    function switchView(view){
      document.querySelectorAll('.view-section').forEach(s=>s.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(view+'View')?.classList.add('active');
      if (event && event.target) event.target.classList.add('active');

      if (view==='pools') loadPools();
      else if (view==='shortlist') loadShortlist();
      else if (view==='account') loadAccount();
      else if (view==='requests') loadRequests();
      else if (view==='admin' && userProfile?.role==='admin') loadAdmin();

      const url = new URL(window.location);
      url.searchParams.set('view', view);
      history.pushState({}, '', url);
    }
    function goHome(){ switchView('pools'); }

    // ===== Pools / Candidates =====
    async function loadPools(){
      const grid = document.getElementById('poolsGrid');
      grid.innerHTML = `<div class="skeleton skeleton-card"></div><div class="skeleton skeleton-card"></div><div class="skeleton skeleton-card"></div>`;

      const { data: pools } = await supabase.from('talent_pools').select('*');
      const myPools = (pools||[]).filter(p => userPools.includes(p.id));
      grid.innerHTML = myPools.length ? myPools.map(p=>`
        <div class="pool-card" onclick='openPool(${JSON.stringify(p)})'>
          <h3 style="color:var(--augusta-green);margin:.25rem 0;">${p.name}</h3>
          <p style="color:var(--rough-gray);margin:.25rem 0;">${p.description||''}</p>
        </div>`).join('') : `<div class="section-box">You have no pools assigned yet.</div>`;
    }

    async function openPool(pool){
      currentPool = pool;
      document.getElementById('poolsView').classList.remove('active');
      document.getElementById('poolDetail').classList.add('active');
      document.getElementById('poolHeader').innerHTML = `
        <div class="breadcrumb"><a href="#" onclick="switchView('pools')">Talent Pools</a> › <span>${pool.name}</span></div>
        <h2 style="color:var(--augusta-green);margin:.25rem 0 1rem;">${pool.name}</h2>
      `;
      currentPage = 0; allCandidates = []; displayedCandidates = [];
      await loadCandidatesPage();
    }

    async function loadCandidatesPage(){
      const { data: candidates } = await supabase
        .from('candidates')
        .select('*')
        .eq('pool_id', currentPool.id)
        .range(currentPage*candidatesPerPage, (currentPage+1)*candidatesPerPage-1);

      const grid = document.getElementById('candidatesGrid');
      if (candidates && candidates.length){
        allCandidates = allCandidates.concat(candidates);
        displayedCandidates = displayedCandidates.concat(candidates);
        grid.innerHTML = displayedCandidates.map(renderCandidateCard).join('');
        currentPage++;
        document.getElementById('loadMoreContainer').style.display = candidates.length === candidatesPerPage ? 'block' : 'none';
      } else {
        if (currentPage===0){ grid.innerHTML = `<div class="section-box">No candidates in this pool yet.</div>`; }
        document.getElementById('loadMoreContainer').style.display = 'none';
      }
    }
    function loadMore(){ loadCandidatesPage(); }

    function renderCandidateCard(c){
      const jobTitle = toTitleCase(c["Current Job Title"] || c["Job Title"] || c.Name || `Candidate #${c.ID}`);
      const location = cleanAndFormatLocation(c["Town/City"], c.Country);
      return `
        <div class="candidate-card" onclick='openCandidate(${JSON.stringify(c).replace(/'/g,"&apos;")})'>
          <h3 style="color:var(--augusta-green);margin:.2rem 0;">${jobTitle}</h3>
          <p style="color:var(--rough-gray);margin:.2rem 0;">${location}</p>
        </div>`;
    }

    function openCandidate(candidate){
      currentCandidate = candidate;
      const title = toTitleCase(candidate["Current Job Title"] || candidate["Job Title"] || candidate.Name || `Candidate #${candidate.ID}`);
      const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
      const summary = candidate.Summary || 'No summary provided.';
      const salary = candidate["Salary Expectations"] || '—';
      const notice = candidate["Notice Period"] || '—';
      const activelyLooking = candidate["Actively Looking?"] || '—';
      const skills = candidate.Skills ? `<div style="margin-top:1rem;"><strong>Skills:</strong> ${candidate.Skills}</div>` : '';

      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').innerHTML = `
        <p style="color:var(--rough-gray);">${location}</p>
        <div style="margin-top:.75rem;line-height:1.6">${summary}</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-top:1rem;">
          <div style="background:var(--morning-mist);padding:1rem;border-radius:10px;"><div style="font-size:.8rem;color:var(--rough-gray);text-transform:uppercase;margin-bottom:.25rem;">Salary Expectations</div><div style="font-weight:600">${salary}</div></div>
          <div style="background:var(--morning-mist);padding:1rem;border-radius:10px;"><div style="font-size:.8rem;color:var(--rough-gray);text-transform:uppercase;margin-bottom:.25rem;">Notice Period</div><div style="font-weight:600">${notice}</div></div>
          <div style="background:var(--morning-mist);padding:1rem;border-radius:10px;"><div style="font-size:.8rem;color:var(--rough-gray);text-transform:uppercase;margin-bottom:.25rem;">Actively Looking</div><div style="font-weight:600">${activelyLooking}</div></div>
        </div>
        ${skills}
        <div style="background:#e6f2ff;border:1px solid var(--augusta-green);border-radius:12px;padding:1rem;margin-top:1rem;">
          <p style="color:var(--augusta-green);font-weight:600;">💼 To connect with this candidate, request their contact details and Graham will facilitate a personalized introduction.</p>
        </div>
      `;
      const notes = candidateNotes[candidate.ID] || '';
      document.getElementById('candidateNotes').value = notes;
      document.getElementById('candidateModal').classList.add('active');
    }

    // ===== Utilities =====
    function toTitleCase(str){ return (str||'').toString().toLowerCase().replace(/(^|[\s\-_/])([a-z])/g, s=>s.toUpperCase()); }
    function cleanAndFormatLocation(city, country){
      const c = (city||'').toString().trim();
      const k = (country||'').toString().trim();
      return [c,k].filter(Boolean).join(', ') || 'Location not specified';
    }

    // ===== Notes / Shortlist =====
    function saveNotes(){
      if (!currentCandidate) return;
      const notes = document.getElementById('candidateNotes').value;
      candidateNotes[currentCandidate.ID] = notes;
      localStorage.setItem('candidateNotes_' + currentUser.id, JSON.stringify(candidateNotes));
      alert('Notes saved!');
    }
    function closeModal(){ document.getElementById('candidateModal').classList.remove('active'); }
    function updateShortlistBadge(){
      const b = document.getElementById('shortlistBadge');
      if (shortlist.length > 0){ b.style.display='inline'; b.textContent = shortlist.length; }
      else { b.style.display='none'; }
    }

    async function addToShortlist(){
      if (!currentCandidate) return;
      try{
        const { count } = await supabase.from('shortlists').select('*', { count:'exact', head:true })
          .eq('user_id', currentUser.id).eq('candidate_id', currentCandidate.ID);
        if ((count||0) > 0){ alert('This candidate is already in your shortlist'); return; }

        const { data, error } = await supabase.from('shortlists').insert({
          user_id: currentUser.id, candidate_id: currentCandidate.ID, saved_from_pool: currentPool?.id
        }).select();
        if (error) throw error;

        closeModal();
        const { data: s2 } = await supabase.from('shortlists').select('*, candidates(*)').eq('user_id', currentUser.id);
        shortlist = s2 || []; updateShortlistBadge();
        alert('Added to shortlist!');
      }catch(err){
        console.error('Shortlist error', err);
        alert('Error adding to shortlist. Please try again.');
      }
    }

    async function loadShortlist(){
      const content = document.getElementById('shortlistContent');
      if (!shortlist || shortlist.length===0){
        content.innerHTML = `
          <div class="section-box" style="text-align:center;">
            <h2>No candidates saved yet</h2>
            <p style="color:var(--rough-gray);margin-bottom:1rem;">Browse talent pools and save candidates you're interested in.</p>
            <button class="btn btn-primary" onclick="switchView('pools')">Browse Talent Pools</button>
          </div>`;
        return;
      }
      content.innerHTML = '<div class="candidates-grid" id="shortlistGrid"></div>';
      const grid = document.getElementById('shortlistGrid');
      grid.innerHTML = shortlist.map(item=>{
        const c = item.candidates; if (!c) return '';
        const jobTitle = toTitleCase(c["Current Job Title"]||c["Job Title"]||c.Name||`Candidate #${c.ID}`);
        const loc = cleanAndFormatLocation(c["Town/City"], c.Country);
        const notes = candidateNotes[c.ID] || '';
        return `
          <div class="candidate-card" style="position:relative;">
            <button onclick="removeFromShortlist(${item.id})" style="position:absolute;top:1rem;right:1rem;background:#fee;color:var(--hazard-red);border:none;padding:.4rem .7rem;border-radius:8px;cursor:pointer;z-index:1;">Remove</button>
            <div onclick='openCandidate(${JSON.stringify(c).replace(/'/g,"&apos;")})'>
              <h3 style="color:var(--augusta-green);margin:.2rem 0;">${jobTitle}</h3>
              <p style="color:var(--rough-gray);margin:.2rem 0;">${loc}</p>
              ${notes ? `<p style="margin-top:.3rem;font-size:.9rem;color:var(--club-gold);">📝 ${notes.substring(0,60)}...</p>`:''}
            </div>
          </div>`;
      }).join('');
    }
    async function removeFromShortlist(id){
      await supabase.from('shortlists').delete().eq('id', id);
      const { data: s2 } = await supabase.from('shortlists').select('*, candidates(*)').eq('user_id', currentUser.id);
      shortlist = s2 || []; updateShortlistBadge(); loadShortlist();
    }
    function exportShortlist(){
      const rows = shortlist.map(i=>{
        const c = i.candidates||{};
        return {
          id:c.ID, name:c.Name||'', job_title:c["Current Job Title"]||c["Job Title"]||'',
          city:(c["Town/City"]||''), country:(c.Country||''), summary:(c.Summary||'')
        }
      });
      const csv = 'ID,Name,Job Title,City,Country,Summary\n' + rows.map(r=>
        [r.id,r.name,r.job_title,r.city,r.country,('"'+(r.summary.replace(/"/g,'""')||'')+'"')].join(',')
      ).join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='shortlist.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // ===== Credit Confirmation & Request Contact (no auto-reveal) =====
    function showCreditConfirmation(){
      document.getElementById('currentCredits').textContent = userProfile.credits || 0;
      document.getElementById('confirmationDialog').classList.add('active');
      document.getElementById('dialogOverlay').classList.add('active');
    }
    function hideConfirmation(){
      document.getElementById('confirmationDialog').classList.remove('active');
      document.getElementById('dialogOverlay').classList.remove('active');
    }
    async function confirmCreditUse(){
      hideConfirmation();
      await requestContact();
    }

    async function requestContact(){
      if (!currentCandidate) return;
      if ((userProfile.credits||0) < 1){
        alert('Insufficient credits! Contact graham@golf-jobs.com to purchase more.');
        return;
      }
      try{
        // Deduct credit
        const newBalance = (userProfile.credits||0) - 1;
        const { error: profileError } = await supabase.from('users').update({ credits: newBalance }).eq('id', currentUser.id);
        if (profileError){ throw profileError; }

        // Insert request with status
        const payload = {
          user_id: currentUser.id,
          candidate_id: currentCandidate.ID,
          credits_used: 1,
          request_date: new Date().toISOString(),
          status: 'pending'
        };
        const { data: requestData, error: requestError } = await supabase.from('requests').insert(payload).select();
        if (requestError){ 
          // rollback
          await supabase.from('users').update({ credits: userProfile.credits }).eq('id', currentUser.id);
          throw requestError;
        }

        // Update local credits
        userProfile.credits = newBalance;
        document.getElementById('creditsCount').textContent = newBalance;

        // Success message inside modal (do NOT reveal details)
        const currentModalBody = document.getElementById('modalBody').innerHTML;
        const successHtml = `
          <div style="margin-top:1rem;padding:1rem;border-radius:12px;border:2px solid var(--augusta-green);background:#d4edda;">
            <h4 style="color:var(--augusta-green);margin:.25rem 0 .5rem;">✅ Contact Request Submitted!</h4>
            <p><strong>What happens next:</strong></p>
            <ul style="margin-left:1.25rem;line-height:1.6;">
              <li>Graham has been notified of your request</li>
              <li>He will contact the candidate</li>
              <li>You'll receive full contact details by email</li>
              <li>A tailored introduction will be facilitated</li>
            </ul>
            <p style="margin-top:.5rem;font-size:.9rem;color:#155724;"><strong>Reference ID:</strong> #${requestData[0].id}</p>
          </div>`;
        document.getElementById('modalBody').innerHTML = currentModalBody.replace(/<div style="background: #e6f2ff;[\s\S]*?<\/div>/, successHtml);
        alert('Contact request submitted successfully!');

        // Try to email Graham (Edge Function -> fallback to email_queue)
        const emailSubject = `New Contact Request #${requestData[0].id}`;
        const candidateName = currentCandidate["Current Job Title"] || currentCandidate.Name || `Candidate #${currentCandidate.ID}`;
        const location = cleanAndFormatLocation(currentCandidate["Town/City"], currentCandidate.Country);
        const emailBody = `
New contact request submitted.

Request ID: ${requestData[0].id}
Candidate: ${candidateName} (ID: ${currentCandidate.ID})
Location: ${location}

Requested by: ${userProfile.name || currentUser.email}
User ID: ${currentUser.id}

Please contact the candidate and then reply to the client with details.
        `.trim();

        // Edge Function attempt (optional — create 'send_email' in Supabase if desired)
        try{
          const { data: fnRes, error: fnErr } = await supabase.functions.invoke('send_email', {
            body: { to: 'graham@golf-jobs.com', subject: emailSubject, text: emailBody }
          });
          if (fnErr) throw fnErr;
        }catch(_){
          // Fallback table insert (create table email_queue(to,subject,body,meta,status,created_at))
          try{
            await supabase.from('email_queue').insert({
              to: 'graham@golf-jobs.com',
              subject: emailSubject,
              body: emailBody,
              meta: { user_id: currentUser.id, request_id: requestData[0].id, candidate_id: currentCandidate.ID }
            });
          }catch(errQueue){
            console.warn('Email not queued; please wire email method.', errQueue);
          }
        }

        // Refresh lists
        loadRequests();
        if (userProfile.role==='admin'){ loadAdmin(); }

      }catch(err){
        console.error('requestContact error', err);
        alert('There was a problem processing your request. If credits were deducted, they have been refunded.');
      }
    }

    // ===== Account / Requests / Admin =====
    async function loadAccount(){
      document.getElementById('accountName').textContent = userProfile?.name || '-';
      document.getElementById('accountEmail').textContent = currentUser?.email || '-';
      document.getElementById('accountCredits').textContent = userProfile?.credits || 0;

      const { count } = await supabase.from('requests').select('*', { count:'exact', head:true }).eq('user_id', currentUser.id);
      document.getElementById('totalRequests').textContent = count || 0;

      const { data: requests } = await supabase.from('requests').select('*, candidates(*)')
        .eq('user_id', currentUser.id).order('request_date', { ascending:false }).limit(10);

      const historyDiv = document.getElementById('creditsHistory');
      if (requests && requests.length){
        historyDiv.innerHTML = `
          <table style="width:100%;border-collapse:collapse;">
            <thead><tr style="background:#f9fafb;">
              <th style="padding:.5rem;text-align:left;">Date</th>
              <th style="padding:.5rem;text-align:left;">Candidate</th>
              <th style="padding:.5rem;text-align:left;">Credits</th>
            </tr></thead>
            <tbody>
              ${requests.map(req=>{
                const jt = req.candidates ? toTitleCase(req.candidates["Current Job Title"]||req.candidates.Name) : 'Unknown';
                return `<tr style="border-bottom:1px solid #e5e7eb;">
                  <td style="padding:.5rem;">${new Date(req.request_date).toLocaleDateString()}</td>
                  <td style="padding:.5rem;">${jt}</td>
                  <td style="padding:.5rem;">-${req.credits_used||1}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>`;
      }else{
        historyDiv.innerHTML = '<p style="text-align:center;color:var(--rough-gray);">No credit history yet.</p>';
      }
    }

    async function loadRequests(){
      const { data: requests } = await supabase.from('requests').select('*, candidates(*)')
        .eq('user_id', currentUser.id).order('request_date', { ascending:false });

      const content = document.getElementById('requestsList');
      if (!requests || !requests.length){
        content.innerHTML = '<p style="text-align:center;color:var(--rough-gray);">No requests made yet.</p>';
        return;
      }
      content.innerHTML = `
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr style="background:#f9fafb;">
            <th style="padding:1rem;text-align:left;">Date</th>
            <th style="padding:1rem;text-align:left;">Candidate</th>
            <th style="padding:1rem;text-align:left;">Location</th>
            <th style="padding:1rem;text-align:left;">Status</th>
            <th style="padding:1rem;text-align:left;">Credits</th>
          </tr></thead>
          <tbody>
            ${requests.map(req=>{
              const c = req.candidates;
              const jt = c ? toTitleCase(c["Current Job Title"]||c.Name||`Candidate #${req.candidate_id}`) : `Candidate #${req.candidate_id}`;
              const loc = c ? cleanAndFormatLocation(c["Town/City"], c.Country) : 'N/A';
              const status = req.status || 'pending';
              const cls = status === 'completed' ? 'completed' : 'pending';
              const text = status === 'completed' ? 'Completed' : 'Processing';
              return `<tr style="border-bottom:1px solid #e5e7eb;">
                <td style="padding:1rem;">${new Date(req.request_date).toLocaleDateString()}</td>
                <td style="padding:1rem;">${jt}</td>
                <td style="padding:1rem;">${loc}</td>
                <td style="padding:1rem;"><span class="request-status ${cls}">${text}</span></td>
                <td style="padding:1rem;">${req.credits_used||1}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>`;
    }

    async function loadAdmin(){
      const { data: allUsers } = await supabase.from('users').select('*').order('created_at',{ascending:false});

      const usersList = document.getElementById('adminUsersList');
      usersList.innerHTML = (allUsers&&allUsers.length) ? `
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr style="background:#f9fafb;">
            <th style="padding:1rem;text-align:left;">Name</th>
            <th style="padding:1rem;text-align:left;">Email</th>
            <th style="padding:1rem;text-align:left;">Role</th>
            <th style="padding:1rem;text-align:left;">Credits</th>
            <th style="padding:1rem;text-align:left;">Created</th>
          </tr></thead>
          <tbody>
          ${(allUsers||[]).map(u=>`
            <tr style="border-bottom:1px solid #e5e7eb;">
              <td style="padding:1rem;">${u.name||'Not set'}</td>
              <td style="padding:1rem;">${u.email}</td>
              <td style="padding:1rem;">${u.role||'viewer'}</td>
              <td style="padding:1rem;">${u.credits||0}</td>
              <td style="padding:1rem;">${new Date(u.created_at).toLocaleDateString()}</td>
            </tr>`).join('')}
          </tbody>
        </table>` : '<p style="text-align:center;color:var(--rough-gray);">No users found.</p>';

      const { data: allRequests } = await supabase
        .from('requests')
        .select('*, users(name,email), candidates(*)')
        .order('request_date', { ascending:false })
        .limit(100);

      const requestsList = document.getElementById('adminRequestsList');
      requestsList.innerHTML = (allRequests&&allRequests.length) ? `
        <p style="margin-bottom:1rem;padding:1rem;background:#fff3cd;border-radius:8px;">
          <strong>📧 Action Required:</strong> Contact candidates for pending requests and update status to 'completed'.
        </p>
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr style="background:#f9fafb;">
            <th style="padding:1rem;text-align:left;">Date</th>
            <th style="padding:1rem;text-align:left;">User</th>
            <th style="padding:1rem;text-align:left;">Candidate</th>
            <th style="padding:1rem;text-align:left;">Location</th>
            <th style="padding:1rem;text-align:left;">Status</th>
            <th style="padding:1rem;text-align:left;">Credits</th>
          </tr></thead>
          <tbody>
            ${allRequests.map(req=>{
              const c = req.candidates;
              const jt = c ? toTitleCase(c["Current Job Title"]||c.Name||`Candidate #${req.candidate_id}`) : `Candidate #${req.candidate_id}`;
              const loc = c ? cleanAndFormatLocation(c["Town/City"], c.Country) : 'N/A';
              const status = req.status || 'pending';
              const cls = status === 'completed' ? 'completed' : 'pending';
              return `<tr style="border-bottom:1px solid #e5e7eb;">
                <td style="padding:1rem;">${new Date(req.request_date).toLocaleDateString()}</td>
                <td style="padding:1rem;">${req.users?.name || req.users?.email || 'Unknown'}</td>
                <td style="padding:1rem;">${jt}</td>
                <td style="padding:1rem;">${loc}</td>
                <td style="padding:1rem;"><span class="request-status ${cls}">${status}</span></td>
                <td style="padding:1rem;">${req.credits_used||1}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>` : '<p style="text-align:center;color:var(--rough-gray);">No requests found.</p>';
    }

    // ===== Misc =====
    document.getElementById('candidateModal')?.addEventListener('click', e => { if (e.target===e.currentTarget) closeModal(); });
    window.addEventListener('popstate', ()=>{
      const view = new URL(window.location).searchParams.get('view') || 'pools';
      switchView(view);
    });
  </script>
</body>
</html>
