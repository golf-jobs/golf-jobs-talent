<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Jobs - Premium Talent Pools</title>
    
    <!-- Add Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --augusta-green: #004d26;
            --fairway-green: #2d5f3f;
            --masters-green: #3a7858;
            --putting-green: #6b9080;
            --club-gold: #c9a961;
            --trophy-gold: #f4d03f;
            --sand-bunker: #f5e6d3;
            --morning-mist: #f8f9fa;
            --pro-shop-navy: #1a2332;
            --scorecard-white: #ffffff;
            --rough-gray: #6c757d;
            --hazard-red: #c9302c;
            --water-hazard: #2c5aa0;
        }

        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: var(--pro-shop-navy);
            background: linear-gradient(180deg, #f8f9fa 0%, #e8efe8 100%);
            min-height: 100vh;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            height: 250px;
            border-radius: 16px;
            margin-bottom: 1.75rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 77, 38, 0.1);
            border-top-color: var(--augusta-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--augusta-green);
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 450px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-title {
            text-align: center;
            color: var(--augusta-green);
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .login-subtitle {
            text-align: center;
            color: var(--rough-gray);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--pro-shop-navy);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e1e8e4;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--masters-green);
            box-shadow: 0 0 0 3px rgba(58, 120, 88, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--masters-green) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Poppins', sans-serif;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 77, 38, 0.3);
        }

        .login-error {
            background: #fee;
            color: var(--hazard-red);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        /* Main App */
        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--fairway-green) 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
        }

        .logo img {
            height: 60px;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 0.625rem 1.25rem;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: var(--club-gold);
            color: var(--augusta-green);
            font-weight: 600;
        }

        .shortlist-badge {
            background: rgba(255,255,255,0.3);
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            margin-left: 0.25rem;
            font-size: 0.875rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 12px;
        }

        .credits-badge {
            background: linear-gradient(135deg, var(--club-gold) 0%, var(--trophy-gold) 100%);
            color: var(--augusta-green);
            padding: 0.375rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
        }

        .btn-logout {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* View Sections */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Filter Panel Mobile */
        .filter-toggle-mobile {
            display: none;
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: var(--augusta-green);
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 99;
            font-size: 1.5rem;
        }

        @media (max-width: 768px) {
            .filter-toggle-mobile {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .filter-panel {
                position: fixed;
                top: 0;
                left: -100%;
                width: 80%;
                height: 100vh;
                background: white;
                z-index: 1000;
                transition: left 0.3s ease;
                overflow-y: auto;
                box-shadow: 2px 0 20px rgba(0,0,0,0.1);
            }
            
            .filter-panel.active {
                left: 0;
            }
            
            .filter-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }
            
            .filter-overlay.active {
                display: block;
            }
        }

        /* Pools Grid */
        .pools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .pool-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .pool-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .pool-card.locked {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .pool-header {
            background: linear-gradient(135deg, var(--fairway-green) 0%, var(--masters-green) 100%);
            padding: 2rem;
            color: white;
            position: relative;
        }

        .pool-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .pool-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--club-gold);
            color: var(--augusta-green);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 700;
        }

        .pool-stats {
            padding: 2rem;
        }

        .pool-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .pool-stat:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        /* Candidates Grid */
        .candidates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 1.75rem;
            margin-bottom: 2rem;
        }

        .candidate-card {
            background: white;
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
            position: relative;
            cursor: pointer;
        }

        .candidate-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 24px rgba(0,0,0,0.1);
            border-color: var(--masters-green);
        }

        .candidate-card.selected {
            background: #f0f8f4;
            border-color: var(--masters-green);
        }

        .candidate-checkbox {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .top-pick-badge {
            position: absolute;
            top: -10px;
            right: 15px;
            background: linear-gradient(135deg, #2d5f3f, #3a7858);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .new-badge {
            position: absolute;
            top: -8px;
            left: 1rem;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Message System Styles */
        .message-box {
            background: #f8f9fa;
            border: 1px solid #e1e8e4;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .message-textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.75rem;
            border: 2px solid #e1e8e4;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
            font-size: 1rem;
        }

        .message-textarea:focus {
            outline: none;
            border-color: var(--masters-green);
        }

        .conversation-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
        }

        .message.sent {
            background: var(--masters-green);
            color: white;
            margin-left: 20%;
            text-align: right;
        }

        .message.received {
            background: #f0f0f0;
            margin-right: 20%;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        /* Sorting Bar */
        .sorting-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .sort-options {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 35, 50, 0.95);
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background: white;
            margin: 3% auto;
            padding: 2rem;
            width: 90%;
            max-width: 700px;
            border-radius: 20px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--rough-gray);
        }

        .modal-close:hover {
            color: var(--pro-shop-navy);
        }

        /* Notes Panel */
        .notes-panel {
            background: #fffef5;
            border: 1px solid var(--club-gold);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .note-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.5rem;
            border: 1px solid #e1e8e4;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
        }

        /* Show More/Less */
        .expandable-text {
            position: relative;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .expandable-text.collapsed {
            max-height: 120px;
        }

        .show-more-btn {
            color: var(--masters-green);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .show-more-btn:hover {
            color: var(--augusta-green);
        }

        /* Highlight Search Terms */
        .highlight {
            background: yellow;
            padding: 0 2px;
            border-radius: 2px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .empty-state img {
            width: 200px;
            opacity: 0.5;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: var(--augusta-green);
            margin-bottom: 1rem;
        }

        .empty-state p {
            color: var(--rough-gray);
            margin-bottom: 2rem;
        }

        /* Load More */
        .load-more-container {
            text-align: center;
            padding: 2rem;
        }

        .load-more-btn {
            padding: 0.875rem 2rem;
            background: white;
            color: var(--augusta-green);
            border: 2px solid var(--augusta-green);
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .load-more-btn:hover {
            background: var(--augusta-green);
            color: white;
        }

        /* Buttons */
        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--masters-green) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 77, 38, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--augusta-green);
            border: 2px solid var(--augusta-green);
        }

        .btn-secondary:hover {
            background: var(--augusta-green);
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .section-box {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            color: var(--rough-gray);
        }

        .breadcrumb a {
            color: var(--masters-green);
            text-decoration: none;
            font-weight: 600;
        }

        .breadcrumb a:hover {
            color: var(--augusta-green);
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--pro-shop-navy);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 0.5rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Request Status Badge */
        .request-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .request-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .request-status.completed {
            background: #d4edda;
            color: #155724;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .pools-grid, .candidates-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .sorting-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .modal-content {
                margin: 10% 1rem;
                width: calc(100% - 2rem);
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div style="text-align: center; margin-bottom: 2rem;">
                <img src="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20black.png?updatedAt=1757017924442" alt="Golf Jobs" style="width: 200px;">
            </div>
            <h1 class="login-title">Talent Pool Access</h1>
            <p class="login-subtitle">Exclusive recruitment platform</p>
            
            <div id="loginError" class="login-error">Invalid credentials. Please try again.</div>
            
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="loginEmail" required placeholder="your@company.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn-login">Sign In</button>
            </form>
            
            <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e1e8e4;">
                <p style="color: var(--rough-gray); font-size: 0.85rem;">¬© 2024 Golf Jobs. Professional recruitment excellence.</p>
                <p style="margin-top: 0.5rem; color: var(--rough-gray); font-size: 0.85rem;">Need access? Contact <strong>graham@golf-jobs.com</strong></p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo" onclick="goHome()">
                    <img src="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20white.png?updatedAt=1758280288759" alt="Golf Jobs">
                </div>
                <nav class="nav-tabs">
                    <button class="nav-tab active" onclick="switchView('pools')">Talent Pools</button>
                    <button class="nav-tab" onclick="switchView('shortlist')">
                        Shortlist <span id="shortlistBadge" class="shortlist-badge" style="display: none;">0</span>
                    </button>
                    <button class="nav-tab" onclick="switchView('messages')">Messages</button>
                    <button class="nav-tab" onclick="switchView('account')">My Account</button>
                    <button id="adminTab" class="nav-tab" onclick="switchView('admin')" style="display:none;">Admin</button>
                </nav>
                <div class="user-info">
                    <span id="userName">Welcome</span>
                    <div class="credits-badge">
                        Credits: <span id="creditsCount">0</span>
                    </div>
                    <button class="btn-logout" onclick="handleLogout()">Sign Out</button>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Pools View -->
            <div id="poolsView" class="view-section active">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Your Talent Pools</h1>
                <p style="color: var(--rough-gray); margin-bottom: 2rem; font-size: 1.1rem;">Select a talent pool to browse candidates</p>
                <div class="pools-grid" id="poolsGrid">
                    <!-- Loading skeletons -->
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
                
                <div class="section-box">
                    <h2 style="font-size: 1.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Unlock More Talent Pools</h2>
                    <p style="color: var(--rough-gray); margin-bottom: 1.5rem;">Expand your recruitment reach with access to additional regions</p>
                    <button class="btn btn-primary" onclick="alert('Contact graham@golf-jobs.com for access to additional pools')">Request Access</button>
                </div>
            </div>

            <!-- Pool Detail View -->
            <div id="poolDetailView" class="view-section">
                <div class="breadcrumb">
                    <a href="#" onclick="switchView('pools')">Talent Pools</a>
                    <span>‚Üí</span>
                    <span id="currentPoolName">Pool Name</span>
                </div>
                
                <!-- Filter Panel -->
                <div class="section-box filter-panel" id="filterPanel">
                    <button class="filter-close-mobile" onclick="toggleFilterPanel()" style="display: none; position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
                    
                    <input type="text" id="searchInput" placeholder="Search by name, role, skills, or location..." 
                           style="width: 100%; padding: 0.875rem; border: 2px solid #e1e8e4; border-radius: 12px; font-size: 1rem; margin-bottom: 1rem;">
                    
                    <!-- Filters -->
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-start;">
                        <select id="salaryFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Salaries</option>
                            <option value="0-30000">¬£20-30k</option>
                            <option value="30000-40000">¬£30-40k</option>
                            <option value="40000-50000">¬£40-50k</option>
                            <option value="50000-60000">¬£50-60k</option>
                            <option value="60000-70000">¬£60-70k</option>
                            <option value="70000+">¬£70k+</option>
                        </select>
                        
                        <select id="noticeFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Notice Periods</option>
                            <option value="immediately">Available Immediately</option>
                            <option value="1 week">1 Week</option>
                            <option value="1 month">1 Month</option>
                            <option value="2 months">2 Months</option>
                            <option value="3 months">3 Months</option>
                        </select>
                        
                        <select id="lookingFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">Active/Passive</option>
                            <option value="YES">Actively Looking</option>
                            <option value="NO">Not Actively Looking</option>
                        </select>
                        
                        <select id="categoryFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Categories</option>
                            <option value="greenkeeping">Greenkeeping</option>
                            <option value="management">Management</option>
                            <option value="sales">Sales & Business Dev</option>
                            <option value="marketing">Marketing & PR</option>
                            <option value="fandB">F&B / Hospitality</option>
                            <option value="professional">Golf Professional</option>
                            <option value="operations">Operations</option>
                            <option value="retail">Retail & Pro Shop</option>
                            <option value="maintenance">Maintenance & Facilities</option>
                            <option value="admin">Admin & Support</option>
                            <option value="other">Other</option>
                        </select>
                        
                        <!-- Location Filter Dropdown -->
                        <div style="position: relative;">
                            <button onclick="toggleLocationDropdown()" 
                                    style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; 
                                           font-size: 0.95rem; background: white; cursor: pointer; 
                                           min-width: 150px; text-align: left; display: flex; 
                                           justify-content: space-between; align-items: center;">
                                <span id="locationFilterText">All Locations</span>
                                <span style="font-size: 0.8rem;">‚ñº</span>
                            </button>
                            <div id="locationDropdown" style="display: none; position: absolute; top: 100%; 
                                                              left: 0; right: 0; background: white; 
                                                              border: 2px solid #e1e8e4; border-radius: 8px; 
                                                              margin-top: 0.25rem; max-height: 300px; 
                                                              overflow-y: auto; z-index: 1000; min-width: 200px;">
                                <div style="padding: 0.5rem; border-bottom: 1px solid #e1e8e4;">
                                    <button onclick="selectAllLocations()" 
                                            style="margin-right: 0.5rem; padding: 0.25rem 0.5rem; 
                                                   border: 1px solid #e1e8e4; border-radius: 4px; 
                                                   background: white; cursor: pointer; font-size: 0.85rem;">
                                        Select All
                                    </button>
                                    <button onclick="clearAllLocations()" 
                                            style="padding: 0.25rem 0.5rem; border: 1px solid #e1e8e4; 
                                                   border-radius: 4px; background: white; cursor: pointer; 
                                                   font-size: 0.85rem;">
                                        Clear All
                                    </button>
                                </div>
                                <div id="locationCheckboxes" style="padding: 0.5rem;">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="clearFilters()" class="btn btn-small" style="background: #e5e7eb; color: var(--rough-gray);">
                            Clear All
                        </button>
                    </div>
                </div>
                
                <!-- Filter Toggle Mobile -->
                <button class="filter-toggle-mobile" onclick="toggleFilterPanel()">
                    ‚öôÔ∏è
                </button>
                <div class="filter-overlay" id="filterOverlay" onclick="toggleFilterPanel()"></div>
                
                <!-- Sorting and Bulk Actions -->
                <div class="sorting-bar">
                    <div class="sort-options">
                        <label style="margin-right: 0.5rem; color: var(--rough-gray);">Sort by:</label>
                        <select id="sortSelect" onchange="applySort()" style="padding: 0.5rem; border: 1px solid #e1e8e4; border-radius: 8px;">
                            <option value="relevance">Best Match</option>
                            <option value="newest">Newest First</option>
                            <option value="salary-high">Salary (High to Low)</option>
                            <option value="salary-low">Salary (Low to High)</option>
                        </select>
                    </div>
                    
                    <div class="bulk-actions">
                        <button class="btn btn-small btn-secondary" onclick="selectAll()">Select All</button>
                        <button class="btn btn-small btn-secondary" onclick="deselectAll()">Clear Selection</button>
                        <button class="btn btn-small btn-primary" onclick="bulkAddToShortlist()">Add Selected to Shortlist</button>
                        <button class="btn btn-small btn-primary" onclick="exportCandidates()">Export</button>
                    </div>
                </div>
                
                <div id="candidateCount" style="margin-bottom: 1rem; color: var(--rough-gray);"></div>
                
                <!-- Candidates Grid with Pagination -->
                <div class="candidates-grid" id="candidatesGrid">
                    <!-- Loading skeletons -->
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
                
                <!-- Load More -->
                <div class="load-more-container" id="loadMoreContainer" style="display: none;">
                    <button class="load-more-btn" onclick="loadMore()">Load More Candidates</button>
                </div>
            </div>

            <!-- Shortlist View -->
            <div id="shortlistView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Your Shortlist</h1>
                <div style="margin-bottom: 2rem;">
                    <button class="btn btn-primary" onclick="exportShortlist()">Export Shortlist</button>
                </div>
                <div id="shortlistContent"></div>
            </div>

            <!-- Messages View -->
            <div id="messagesView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Messages</h1>
                <div id="conversationsList"></div>
            </div>

            <!-- Account View -->
            <div id="accountView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 2rem;">My Account</h1>
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1rem;">Account Overview</h2>
                    <p style="margin-bottom: 1rem;"><strong>Name:</strong> <span id="accountName">-</span></p>
                    <p style="margin-bottom: 1rem;"><strong>Email:</strong> <span id="accountEmail">-</span></p>
                    <p style="margin-bottom: 1rem;"><strong>Credits Balance:</strong> <span id="accountCredits">0</span></p>
                    <p><strong>Total Messages Sent:</strong> <span id="totalMessages">0</span></p>
                </div>
                
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1rem;">Credits History</h2>
                    <div id="creditsHistory"></div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 2rem;">Admin Panel</h1>
                
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1rem;">All Users</h2>
                    <div id="adminUsersList"></div>
                </div>
                
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1rem;">Recent Messages</h2>
                    <div id="adminMessagesList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Candidate Modal -->
    <div id="candidateModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <h2 id="modalTitle" style="color: var(--augusta-green); margin-bottom: 1rem;"></h2>
            <div id="modalBody"></div>
            
            <!-- Notes Section -->
            <div class="notes-panel">
                <h4 style="color: var(--augusta-green); margin-bottom: 0.5rem;">üìù Private Notes</h4>
                <textarea class="note-textarea" id="candidateNotes" placeholder="Add your notes about this candidate..."></textarea>
                <button class="btn btn-small" onclick="saveNotes()" style="margin-top: 0.5rem;">Save Notes</button>
            </div>
            
            <!-- Message Section (replaces contact request) -->
            <div class="message-box">
                <h4 style="color: var(--augusta-green); margin-bottom: 0.5rem;">üí¨ Send Message</h4>
                <p style="font-size: 0.85rem; color: var(--rough-gray); margin-bottom: 0.5rem;">
                    First message to this candidate will use 1 credit. Follow-up messages are free.
                </p>
                <div id="previousMessages" class="conversation-container" style="display: none;">
                    <!-- Previous messages will appear here -->
                </div>
                <textarea class="message-textarea" id="messageText" 
                          placeholder="Introduce yourself and explain why you're interested in this candidate..."></textarea>
                <button class="btn btn-primary btn-small" onclick="sendMessage()" style="margin-top: 0.5rem;">
                    Send Message <span id="creditCost"></span>
                </button>
            </div>
            
            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="addToShortlist()">Save to Shortlist</button>
            </div>
        </div>
    </div>



    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://kbadedwbcjetxiertztv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtiYWRlZHdiY2pldHhpZXJ0enR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDAyNDMsImV4cCI6MjA3Mzg3NjI0M30.igm3XjM8l1OXfilQaAHtmJyCDe9eXILV_P9B3_sUzwg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state
        let currentUser = null;
        let currentPool = null;
        let currentCandidate = null;
        let userProfile = null;
        let userPools = [];
        let shortlist = [];
        let allCandidates = [];
        let filteredCandidates = [];
        let displayedCandidates = [];
        let selectedLocations = new Set();
        let availableLocations = new Set();
        let selectedCandidates = new Set();
        let candidateNotes = {};
        let searchTimeout = null;
        let currentPage = 0;
        const candidatesPerPage = 20;
        let searchTerm = '';
        let conversations = {};

        // Utility functions
        function toTitleCase(str) {
            if (!str) return str;
            
            const acronyms = ['UK', 'USA', 'US', 'CEO', 'CFO', 'COO', 'CTO', 'CIO', 'CMO', 
                             'PGA', 'PR', 'HR', 'IT', 'SEO', 'SEM', 'EMEA', 'APAC', 'B2B', 
                             'B2C', 'VP', 'SVP', 'EVP', 'GM', 'MD', 'PA', 'EA', 'F&B', 
                             'R&D', 'QA', 'UI', 'UX', 'API', 'CRM', 'ERP', 'KPI', 'ROI',
                             'P&L', 'M&A', 'IPO', 'MBA', 'PhD', 'CPA', 'LLP', 'LLC'];
            
            return str.toLowerCase().split(/(\s+|-)/).map(word => {
                const cleanWord = word.replace(/[.,;:!?]/g, '');
                const upperClean = cleanWord.toUpperCase();
                
                if (acronyms.includes(upperClean)) {
                    return word.replace(cleanWord, upperClean);
                }
                
                if (word.length > 0) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }
                return word;
            }).join('');
        }

        function cleanAndFormatLocation(townCity, country) {
            const excludeTerms = ['England', 'United Kingdom', 'UK', 'Scotland', 'Wales', 'Northern Ireland', 
                                 'Great Britain', 'GB', 'Uk', 'england', 'united kingdom'];
            
            let cleanedTown = townCity ? townCity.trim() : '';
            
            if (cleanedTown.includes(',')) {
                cleanedTown = cleanedTown.split(',')[0].trim();
            }
            
            let cleanedCountry = country ? country.trim() : '';
            
            if (excludeTerms.some(term => cleanedCountry.toLowerCase() === term.toLowerCase())) {
                cleanedCountry = '';
            }
            
            if (cleanedCountry && cleanedCountry.includes(',')) {
                const parts = cleanedCountry.split(',');
                const firstPart = parts[0].trim();
                if (!excludeTerms.some(term => firstPart.toLowerCase() === term.toLowerCase())) {
                    if (!cleanedTown) {
                        cleanedTown = firstPart;
                    }
                    cleanedCountry = '';
                }
            }
            
            if (cleanedTown === cleanedTown.toUpperCase() && cleanedTown.length > 2) {
                cleanedTown = toTitleCase(cleanedTown);
            } else {
                cleanedTown = toTitleCase(cleanedTown);
            }
            
            if (cleanedTown) {
                return cleanedTown;
            }
            
            return 'Location Not Specified';
        }

        function formatSalaryExact(salary) {
            if (!salary) return 'Salary Negotiable';
            const num = parseFloat(salary);
            if (isNaN(num)) return 'Salary Negotiable';
            return `¬£${num.toLocaleString()}`;
        }

        function formatNoticePeriod(notice) {
            if (!notice) return 'Unknown Notice Period';
            const lowerNotice = notice.toLowerCase();
            if (lowerNotice.includes('immediately') || lowerNotice.includes('immediate')) return 'Available immediately';
            if (lowerNotice.includes('1 week')) return '1 week notice';
            if (lowerNotice.includes('2 week')) return '2 weeks notice';
            if (lowerNotice.includes('1 month')) return '1 month notice';
            if (lowerNotice.includes('2 month')) return '2 months notice';
            if (lowerNotice.includes('3 month')) return '3 months notice';
            return notice + ' notice';
        }

        // Function to add line breaks to text (for summaries)
        function formatWithLineBreaks(text) {
            if (!text) return '';
            // Split on sentence endings and rejoin with <br><br> for clear paragraph breaks
            return text.replace(/\. /g, '.<br><br>');
        }

        function generateSummaryPreview(text, maxLength = 120) {
            if (!text) return '';
            
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            
            if (sentences.length === 0) return text.substring(0, maxLength) + '...';
            
            const keyPhrases = ['years experience', 'specializing in', 'expertise in', 'responsible for', 
                               'passionate about', 'skilled in', 'background in', 'focused on'];
            
            let bestSentence = sentences[0];
            for (let sentence of sentences) {
                if (keyPhrases.some(phrase => sentence.toLowerCase().includes(phrase))) {
                    bestSentence = sentence;
                    break;
                }
            }
            
            const summary = bestSentence.trim();
            if (summary.length > maxLength) {
                return summary.substring(0, maxLength) + '...';
            }
            return summary;
        }

        function formatSkillsDisplay(skillsString) {
            if (!skillsString) return '';
            
            // Return as plain text - no green highlights
            if (skillsString.length > 150) {
                return `<p style="color: var(--rough-gray); font-size: 0.9rem; line-height: 1.4; margin-bottom: 0.5rem;">
                        ${skillsString.substring(0, 120)}...</p>`;
            }
            
            return `<p style="color: var(--rough-gray); font-size: 0.9rem; line-height: 1.4; margin-bottom: 0.5rem;">
                    ${skillsString}</p>`;
        }

        // Profile score calculation
        function calculateProfileScore(candidate) {
            let score = 0;
            let maxScore = 100;
            
            // Professional Summary - 30 points max
            const aboutYou = candidate["About You"] || '';
            if (aboutYou.length > 200) {
                score += 30;
            } else if (aboutYou.length > 100) {
                score += 20;
            } else if (aboutYou.length > 50) {
                score += 10;
            }
            
            // Skills - 20 points
            const skills = candidate["Your Skills"] || '';
            if (skills.length > 100) {
                score += 20;
            } else if (skills.length > 50) {
                score += 15;
            } else if (skills.length > 20) {
                score += 10;
            }
            
            // Job Title - 10 points
            if (candidate["Current Job Title"] || candidate["Job Title"]) {
                score += 10;
            }
            
            // Salary expectations - 10 points
            if (candidate["What are your salary expectations?"] || candidate["Salary Expectations"]) {
                score += 10;
            }
            
            // Notice period - 10 points
            if (candidate["Notice Period"]) {
                score += 10;
            }
            
            // Location - 5 points
            if (candidate["Town/City"]) {
                score += 5;
            }
            
            // Contact info - 5 points each
            if (candidate["Email"]) score += 5;
            if (candidate["LinkedIn"]) score += 5;
            if (candidate["GitHub"]) score += 5;
            
            return Math.min((score / maxScore) * 100, 100);
        }

        function isNewCandidate(candidate) {
            if (!candidate.created_at) return false;
            const createdDate = new Date(candidate.created_at);
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            return createdDate > sevenDaysAgo;
        }

        function highlightSearchTerms(text, term) {
            if (!term || !text) return text;
            const regex = new RegExp(`(${term})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function detectJobCategory(jobTitle) {
            if (!jobTitle) return 'other';
            
            const title = jobTitle.toLowerCase();
            
            const greenkeepingKeywords = [
                'greenkeep', 'green keep', 'course manager', 'turf', 'agronomist', 'superintendent',
                'groundsman', 'grounds', 'course maintenance', 'irrigation', 'horticultur',
                'course care', 'course condition', 'grounds crew', 'greens staff', 'deputy course',
                'assistant greenkeeper', 'head greenkeeper', 'spray technician', 'mechanic greenkeep'
            ];
            if (greenkeepingKeywords.some(keyword => title.includes(keyword))) {
                return 'greenkeeping';
            }
            
            const managementKeywords = [
                'director', 'manager', 'head of', 'chief', 'ceo', 'coo', 'cfo', 'cto', 'cio',
                'president', 'vice president', 'vp ', 'svp', 'evp', 'executive', 'partner',
                'managing director', 'general manager', 'gm ', 'regional manager', 'area manager',
                'operations director', 'commercial director', 'finance director', 'managing partner',
                'owner', 'proprietor', 'chairman', 'board member', 'trustee', 'committee'
            ];
            if (managementKeywords.some(keyword => title.includes(keyword))) {
                return 'management';
            }
            
            const salesKeywords = [
                'sales', 'business development', 'account manager', 'commercial', 'revenue',
                'client manager', 'customer success', 'relationship manager', 'account executive',
                'sales representative', 'sales exec', 'biz dev', 'partnerships', 'corporate sales',
                'membership sales', 'sales consultant', 'sales advisor', 'telesales', 'inside sales',
                'field sales', 'sales support', 'sales coordinator', 'key account', 'national account',
                'territory manager', 'district manager', 'business manager', 'development manager'
            ];
            if (salesKeywords.some(keyword => title.includes(keyword))) {
                return 'sales';
            }
            
            const marketingKeywords = [
                'marketing', 'pr ', 'public relations', 'communications', 'social media', 'brand',
                'digital marketing', 'content', 'copywriter', 'graphic design', 'designer',
                'creative', 'advertising', 'media', 'campaign', 'seo', 'sem', 'ppc', 'email marketing',
                'marketing exec', 'marketing assistant', 'marketing coordinator', 'marketing manager',
                'community manager', 'influence', 'affiliate', 'growth', 'acquisition', 'retention',
                'engagement', 'events', 'event manager', 'event coordinator', 'conference'
            ];
            if (marketingKeywords.some(keyword => title.includes(keyword))) {
                return 'marketing';
            }
            
            const fandBKeywords = [
                'chef', 'food', 'beverage', 'f&b', 'f & b', 'restaurant', 'bar', 'catering',
                'hospitality', 'waiter', 'waitress', 'server', 'barista', 'sommelier', 'kitchen',
                'cook', 'sous chef', 'head chef', 'pastry', 'baker', 'dining', 'banquet',
                'room service', 'food service', 'maitre', 'host', 'hostess', 'steward',
                'breakfast', 'lunch', 'dinner', 'cafe', 'bistro', 'clubhouse', 'halfway house',
                'beverage cart', 'snack bar', 'concession', 'catering manager', 'food manager'
            ];
            if (fandBKeywords.some(keyword => title.includes(keyword))) {
                return 'fandB';
            }
            
            const professionalKeywords = [
                'golf professional', 'pga', 'teaching pro', 'head pro', 'assistant pro',
                'golf coach', 'golf instructor', 'golf teacher', 'club professional',
                'touring pro', 'tour professional', 'golf director', 'director of golf',
                'first assistant', 'second assistant', 'golf services', 'lesson', 'academy',
                'instruction', 'fitting', 'club fitter', 'custom fitting', 'golf shop'
            ];
            if (professionalKeywords.some(keyword => title.includes(keyword))) {
                return 'professional';
            }
            
            const operationsKeywords = [
                'operations', 'coordinator', 'administrator', 'duty manager', 'shift manager',
                'logistics', 'planning', 'scheduling', 'procurement', 'purchasing', 'buyer',
                'supply chain', 'inventory', 'warehouse', 'distribution', 'facilities manager',
                'office manager', 'project manager', 'program manager', 'compliance', 'quality',
                'health and safety', 'h&s', 'risk', 'audit', 'process', 'improvement', 'efficiency'
            ];
            if (operationsKeywords.some(keyword => title.includes(keyword)) && !title.includes('it ')) {
                return 'operations';
            }
            
            const retailKeywords = [
                'retail', 'pro shop', 'golf shop', 'shop', 'merchandis', 'buyer', 'visual',
                'store manager', 'shop manager', 'retail manager', 'retail assistant',
                'shop assistant', 'sales assistant', 'cashier', 'till', 'stock', 'inventory',
                'display', 'window', 'fashion', 'apparel', 'clothing', 'equipment',
                'club sales', 'golf sales', 'retail supervisor', 'shop supervisor'
            ];
            if (retailKeywords.some(keyword => title.includes(keyword))) {
                return 'retail';
            }
            
            const maintenanceKeywords = [
                'maintenance', 'mechanic', 'facilities', 'technician', 'engineer', 'electrical',
                'electrician', 'plumber', 'plumbing', 'hvac', 'carpenter', 'joiner', 'painter',
                'decorator', 'handyman', 'repair', 'service', 'workshop', 'machinery',
                'equipment tech', 'golf car', 'golf cart', 'buggy', 'vehicle', 'fleet',
                'building', 'property', 'estate', 'security', 'groundswork', 'landscap'
            ];
            if (maintenanceKeywords.some(keyword => title.includes(keyword))) {
                return 'maintenance';
            }
            
            const adminKeywords = [
                'admin', 'assistant', 'reception', 'secretary', 'clerk', 'support', 'office',
                'pa ', 'personal assistant', 'executive assistant', 'ea ', 'bookkeep',
                'accounts', 'finance assistant', 'payroll', 'hr assistant', 'data entry',
                'customer service', 'call center', 'help desk', 'front desk', 'concierge',
                'coordinator', 'junior', 'trainee', 'apprentice', 'intern', 'entry level'
            ];
            if (adminKeywords.some(keyword => title.includes(keyword))) {
                return 'admin';
            }
            
            return 'other';
        }

        // Enhanced filter functions with debounce
        function debounce(func, delay) {
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => func.apply(context, args), delay);
            }
        }

        function updateFiltersWithCounts() {
            const categories = {};
            const salaryRanges = {
                '0-30000': 0,
                '30000-40000': 0,
                '40000-50000': 0,
                '50000-60000': 0,
                '60000-70000': 0,
                '70000+': 0
            };
            
            allCandidates.forEach(candidate => {
                const category = detectJobCategory(candidate["Current Job Title"] || candidate["Job Title"]);
                categories[category] = (categories[category] || 0) + 1;
                
                const salary = parseFloat(candidate["What are your salary expectations?"]) || 0;
                if (salary >= 70000) salaryRanges['70000+']++;
                else if (salary >= 60000) salaryRanges['60000-70000']++;
                else if (salary >= 50000) salaryRanges['50000-60000']++;
                else if (salary >= 40000) salaryRanges['40000-50000']++;
                else if (salary >= 30000) salaryRanges['30000-40000']++;
                else if (salary > 0) salaryRanges['0-30000']++;
            });
            
            // Update category filter with counts
            const categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter) {
                const currentValue = categoryFilter.value;
                categoryFilter.innerHTML = `
                    <option value="">All Categories (${allCandidates.length})</option>
                    ${categories.greenkeeping ? `<option value="greenkeeping">Greenkeeping (${categories.greenkeeping})</option>` : ''}
                    ${categories.management ? `<option value="management">Management (${categories.management})</option>` : ''}
                    ${categories.sales ? `<option value="sales">Sales & Business Dev (${categories.sales})</option>` : ''}
                    ${categories.marketing ? `<option value="marketing">Marketing & PR (${categories.marketing})</option>` : ''}
                    ${categories.fandB ? `<option value="fandB">F&B / Hospitality (${categories.fandB})</option>` : ''}
                    ${categories.professional ? `<option value="professional">Golf Professional (${categories.professional})</option>` : ''}
                    ${categories.operations ? `<option value="operations">Operations (${categories.operations})</option>` : ''}
                    ${categories.retail ? `<option value="retail">Retail & Pro Shop (${categories.retail})</option>` : ''}
                    ${categories.maintenance ? `<option value="maintenance">Maintenance & Facilities (${categories.maintenance})</option>` : ''}
                    ${categories.admin ? `<option value="admin">Admin & Support (${categories.admin})</option>` : ''}
                    ${categories.other ? `<option value="other">Other (${categories.other})</option>` : ''}
                `;
                categoryFilter.value = currentValue;
            }
        }

        // Location filter functions
        function populateLocationFilter(candidates) {
            availableLocations.clear();
            let unspecifiedCount = 0;
            
            candidates.forEach(candidate => {
                const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                if (location && location !== 'Location Not Specified') {
                    availableLocations.add(location);
                } else {
                    unspecifiedCount++;
                }
            });
            
            const sortedLocations = Array.from(availableLocations).sort();
            const checkboxesDiv = document.getElementById('locationCheckboxes');
            
            let html = sortedLocations.map(location => {
                const count = candidates.filter(c => 
                    cleanAndFormatLocation(c["Town/City"], c.Country) === location
                ).length;
                
                return `
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" value="${location}" 
                                   onchange="updateLocationSelection(this)" 
                                   style="margin-right: 0.5rem;">
                            <span style="font-size: 0.9rem;">${location} (${count})</span>
                        </label>
                    </div>
                `;
            }).join('');
            
            // Add Unspecified at the bottom if there are any
            if (unspecifiedCount > 0) {
                html += `
                    <div style="margin-bottom: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" value="Location Not Specified" 
                                   onchange="updateLocationSelection(this)" 
                                   style="margin-right: 0.5rem;">
                            <span style="font-size: 0.9rem; color: var(--rough-gray);">Unspecified (${unspecifiedCount})</span>
                        </label>
                    </div>
                `;
            }
            
            checkboxesDiv.innerHTML = html;
        }

        function toggleLocationDropdown() {
            const dropdown = document.getElementById('locationDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const overlay = document.getElementById('filterOverlay');
            
            if (window.innerWidth <= 768) {
                panel.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        }

        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('locationDropdown');
            const button = e.target.closest('button');
            if (dropdown && !dropdown.contains(e.target) && 
                (!button || button.getAttribute('onclick') !== 'toggleLocationDropdown()')) {
                dropdown.style.display = 'none';
            }
        });

        function updateLocationSelection(checkbox) {
            if (checkbox.checked) {
                selectedLocations.add(checkbox.value);
            } else {
                selectedLocations.delete(checkbox.value);
            }
            updateLocationFilterText();
            applyFiltersDebounced();
        }

        function updateLocationFilterText() {
            const text = document.getElementById('locationFilterText');
            if (selectedLocations.size === 0) {
                text.textContent = 'All Locations';
            } else if (selectedLocations.size === 1) {
                text.textContent = Array.from(selectedLocations)[0];
            } else {
                text.textContent = `${selectedLocations.size} locations selected`;
            }
        }

        function selectAllLocations() {
            const checkboxes = document.querySelectorAll('#locationCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                selectedLocations.add(cb.value);
            });
            updateLocationFilterText();
            applyFiltersDebounced();
        }

        function clearAllLocations() {
            const checkboxes = document.querySelectorAll('#locationCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            selectedLocations.clear();
            updateLocationFilterText();
            applyFiltersDebounced();
        }

        // Debounced filter application
        const applyFiltersDebounced = debounce(applyFilters, 300);

        // Enhanced authentication and data loading
        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('search')) {
                searchTerm = urlParams.get('search');
            }
            
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                await loadUserData(session.user);
                showApp();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
            }
            
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        function handleKeyboardShortcuts(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
            
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'a' && document.getElementById('poolDetailView').classList.contains('active')) {
                    e.preventDefault();
                    selectAll();
                }
                if (e.key === 'e') {
                    e.preventDefault();
                    exportCandidates();
                }
            }
        }

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            } else {
                await loadUserData(data.user);
                showApp();
            }
        }

        // Load user data with local storage for notes
        async function loadUserData(user) {
            currentUser = user;
            
            const { data: profile, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();
            
            if (profile) {
                userProfile = profile;
                document.getElementById('userName').textContent = profile.name || user.email;
                document.getElementById('creditsCount').textContent = profile.credits || 0;
                
                if (profile.role === 'admin') {
                    document.getElementById('adminTab').style.display = 'block';
                }
            }
            
            const { data: poolAccess } = await supabase
                .from('user_pool_access')
                .select('pool_id')
                .eq('user_id', user.id);
            
            userPools = poolAccess ? poolAccess.map(p => p.pool_id) : [];
            
            // FIXED: Properly fetch shortlist with candidate data
            await refreshShortlist();
            
            // Load saved notes from localStorage
            const savedNotes = localStorage.getItem('candidateNotes_' + currentUser.id);
            if (savedNotes) {
                candidateNotes = JSON.parse(savedNotes);
            }
            
            // Load conversations from localStorage  
            const savedConversations = localStorage.getItem('conversations_' + currentUser.id);
            if (savedConversations) {
                conversations = JSON.parse(savedConversations);
            }
        }

        // FIXED: Refresh shortlist function
        async function refreshShortlist() {
            const { data: shortlistData } = await supabase
                .from('shortlists')
                .select('*')
                .eq('user_id', currentUser.id);
            
            // Now fetch candidate details for each shortlist item
            if (shortlistData && shortlistData.length > 0) {
                const candidateIds = shortlistData.map(item => item.candidate_id);
                const { data: candidatesData } = await supabase
                    .from('candidates')
                    .select('*')
                    .in('ID', candidateIds);
                
                // Combine shortlist with candidate data
                shortlist = shortlistData.map(item => {
                    const candidate = candidatesData?.find(c => c.ID === item.candidate_id);
                    return {
                        ...item,
                        candidates: candidate
                    };
                });
            } else {
                shortlist = [];
            }
            
            updateShortlistBadge();
        }

        // Show main app
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
            loadPools();
        }

        // Handle logout
        async function handleLogout() {
            await supabase.auth.signOut();
            location.reload();
        }

        // Switch views with URL state
        function switchView(view) {
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(view + 'View').classList.add('active');
            if (event && event.target) event.target.classList.add('active');
            
            if (view === 'pools') loadPools();
            else if (view === 'shortlist') loadShortlist();
            else if (view === 'messages') loadMessages();
            else if (view === 'account') loadAccount();
            else if (view === 'admin' && userProfile?.role === 'admin') loadAdmin();
            
            const url = new URL(window.location);
            url.searchParams.set('view', view);
            window.history.pushState({}, '', url);
        }

        // Load talent pools with loading state and sort by count
        async function loadPools() {
            const poolsGrid = document.getElementById('poolsGrid');
            
            poolsGrid.innerHTML = `
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
            `;
            
            const { data: pools } = await supabase
                .from('talent_pools')
                .select('*');
            
            for (let pool of pools) {
                const { count } = await supabase
                    .from('candidates')
                    .select('*', { count: 'exact', head: true })
                    .eq('pool_id', pool.id);
                
                pool.total_candidates = count || 0;
            }
            
            // Sort pools by candidate count (highest first)
            pools.sort((a, b) => b.total_candidates - a.total_candidates);
            
            poolsGrid.innerHTML = '';
            
            for (const pool of pools) {
                const hasAccess = userPools.includes(pool.id);
                
                const poolCard = document.createElement('div');
                poolCard.className = hasAccess ? 'pool-card' : 'pool-card locked';
                poolCard.innerHTML = `
                    <div class="pool-header">
                        <div class="pool-title">${pool.name}</div>
                        <div class="pool-badge">${hasAccess ? 'Available' : 'Locked'}</div>
                    </div>
                    <div class="pool-stats">
                        <div class="pool-stat">
                            <span>Total Candidates</span>
                            <span style="font-size: 1.25rem; font-weight: 700; color: var(--augusta-green);">
                                ${pool.total_candidates}
                            </span>
                        </div>
                    </div>
                `;
                
                if (hasAccess) {
                    poolCard.onclick = () => openPool(pool);
                }
                
                poolsGrid.appendChild(poolCard);
            }
        }

        // Open a pool and show candidates with pagination
        async function openPool(pool) {
            currentPool = pool;
            currentPage = 0;
            document.getElementById('currentPoolName').textContent = pool.name;
            
            // Show loading state
            const candidatesGrid = document.getElementById('candidatesGrid');
            candidatesGrid.innerHTML = `
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
            `;
            
            const { data: candidates, error } = await supabase
                .from('candidates')
                .select('*')
                .eq('pool_id', pool.id);
            
            console.log(`Loading candidates for ${pool.id}:`, candidates?.length, error);
            
            // Sort by profile completeness score (now called "Best Match")
            allCandidates = (candidates || []).sort((a, b) => {
                const scoreA = calculateProfileScore(a);
                const scoreB = calculateProfileScore(b);
                
                const hasSummaryA = a["About You"] && a["About You"].length > 50;
                const hasSummaryB = b["About You"] && b["About You"].length > 50;
                
                if (hasSummaryA && !hasSummaryB) return -1;
                if (!hasSummaryA && hasSummaryB) return 1;
                
                return scoreB - scoreA;
            });
            
            populateLocationFilter(allCandidates);
            updateFiltersWithCounts();
            
            // Apply initial filters and display
            filteredCandidates = [...allCandidates];
            displayCandidatesPage();
            
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.getElementById('poolDetailView').classList.add('active');
        }

        // Display candidates with pagination
        function displayCandidatesPage() {
            const startIdx = currentPage * candidatesPerPage;
            const endIdx = startIdx + candidatesPerPage;
            displayedCandidates = filteredCandidates.slice(0, endIdx);
            
            displayCandidates(displayedCandidates);
            
            // Show/hide load more button
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (endIdx < filteredCandidates.length) {
                loadMoreContainer.style.display = 'block';
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }

        function loadMore() {
            currentPage++;
            displayCandidatesPage();
        }

        // Display candidates in grid with enhancements
        function displayCandidates(candidates) {
            const candidatesGrid = document.getElementById('candidatesGrid');
            
            if (!candidates || candidates.length === 0) {
                candidatesGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <h3>No candidates match your criteria</h3>
                        <p>Try adjusting your filters or search terms</p>
                        <button class="btn btn-primary" onclick="clearFilters()">Clear All Filters</button>
                    </div>
                `;
                updateCandidateCount(0);
                return;
            }
            
            updateCandidateCount(filteredCandidates.length);
            
            candidatesGrid.innerHTML = candidates.map(candidate => {
                const jobTitle = toTitleCase(candidate["Current Job Title"] || 
                               candidate["Job Title"] || 
                               candidate.Name || 
                               `Candidate #${candidate.ID}`);
                
                let displayTitle = jobTitle;
                if (searchTerm) {
                    displayTitle = highlightSearchTerms(jobTitle, searchTerm);
                }
                
                const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                const salary = formatSalaryExact(candidate["What are your salary expectations?"] || 
                                               candidate["Salary Expectations"]);
                const noticeRaw = candidate["Notice Period"];
                const notice = noticeRaw ? formatNoticePeriod(noticeRaw) : 'Unknown Notice Period';
                const activelyLooking = (candidate["Actively looking for work"] || '').toUpperCase() === 'YES';
                
                const about = candidate["About You"] || candidate.Summary || '';
                const summary = generateSummaryPreview(about);
                
                const skillsDisplay = formatSkillsDisplay(candidate["Your Skills"] || candidate.Skills || '');
                
                // Only show "Top Pick" for profiles with 85%+ completeness
                const profileScore = calculateProfileScore(candidate);
                const isTopPick = profileScore >= 85;
                const isNew = isNewCandidate(candidate);
                
                const isSelected = selectedCandidates.has(candidate.ID);
                
                return `
                    <div class="candidate-card ${isSelected ? 'selected' : ''}" 
                         id="card-${candidate.ID}">
                        <input type="checkbox" 
                               class="candidate-checkbox" 
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleCandidateSelection(${candidate.ID})"
                               onclick="event.stopPropagation()">
                        
                        ${isTopPick ? '<div class="top-pick-badge">‚≠ê Top Pick</div>' : ''}
                        ${isNew ? '<div class="new-badge">New</div>' : ''}
                        
                        ${activelyLooking ? `
                            <div style="position: absolute; top: 0.75rem; right: 0.75rem; 
                                       background: linear-gradient(135deg, var(--masters-green), var(--putting-green)); 
                                       color: white; padding: 0.2rem 0.5rem; 
                                       border-radius: 15px; font-size: 0.65rem; 
                                       font-weight: 600; text-transform: uppercase; 
                                       letter-spacing: 0.3px;">
                                Actively Looking
                            </div>
                        ` : ''}
                        
                        <div onclick='openCandidate(${JSON.stringify(candidate).replace(/'/g, "&apos;")})'
                             style="cursor: pointer; padding-left: 2rem;">
                            <h3 style="color: var(--augusta-green); margin-bottom: 0.5rem; ${activelyLooking ? 'padding-right: 140px;' : ''}">
                                ${displayTitle}
                            </h3>
                            <p style="color: var(--rough-gray); font-size: 0.9rem; margin-bottom: 1rem;">
                                ${location}
                            </p>
                            ${summary ? `<p style="margin-bottom: 1rem; font-size: 0.95rem; color: var(--pro-shop-navy);">${summary}</p>` : ''}
                            ${skillsDisplay}
                            <div style="display: flex; justify-content: space-between; align-items: center; 
                                        padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                <span style="color: var(--rough-gray); font-size: 0.9rem;">
                                    ${salary} ‚Ä¢ ${notice}
                                </span>
                                <span style="color: var(--masters-green); font-weight: 600;">View ‚Üí</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update candidate count display
        function updateCandidateCount(count) {
            const countElement = document.getElementById('candidateCount');
            if (countElement) {
                const showing = Math.min(displayedCandidates.length, count);
                if (count > candidatesPerPage && showing < count) {
                    countElement.textContent = `Showing ${showing} of ${count} candidates`;
                } else {
                    countElement.textContent = count > 0 ? `Showing ${count} candidate${count !== 1 ? 's' : ''}` : '';
                }
            }
        }

        // Apply filters with automatic update
        function applyFilters() {
            searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const salaryFilter = document.getElementById('salaryFilter').value;
            const noticeFilter = document.getElementById('noticeFilter').value;
            const lookingFilter = document.getElementById('lookingFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            let filtered = [...allCandidates];
            
            if (searchTerm) {
                filtered = filtered.filter(c => 
                    (c.Name || '').toLowerCase().includes(searchTerm) ||
                    (c["Current Job Title"] || '').toLowerCase().includes(searchTerm) ||
                    (c["Town/City"] || '').toLowerCase().includes(searchTerm) ||
                    (c["Your Skills"] || '').toLowerCase().includes(searchTerm) ||
                    (c["About You"] || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (salaryFilter) {
                filtered = filtered.filter(c => {
                    const salary = parseFloat(c["What are your salary expectations?"]) || 0;
                    if (salaryFilter === '70000+') return salary >= 70000;
                    const [min, max] = salaryFilter.split('-').map(Number);
                    return salary >= min && salary <= max;
                });
            }
            
            if (noticeFilter) {
                filtered = filtered.filter(c => {
                    const notice = (c["Notice Period"] || '').toLowerCase();
                    return notice.includes(noticeFilter.toLowerCase());
                });
            }
            
            if (lookingFilter) {
                filtered = filtered.filter(c => 
                    (c["Actively looking for work"] || '').toUpperCase() === lookingFilter
                );
            }
            
            if (categoryFilter) {
                filtered = filtered.filter(c => {
                    const jobTitle = c["Current Job Title"] || c["Job Title"] || '';
                    return detectJobCategory(jobTitle) === categoryFilter;
                });
            }
            
            if (selectedLocations.size > 0) {
                filtered = filtered.filter(c => {
                    const location = cleanAndFormatLocation(c["Town/City"], c.Country);
                    return selectedLocations.has(location);
                });
            }
            
            filteredCandidates = filtered;
            currentPage = 0;
            displayCandidatesPage();
            
            const url = new URL(window.location);
            if (searchTerm) {
                url.searchParams.set('search', searchTerm);
            } else {
                url.searchParams.delete('search');
            }
            window.history.pushState({}, '', url);
        }

        // Apply sort
        function applySort() {
            const sortValue = document.getElementById('sortSelect').value;
            
            switch (sortValue) {
                case 'relevance':
                    filteredCandidates.sort((a, b) => calculateProfileScore(b) - calculateProfileScore(a));
                    break;
                case 'newest':
                    filteredCandidates.sort((a, b) => {
                        const dateA = new Date(a.created_at || 0);
                        const dateB = new Date(b.created_at || 0);
                        return dateB - dateA;
                    });
                    break;
                case 'salary-high':
                    filteredCandidates.sort((a, b) => {
                        const salaryA = parseFloat(a["What are your salary expectations?"]) || 0;
                        const salaryB = parseFloat(b["What are your salary expectations?"]) || 0;
                        return salaryB - salaryA;
                    });
                    break;
                case 'salary-low':
                    filteredCandidates.sort((a, b) => {
                        const salaryA = parseFloat(a["What are your salary expectations?"]) || 0;
                        const salaryB = parseFloat(b["What are your salary expectations?"]) || 0;
                        return salaryA - salaryB;
                    });
                    break;
            }
            
            currentPage = 0;
            displayCandidatesPage();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('salaryFilter').value = '';
            document.getElementById('noticeFilter').value = '';
            document.getElementById('lookingFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            clearAllLocations();
            searchTerm = '';
            filteredCandidates = [...allCandidates];
            currentPage = 0;
            displayCandidatesPage();
            
            const url = new URL(window.location);
            url.searchParams.delete('search');
            window.history.pushState({}, '', url);
        }

        // Bulk selection functions
        function toggleCandidateSelection(candidateId) {
            if (selectedCandidates.has(candidateId)) {
                selectedCandidates.delete(candidateId);
                const card = document.getElementById(`card-${candidateId}`);
                if (card) card.classList.remove('selected');
            } else {
                selectedCandidates.add(candidateId);
                const card = document.getElementById(`card-${candidateId}`);
                if (card) card.classList.add('selected');
            }
        }

        function selectAll() {
            displayedCandidates.forEach(candidate => {
                selectedCandidates.add(candidate.ID);
                const card = document.getElementById(`card-${candidate.ID}`);
                if (card) {
                    card.classList.add('selected');
                    const checkbox = card.querySelector('.candidate-checkbox');
                    if (checkbox) checkbox.checked = true;
                }
            });
        }

        function deselectAll() {
            selectedCandidates.clear();
            document.querySelectorAll('.candidate-card').forEach(card => {
                card.classList.remove('selected');
                const checkbox = card.querySelector('.candidate-checkbox');
                if (checkbox) checkbox.checked = false;
            });
        }

        // FIXED: Bulk Add to Shortlist
        async function bulkAddToShortlist() {
            if (selectedCandidates.size === 0) {
                alert('Please select candidates first');
                return;
            }
            
            let added = 0;
            let skipped = 0;
            
            for (const candidateId of selectedCandidates) {
                // Check if already in shortlist
                const existing = shortlist.find(item => item.candidate_id === candidateId);
                if (existing) {
                    skipped++;
                    continue;
                }
                
                const { data, error } = await supabase
                    .from('shortlists')
                    .insert({
                        user_id: currentUser.id,
                        candidate_id: candidateId
                    })
                    .select();
                
                if (!error && data) {
                    added++;
                }
            }
            
            let message = `Added ${added} candidates to shortlist.`;
            if (skipped > 0) message += ` ${skipped} already in shortlist.`;
            
            alert(message);
            deselectAll();
            
            // Refresh shortlist
            await refreshShortlist();
        }

        // Export functions
        function exportCandidates() {
            const toExport = selectedCandidates.size > 0 ? 
                filteredCandidates.filter(c => selectedCandidates.has(c.ID)) : 
                filteredCandidates;
            
            if (toExport.length === 0) {
                alert('No candidates to export');
                return;
            }
            
            let csv = 'Job Title,Location,Salary Expectations,Notice Period,Actively Looking,Match Quality\n';
            
            toExport.forEach(candidate => {
                const jobTitle = candidate["Current Job Title"] || candidate["Job Title"] || '';
                const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                const salary = candidate["What are your salary expectations?"] || 'Negotiable';
                const notice = candidate["Notice Period"] || 'Unknown';
                const looking = candidate["Actively looking for work"] || 'Unknown';
                const score = calculateProfileScore(candidate).toFixed(0);
                
                csv += `"${jobTitle}","${location}","${salary}","${notice}","${looking}","${score}%"\n`;
            });
            
            downloadCSV(csv, 'candidates_export.csv');
        }

        function exportShortlist() {
            if (shortlist.length === 0) {
                alert('No candidates in shortlist');
                return;
            }
            
            let csv = 'Job Title,Location,Salary Expectations,Notice Period,Notes\n';
            
            shortlist.forEach(item => {
                const candidate = item.candidates;
                if (!candidate) return;
                
                const jobTitle = candidate["Current Job Title"] || candidate["Job Title"] || '';
                const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                const salary = candidate["What are your salary expectations?"] || 'Negotiable';
                const notice = candidate["Notice Period"] || 'Unknown';
                const notes = candidateNotes[candidate.ID] || '';
                
                csv += `"${jobTitle}","${location}","${salary}","${notice}","${notes}"\n`;
            });
            
            downloadCSV(csv, 'shortlist_export.csv');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Search functionality with debounce
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', applyFiltersDebounced);
            }
            
            // Auto-apply filters on change
            ['salaryFilter', 'noticeFilter', 'lookingFilter', 'categoryFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', applyFiltersDebounced);
                }
            });
        });

        // Open candidate modal with messaging
        async function openCandidate(candidate) {
            currentCandidate = candidate;
            
            const jobTitle = toTitleCase(candidate["Current Job Title"] || 
                           candidate["Job Title"] || 
                           candidate.Name || 
                           `Candidate #${candidate.ID}`);
            
            const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
            const aboutRaw = candidate["About You"] || candidate.Summary || 'No summary provided';
            
            const profileScore = calculateProfileScore(candidate);
            const isTopPick = profileScore >= 85;
            
            // Check if conversation exists
            const hasConversation = conversations[candidate.ID]?.messages?.length > 0;
            const creditCostElement = document.getElementById('creditCost');
            creditCostElement.textContent = hasConversation ? '(Free)' : '(1 Credit)';
            
            // Show previous messages if they exist
            const previousMessagesDiv = document.getElementById('previousMessages');
            if (hasConversation) {
                previousMessagesDiv.style.display = 'block';
                previousMessagesDiv.innerHTML = conversations[candidate.ID].messages.map(msg => `
                    <div class="message ${msg.from === 'employer' ? 'sent' : 'received'}">
                        ${msg.text}
                        <div class="message-time">${new Date(msg.timestamp).toLocaleString()}</div>
                    </div>
                `).join('');
                previousMessagesDiv.scrollTop = previousMessagesDiv.scrollHeight;
            } else {
                previousMessagesDiv.style.display = 'none';
            }
            
            // Create expandable summary with line breaks
            let aboutHtml = '';
            const formattedAbout = formatWithLineBreaks(aboutRaw);
            if (aboutRaw.length > 300) {
                aboutHtml = `
                    <div id="summaryContainer">
                        <p id="summaryText" class="expandable-text collapsed" style="line-height: 1.8;">
                            ${formattedAbout}
                        </p>
                        <span class="show-more-btn" onclick="toggleSummary()">Show More</span>
                    </div>
                `;
            } else {
                aboutHtml = `<p style="line-height: 1.8;">${formattedAbout}</p>`;
            }
            
            const skillsString = candidate["Your Skills"] || candidate.Skills || '';
            let skillsHtml = '';
            
            if (skillsString) {
                if (skillsString.includes('‚Ä¢') || skillsString.includes('‚Äì')) {
                    const bulletPoints = skillsString.split(/[‚Ä¢‚Äì-]/).map(s => s.trim()).filter(s => s && s.length > 3);
                    skillsHtml = `
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Skills & Expertise</h3>
                            <ul style="margin-left: 1.5rem; line-height: 1.8;">
                                ${bulletPoints.map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    skillsHtml = `
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Skills & Expertise</h3>
                            <p style="line-height: 1.6;">${skillsString}</p>
                        </div>
                    `;
                }
            }
            
            const noticeRaw = candidate["Notice Period"];
            const notice = noticeRaw ? formatNoticePeriod(noticeRaw) : 'Unknown Notice Period';
            const salary = formatSalaryExact(candidate["What are your salary expectations?"] || 
                                           candidate["Salary Expectations"]);
            const activelyLooking = candidate["Actively looking for work"] || 'Not specified';
            
            document.getElementById('modalTitle').innerHTML = `
                ${jobTitle}
                ${isTopPick ? `
                    <span class="tooltip" style="margin-left: 1rem;">
                        <span class="top-pick-badge" style="position: static; display: inline-block;">
                            ‚≠ê Top Pick
                        </span>
                        <span class="tooltiptext">Match quality: ${profileScore.toFixed(0)}%</span>
                    </span>
                ` : ''}
            `;
            
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Professional Summary</h3>
                    ${aboutHtml}
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Key Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                                Location
                            </div>
                            <div style="font-weight: 600;">${location}</div>
                        </div>
                        <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                                Salary Expectations
                            </div>
                            <div style="font-weight: 600;">${salary}</div>
                        </div>
                        <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                                Notice Period
                            </div>
                            <div style="font-weight: 600;">${notice}</div>
                        </div>
                        <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                                Actively Looking
                            </div>
                            <div style="font-weight: 600;">${activelyLooking}</div>
                        </div>
                    </div>
                </div>
                
                ${skillsHtml}
            `;
            
            // Load saved notes
            const notes = candidateNotes[candidate.ID] || '';
            document.getElementById('candidateNotes').value = notes;
            
            document.getElementById('candidateModal').classList.add('active');
        }

        function toggleSummary() {
            const summaryText = document.getElementById('summaryText');
            const btn = document.querySelector('.show-more-btn');
            
            if (summaryText.classList.contains('collapsed')) {
                summaryText.classList.remove('collapsed');
                summaryText.style.maxHeight = 'none';
                btn.textContent = 'Show Less';
            } else {
                summaryText.classList.add('collapsed');
                btn.textContent = 'Show More';
            }
        }

        // Notes functions
        function saveNotes() {
            if (!currentCandidate) return;
            
            const notes = document.getElementById('candidateNotes').value;
            candidateNotes[currentCandidate.ID] = notes;
            
            // Save to localStorage
            localStorage.setItem('candidateNotes_' + currentUser.id, JSON.stringify(candidateNotes));
            
            alert('Notes saved!');
        }

        // NEW: Send message function with confirmation
        async function sendMessage() {
            if (!currentCandidate) return;
            
            const messageText = document.getElementById('messageText').value.trim();
            if (!messageText) {
                alert('Please enter a message');
                return;
            }
            
            // Store message temporarily for confirmation
            window.pendingMessage = messageText;
            
            // Check if this is the first message to this candidate
            const isFirstMessage = !conversations[currentCandidate.ID]?.messages?.length;
            
            if (isFirstMessage) {
                // Show confirmation dialog for first message
                if (userProfile.credits < 1) {
                    alert('Insufficient credits! Contact graham@golf-jobs.com to purchase more.');
                    return;
                }
                
                document.getElementById('currentCreditsMsg').textContent = userProfile.credits;
                document.getElementById('afterCreditsMsg').textContent = userProfile.credits - 1;
                document.getElementById('messageConfirmationDialog').classList.add('active');
                document.getElementById('messageDialogOverlay').classList.add('active');
            } else {
                // Send directly if it's a follow-up message (free)
                await processMessage();
            }
        }

        function cancelMessage() {
            document.getElementById('messageConfirmationDialog').classList.remove('active');
            document.getElementById('messageDialogOverlay').classList.remove('active');
            window.pendingMessage = null;
        }

        async function confirmMessage() {
            document.getElementById('messageConfirmationDialog').classList.remove('active');
            document.getElementById('messageDialogOverlay').classList.remove('active');
            await processMessage();
        }

        async function processMessage() {
            if (!currentCandidate || !window.pendingMessage) return;
            
            const messageText = window.pendingMessage;
            const isFirstMessage = !conversations[currentCandidate.ID]?.messages?.length;
            
            // If first message, deduct credit
            if (isFirstMessage) {
                const { error } = await supabase
                    .from('users')
                    .update({ credits: userProfile.credits - 1 })
                    .eq('id', currentUser.id);
                
                if (error) {
                    alert('Error processing message. Please try again.');
                    return;
                }
                
                userProfile.credits--;
                document.getElementById('creditsCount').textContent = userProfile.credits;
            }
            
            // Save message to conversations
            if (!conversations[currentCandidate.ID]) {
                conversations[currentCandidate.ID] = {
                    candidateId: currentCandidate.ID,
                    candidateName: currentCandidate["Current Job Title"] || currentCandidate.Name,
                    messages: []
                };
            }
            
            const message = {
                from: 'employer',
                text: messageText,
                timestamp: new Date().toISOString()
            };
            
            conversations[currentCandidate.ID].messages.push(message);
            
            // Save to localStorage
            localStorage.setItem('conversations_' + currentUser.id, JSON.stringify(conversations));
            
            // Also save to Supabase for admin visibility
            try {
                await supabase.from('messages').insert({
                    employer_id: currentUser.id,
                    employer_email: currentUser.email,
                    candidate_id: currentCandidate.ID,
                    candidate_name: currentCandidate["Current Job Title"] || currentCandidate.Name,
                    message_text: messageText,
                    is_first_message: isFirstMessage,
                    credit_used: isFirstMessage ? 1 : 0,
                    created_at: new Date().toISOString()
                });
            } catch (err) {
                console.log('Message saved locally but not to database:', err);
                // Continue even if database save fails
            }
            
            // Clear the message textarea and pending message
            document.getElementById('messageText').value = '';
            window.pendingMessage = null;
            
            // Update the UI
            const previousMessagesDiv = document.getElementById('previousMessages');
            previousMessagesDiv.style.display = 'block';
            previousMessagesDiv.innerHTML = conversations[currentCandidate.ID].messages.map(msg => `
                <div class="message ${msg.from === 'employer' ? 'sent' : 'received'}">
                    ${msg.text}
                    <div class="message-time">${new Date(msg.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
            previousMessagesDiv.scrollTop = previousMessagesDiv.scrollHeight;
            
            // Update credit cost display
            document.getElementById('creditCost').textContent = '(Free)';
            
            alert('Message sent successfully! The candidate will be notified.');
        }

        // Close modal
        function closeModal() {
            document.getElementById('candidateModal').classList.remove('active');
        }

        // FIXED: Add to shortlist
        async function addToShortlist() {
            if (!currentCandidate) return;
            
            // Check if already in shortlist
            const existing = shortlist.find(item => item.candidate_id === currentCandidate.ID);
            if (existing) {
                alert('This candidate is already in your shortlist');
                return;
            }
            
            const { data, error } = await supabase
                .from('shortlists')
                .insert({
                    user_id: currentUser.id,
                    candidate_id: currentCandidate.ID
                })
                .select();
            
            if (error) {
                console.error('Error adding to shortlist:', error);
                alert('Error adding to shortlist. Please try again.');
                return;
            }
            
            alert('Added to shortlist!');
            closeModal();
            
            // Refresh shortlist
            await refreshShortlist();
        }

        // Load shortlist  
        async function loadShortlist() {
            const content = document.getElementById('shortlistContent');
            
            // Ensure we have fresh shortlist data
            await refreshShortlist();
            
            if (!shortlist || shortlist.length === 0) {
                content.innerHTML = `
                    <div class="section-box" style="text-align: center;">
                        <h2>No candidates saved yet</h2>
                        <p style="color: var(--rough-gray); margin-bottom: 1rem;">Browse talent pools and save candidates you're interested in.</p>
                        <button class="btn btn-primary" onclick="switchView('pools')">Browse Talent Pools</button>
                    </div>
                `;
                return;
            }
            
            // Debug: Check what's in shortlist
            console.log('Shortlist items:', shortlist);
            
            content.innerHTML = '<div class="candidates-grid" id="shortlistGrid"></div>';
            const grid = document.getElementById('shortlistGrid');
            
            const cardHtml = shortlist.map(item => {
                const candidate = item.candidates;
                if (!candidate) {
                    console.log('No candidate data for shortlist item:', item);
                    return '';
                }
                
                const jobTitle = toTitleCase(candidate["Current Job Title"] || 
                               candidate["Job Title"] || 
                               candidate.Name || 
                               `Candidate #${candidate.ID}`);
                
                const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                const salary = formatSalaryExact(candidate["What are your salary expectations?"] || 
                                               candidate["Salary Expectations"]);
                const noticeRaw = candidate["Notice Period"];
                const notice = noticeRaw ? formatNoticePeriod(noticeRaw) : 'Unknown Notice Period';
                const activelyLooking = (candidate["Actively looking for work"] || '').toUpperCase() === 'YES';
                
                const about = candidate["About You"] || candidate.Summary || '';
                const summary = generateSummaryPreview(about);
                
                const skillsDisplay = formatSkillsDisplay(candidate["Your Skills"] || candidate.Skills || '');
                
                const profileScore = calculateProfileScore(candidate);
                const isTopPick = profileScore >= 85;
                const isNew = isNewCandidate(candidate);
                const notes = candidateNotes[candidate.ID] || '';
                
                return `
                    <div class="candidate-card" style="position: relative;">
                        <button onclick="removeFromShortlist(${item.id})" 
                                style="position: absolute; top: 1rem; right: 1rem; 
                                       background: #fee; color: var(--hazard-red); 
                                       border: none; padding: 0.5rem 1rem; 
                                       border-radius: 8px; cursor: pointer; z-index: 10;
                                       font-size: 0.85rem;">
                            Remove
                        </button>
                        
                        ${isTopPick ? '<div class="top-pick-badge">‚≠ê Top Pick</div>' : ''}
                        ${isNew ? '<div class="new-badge">New</div>' : ''}
                        
                        ${activelyLooking ? `
                            <div style="position: absolute; top: 0.75rem; left: 0.75rem; 
                                       background: linear-gradient(135deg, var(--masters-green), var(--putting-green)); 
                                       color: white; padding: 0.2rem 0.5rem; 
                                       border-radius: 15px; font-size: 0.65rem; 
                                       font-weight: 600; text-transform: uppercase; 
                                       letter-spacing: 0.3px;">
                                Actively Looking
                            </div>
                        ` : ''}
                        
                        <div onclick='openCandidate(${JSON.stringify(candidate).replace(/'/g, "&apos;")})'
                             style="cursor: pointer;">
                            <h3 style="color: var(--augusta-green); margin-bottom: 0.5rem; padding-right: 80px;">
                                ${jobTitle}
                            </h3>
                            <p style="color: var(--rough-gray); font-size: 0.9rem; margin-bottom: 1rem;">
                                ${location}
                            </p>
                            ${summary ? `<p style="margin-bottom: 1rem; font-size: 0.95rem; color: var(--pro-shop-navy);">${summary}</p>` : ''}
                            ${skillsDisplay}
                            ${notes ? `
                                <div style="background: #fffef5; border-left: 3px solid var(--club-gold); 
                                           padding: 0.5rem; margin: 0.75rem 0; border-radius: 4px;">
                                    <p style="font-size: 0.85rem; color: var(--club-gold); margin: 0;">
                                        üìù Note: ${notes.substring(0, 100)}${notes.length > 100 ? '...' : ''}
                                    </p>
                                </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; align-items: center; 
                                        padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                <span style="color: var(--rough-gray); font-size: 0.9rem;">
                                    ${salary} ‚Ä¢ ${notice}
                                </span>
                                <span style="color: var(--masters-green); font-weight: 600;">View ‚Üí</span>
                            </div>
                        </div>
                    </div>
                `;
            }).filter(html => html !== '').join('');
            
            if (cardHtml) {
                grid.innerHTML = cardHtml;
            } else {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                        <p style="color: var(--rough-gray);">Error loading shortlist candidates. Please refresh the page.</p>
                    </div>
                `;
            }
        }

        async function removeFromShortlist(shortlistId) {
            if (!confirm('Remove this candidate from your shortlist?')) return;
            
            const { error } = await supabase
                .from('shortlists')
                .delete()
                .eq('id', shortlistId);
            
            if (!error) {
                await refreshShortlist();
                loadShortlist();
            }
        }

        function updateShortlistBadge() {
            const badge = document.getElementById('shortlistBadge');
            if (shortlist.length > 0) {
                badge.style.display = 'inline';
                badge.textContent = shortlist.length;
            } else {
                badge.style.display = 'none';
            }
        }

        // NEW: Load messages view
        function loadMessages() {
            const content = document.getElementById('conversationsList');
            
            const conversationsList = Object.values(conversations);
            
            if (conversationsList.length === 0) {
                content.innerHTML = `
                    <div class="section-box" style="text-align: center;">
                        <h2>No messages yet</h2>
                        <p style="color: var(--rough-gray); margin-bottom: 1rem;">Start a conversation by messaging candidates from their profile.</p>
                        <button class="btn btn-primary" onclick="switchView('pools')">Browse Candidates</button>
                    </div>
                `;
            } else {
                content.innerHTML = conversationsList.map(conv => {
                    const lastMessage = conv.messages[conv.messages.length - 1];
                    return `
                        <div class="section-box" style="cursor: pointer;" onclick="openConversation('${conv.candidateId}')">
                            <h3 style="color: var(--augusta-green);">${conv.candidateName}</h3>
                            <p style="color: var(--rough-gray);">Last message: ${lastMessage.text.substring(0, 100)}...</p>
                            <p style="font-size: 0.85rem; color: var(--rough-gray);">${new Date(lastMessage.timestamp).toLocaleString()}</p>
                        </div>
                    `;
                }).join('');
            }
        }

        // NEW: Open conversation
        async function openConversation(candidateId) {
            // Find the candidate data
            let candidate = allCandidates.find(c => c.ID == candidateId);
            
            if (!candidate) {
                // Try to fetch from database if not in current pool
                const { data } = await supabase
                    .from('candidates')
                    .select('*')
                    .eq('ID', candidateId)
                    .single();
                
                if (data) {
                    candidate = data;
                }
            }
            
            if (candidate) {
                openCandidate(candidate);
            }
        }

        async function loadAccount() {
            document.getElementById('accountName').textContent = userProfile?.name || '-';
            document.getElementById('accountEmail').textContent = currentUser?.email || '-';
            document.getElementById('accountCredits').textContent = userProfile?.credits || 0;
            
            // Count total messages sent
            let totalMessages = 0;
            Object.values(conversations).forEach(conv => {
                totalMessages += conv.messages.filter(m => m.from === 'employer').length;
            });
            document.getElementById('totalMessages').textContent = totalMessages;
            
            // Load credits history (messages that cost credits)
            const historyDiv = document.getElementById('creditsHistory');
            
            // Get first messages from each conversation
            const creditMessages = [];
            Object.values(conversations).forEach(conv => {
                if (conv.messages.length > 0) {
                    const firstMessage = conv.messages[0];
                    if (firstMessage.from === 'employer') {
                        creditMessages.push({
                            candidateName: conv.candidateName,
                            timestamp: firstMessage.timestamp
                        });
                    }
                }
            });
            
            if (creditMessages.length > 0) {
                historyDiv.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb;">
                                <th style="padding: 0.5rem; text-align: left;">Date</th>
                                <th style="padding: 0.5rem; text-align: left;">Candidate</th>
                                <th style="padding: 0.5rem; text-align: left;">Credits</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${creditMessages.map(msg => `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 0.5rem;">${new Date(msg.timestamp).toLocaleDateString()}</td>
                                    <td style="padding: 0.5rem;">${msg.candidateName}</td>
                                    <td style="padding: 0.5rem;">-1</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                historyDiv.innerHTML = '<p style="text-align: center; color: var(--rough-gray);">No credit history yet.</p>';
            }
        }

        async function loadAdmin() {
            const { data: allUsers } = await supabase
                .from('users')
                .select('*')
                .order('created_at', { ascending: false });
            
            const usersList = document.getElementById('adminUsersList');
            if (allUsers && allUsers.length > 0) {
                usersList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb;">
                                <th style="padding: 1rem; text-align: left;">Name</th>
                                <th style="padding: 1rem; text-align: left;">Email</th>
                                <th style="padding: 1rem; text-align: left;">Role</th>
                                <th style="padding: 1rem; text-align: left;">Credits</th>
                                <th style="padding: 1rem; text-align: left;">Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allUsers.map(user => `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 1rem;">${user.name || 'Not set'}</td>
                                    <td style="padding: 1rem;">${user.email}</td>
                                    <td style="padding: 1rem;">${user.role || 'viewer'}</td>
                                    <td style="padding: 1rem;">${user.credits || 0}</td>
                                    <td style="padding: 1rem;">${new Date(user.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                usersList.innerHTML = '<p style="text-align: center; color: var(--rough-gray);">No users found.</p>';
            }
            
            // Load ALL messages from database for admin visibility
            const messagesList = document.getElementById('adminMessagesList');
            
            // Fetch messages from Supabase
            const { data: allMessages } = await supabase
                .from('messages')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(100);
            
            if (allMessages && allMessages.length > 0) {
                // Group messages by conversation
                const conversationGroups = {};
                allMessages.forEach(msg => {
                    const key = `${msg.employer_id}_${msg.candidate_id}`;
                    if (!conversationGroups[key]) {
                        conversationGroups[key] = {
                            employer_id: msg.employer_id,
                            employer_email: msg.employer_email,
                            candidate_id: msg.candidate_id,
                            candidate_name: msg.candidate_name,
                            messages: []
                        };
                    }
                    conversationGroups[key].messages.push(msg);
                });
                
                messagesList.innerHTML = `
                    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="color: #856404; margin: 0; font-size: 0.9rem;">
                            <strong>‚öñÔ∏è Legal Notice:</strong> All messages are monitored for quality assurance and compliance. 
                            Ensure your privacy policy and terms of service clearly state that messages may be reviewed by administrators.
                            Consider local data protection laws (GDPR, etc.) before implementing message monitoring.
                        </p>
                    </div>
                    <h3 style="margin-bottom: 1rem; color: var(--augusta-green);">Recent Message Threads (Click to View Full Thread)</h3>
                    <div style="display: grid; gap: 1rem;">
                        ${Object.values(conversationGroups).map(conv => {
                            const latestMsg = conv.messages[0];
                            const totalCreditsUsed = conv.messages.filter(m => m.is_first_message).length;
                            return `
                                <div class="section-box" style="cursor: pointer; background: white; padding: 1.5rem; border-radius: 12px; 
                                                                box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease;"
                                     onclick="viewAdminMessageThread('${conv.employer_id}', ${conv.candidate_id}, '${conv.employer_email}', '${conv.candidate_name}')"
                                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.12)';"
                                     onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)';">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                                        <div>
                                            <h4 style="color: var(--augusta-green); margin: 0;">
                                                <strong>Employer:</strong> ${conv.employer_email}
                                            </h4>
                                            <p style="color: var(--rough-gray); margin: 0.25rem 0; font-size: 0.9rem;">
                                                <strong>User ID:</strong> ${conv.employer_id}
                                            </p>
                                        </div>
                                        <div style="text-align: right;">
                                            <p style="color: var(--masters-green); margin: 0; font-weight: 600;">
                                                Candidate: ${conv.candidate_name}
                                            </p>
                                            <p style="color: var(--rough-gray); margin: 0.25rem 0; font-size: 0.9rem;">
                                                <strong>Candidate ID:</strong> #${conv.candidate_id}
                                            </p>
                                        </div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                        <p style="margin: 0; font-size: 0.9rem; color: #333;">
                                            <strong>Latest:</strong> "${latestMsg.message_text.substring(0, 150)}${latestMsg.message_text.length > 150 ? '...' : ''}"
                                        </p>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.85rem; color: var(--rough-gray);">
                                            ${new Date(latestMsg.created_at).toLocaleString()}
                                        </span>
                                        <div>
                                            <span style="background: #e9ecef; padding: 0.25rem 0.75rem; border-radius: 12px; 
                                                       font-size: 0.85rem; margin-right: 0.5rem;">
                                                ${conv.messages.length} message${conv.messages.length !== 1 ? 's' : ''}
                                            </span>
                                            <span style="background: ${totalCreditsUsed > 0 ? '#ffc107' : '#e9ecef'}; 
                                                       color: ${totalCreditsUsed > 0 ? '#000' : '#6c757d'}; 
                                                       padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">
                                                ${totalCreditsUsed} credit${totalCreditsUsed !== 1 ? 's' : ''} used
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                // If no messages in database, show local messages with notice
                const allConversations = [];
                Object.values(conversations).forEach(conv => {
                    conv.messages.forEach(msg => {
                        if (msg.from === 'employer') {
                            allConversations.push({
                                employer: currentUser.email,
                                employer_id: currentUser.id,
                                candidate: conv.candidateName,
                                candidate_id: conv.candidateId,
                                message: msg.text,
                                timestamp: msg.timestamp,
                                isFirst: conv.messages.indexOf(msg) === 0
                            });
                        }
                    });
                });
                
                if (allConversations.length > 0) {
                    messagesList.innerHTML = `
                        <div style="background: #f8d7da; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="color: #721c24; margin: 0; font-size: 0.9rem;">
                                <strong>‚ö†Ô∏è Database Setup Required:</strong> Messages are currently stored locally only. 
                                To enable full admin visibility across all users, create a 'messages' table in Supabase with columns:
                                employer_id, employer_email, candidate_id, candidate_name, message_text, is_first_message, credit_used, created_at
                            </p>
                        </div>
                        <h3 style="margin-bottom: 1rem; color: var(--augusta-green);">Local Messages (Current Session Only)</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb;">
                                    <th style="padding: 1rem; text-align: left;">Date</th>
                                    <th style="padding: 1rem; text-align: left;">Employer</th>
                                    <th style="padding: 1rem; text-align: left;">Employer ID</th>
                                    <th style="padding: 1rem; text-align: left;">Candidate</th>
                                    <th style="padding: 1rem; text-align: left;">Candidate ID</th>
                                    <th style="padding: 1rem; text-align: left;">Message</th>
                                    <th style="padding: 1rem; text-align: left;">Credits</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allConversations.map(msg => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 0.75rem; font-size: 0.85rem;">${new Date(msg.timestamp).toLocaleString()}</td>
                                        <td style="padding: 0.75rem; font-size: 0.85rem;">${msg.employer}</td>
                                        <td style="padding: 0.75rem; font-size: 0.85rem; font-family: monospace;">${msg.employer_id.substring(0, 8)}...</td>
                                        <td style="padding: 0.75rem; font-size: 0.85rem;">${msg.candidate}</td>
                                        <td style="padding: 0.75rem; font-size: 0.85rem;">#${msg.candidate_id}</td>
                                        <td style="padding: 0.75rem; font-size: 0.85rem;">${msg.message.substring(0, 100)}...</td>
                                        <td style="padding: 0.75rem; font-size: 0.85rem;">${msg.isFirst ? '1' : '0'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    messagesList.innerHTML = '<p style="text-align: center; color: var(--rough-gray);">No messages found. Messages will appear here once sent.</p>';
                }
            }
        }
        
        // Function to view full message thread in admin panel
        async function viewAdminMessageThread(employerId, candidateId, employerEmail, candidateName) {
            // Fetch all messages for this conversation
            const { data: threadMessages } = await supabase
                .from('messages')
                .select('*')
                .eq('employer_id', employerId)
                .eq('candidate_id', candidateId)
                .order('created_at', { ascending: true });
            
            if (threadMessages && threadMessages.length > 0) {
                // Create modal to show full thread
                const modalHtml = `
                    <div class="modal active" style="z-index: 3000;">
                        <div class="modal-content" style="max-width: 800px;">
                            <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                            <h2 style="color: var(--augusta-green); margin-bottom: 1rem;">Message Thread</h2>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <p style="margin: 0.25rem 0;"><strong>Employer:</strong> ${employerEmail} (ID: ${employerId})</p>
                                <p style="margin: 0.25rem 0;"><strong>Candidate:</strong> ${candidateName} (ID: #${candidateId})</p>
                                <p style="margin: 0.25rem 0;"><strong>Total Messages:</strong> ${threadMessages.length}</p>
                                <p style="margin: 0.25rem 0;"><strong>Credits Used:</strong> ${threadMessages.filter(m => m.is_first_message).length}</p>
                            </div>
                            <div class="conversation-container" style="max-height: 500px; overflow-y: auto; background: white; padding: 1rem; border-radius: 8px;">
                                ${threadMessages.map(msg => `
                                    <div class="message sent" style="margin-bottom: 1rem;">
                                        <div style="font-weight: 600; margin-bottom: 0.5rem;">
                                            Employer Message ${msg.is_first_message ? '(1 credit)' : '(free)'}
                                        </div>
                                        ${msg.message_text}
                                        <div class="message-time">${new Date(msg.created_at).toLocaleString()}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
        }

        function goHome() {
            switchView('pools');
        }

        document.getElementById('candidateModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>
</body>
</html>
