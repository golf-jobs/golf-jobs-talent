<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Jobs - Premium Talent Pools</title>

    <!-- Favicon -->
    <link rel="icon" href="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20white.png?updatedAt=1758280288759">
    <link rel="apple-touch-icon" sizes="180x180" href="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20white.png?updatedAt=1758280288759">

    <!-- Add Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --augusta-green: #004d26;
            --fairway-green: #2d5f3f;
            --masters-green: #3a7858;
            --putting-green: #6b9080;
            --club-gold: #c9a961;
            --trophy-gold: #f4d03f;
            --sand-bunker: #f5e6d3;
            --morning-mist: #f8f9fa;
            --pro-shop-navy: #1a2332;
            --scorecard-white: #ffffff;
            --rough-gray: #6c757d;
            --hazard-red: #c9302c;
            --water-hazard: #2c5aa0;
        }

        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: var(--pro-shop-navy);
            background: linear-gradient(180deg, #f8f9fa 0%, #e8efe8 100%);
            min-height: 100vh;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            height: 250px;
            border-radius: 16px;
            margin-bottom: 1.75rem;
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--augusta-green);
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 450px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-title {
            text-align: center;
            color: var(--augusta-green);
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .login-subtitle {
            text-align: center;
            color: var(--rough-gray);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--pro-shop-navy);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e1e8e4;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--masters-green);
            box-shadow: 0 0 0 3px rgba(58, 120, 88, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--masters-green) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Poppins', sans-serif;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 77, 38, 0.3);
        }

        .login-error {
            background: #fee;
            color: var(--hazard-red);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        /* Main App */
        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--fairway-green) 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
        }

        .logo img {
            height: 60px;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 0.625rem 1.25rem;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: var(--club-gold);
            color: var(--augusta-green);
            font-weight: 600;
        }

        .shortlist-badge {
            background: rgba(255,255,255,0.3);
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            margin-left: 0.25rem;
            font-size: 0.875rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 12px;
        }

        .credits-badge {
            background: linear-gradient(135deg, var(--club-gold) 0%, var(--trophy-gold) 100%);
            color: var(--augusta-green);
            padding: 0.375rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
        }

        .btn-logout {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* View Sections */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Pools Grid */
        .pools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .pool-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .pool-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .pool-card.locked {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .pool-header {
            background: linear-gradient(135deg, var(--fairway-green) 0%, var(--masters-green) 100%);
            padding: 2rem;
            color: white;
            position: relative;
        }

        .pool-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .pool-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--club-gold);
            color: var(--augusta-green);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 700;
        }

        .pool-stats {
            padding: 2rem;
        }

        .pool-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .pool-stat:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        /* Filter Panel */
        .filter-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* Sorting Bar */
        .sorting-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .sort-options {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Top Pick Badge */
        .top-pick-badge {
            position: absolute;
            top: -10px;
            right: 15px;
            background: linear-gradient(135deg, var(--club-gold) 0%, var(--trophy-gold) 100%);
            color: var(--augusta-green);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            color: var(--rough-gray);
        }

        .breadcrumb a {
            color: var(--masters-green);
            text-decoration: none;
            font-weight: 600;
        }

        .breadcrumb a:hover {
            color: var(--augusta-green);
        }

        /* Buttons */
        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--masters-green) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 77, 38, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--augusta-green);
            border: 2px solid var(--augusta-green);
        }

        .btn-secondary:hover {
            background: var(--augusta-green);
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .empty-state h3 {
            color: var(--augusta-green);
            margin-bottom: 1rem;
        }

        .empty-state p {
            color: var(--rough-gray);
            margin-bottom: 2rem;
        }

        /* Load More */
        .load-more-container {
            text-align: center;
            padding: 2rem;
        }

        .load-more-btn {
            padding: 0.875rem 2rem;
            background: white;
            color: var(--augusta-green);
            border: 2px solid var(--augusta-green);
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .load-more-btn:hover {
            background: var(--augusta-green);
            color: white;
        }

        .section-box {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .error-message {
            background: #fee;
            color: var(--hazard-red);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        /* Candidates Grid */
        .candidates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 1.75rem;
            margin-bottom: 2rem;
        }

        .candidate-card {
            background: white;
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
            position: relative;
            cursor: pointer;
        }

        .candidate-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 24px rgba(0,0,0,0.1);
            border-color: var(--masters-green);
        }

        .candidate-card.selected {
            background: #f0f8f4;
            border-color: var(--masters-green);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 35, 50, 0.95);
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background: white;
            margin: 3% auto;
            padding: 2rem;
            width: 90%;
            max-width: 700px;
            border-radius: 20px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--rough-gray);
        }

        .modal-close:hover {
            color: var(--pro-shop-navy);
        }

        /* Notes Panel */
        .notes-panel {
            background: #fffef5;
            border: 1px solid var(--club-gold);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .note-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.5rem;
            border: 1px solid #e1e8e4;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
        }

        /* Message Box */
        .message-box {
            background: #f8f9fa;
            border: 1px solid #e1e8e4;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .message-textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.75rem;
            border: 2px solid #e1e8e4;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
            font-size: 1rem;
        }

        .message-textarea:focus {
            outline: none;
            border-color: var(--masters-green);
        }

        /* Mobile Split View */
        @media (max-width: 768px) {
            .pools-grid, .candidates-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .sorting-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .modal-content {
                margin: 10% 1rem;
                width: calc(100% - 2rem);
            }
        }
        
        .mobile-back-btn {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div style="text-align: center; margin-bottom: 2rem;">
                <img src="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20black.png?updatedAt=1757017924442" alt="Golf Jobs" style="width: 200px;">
            </div>
            <h1 class="login-title">Talent Pool Access</h1>
            <p class="login-subtitle">Exclusive recruitment platform</p>
            
            <div id="loginError" class="login-error">Invalid credentials. Please try again.</div>
            
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="loginEmail" required placeholder="your@company.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn-login">Sign In</button>
            </form>
            
            <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e1e8e4;">
                <p style="color: var(--rough-gray); font-size: 0.85rem;">© 2025 Golf Jobs. Professional recruitment excellence.</p>
                <p style="margin-top: 0.5rem; color: var(--rough-gray); font-size: 0.85rem;">Need access? Contact <strong>graham@golf-jobs.com</strong></p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo" onclick="goHome()">
                    <img src="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20white.png?updatedAt=1758280288759" alt="Golf Jobs">
                </div>
                <nav class="nav-tabs">
                    <button class="nav-tab active" onclick="switchView('pools')">Talent Pools</button>
                    <button class="nav-tab" onclick="switchView('shortlist')">
                        Shortlist <span id="shortlistBadge" class="shortlist-badge" style="display: none;">0</span>
                    </button>
                    <button class="nav-tab" onclick="switchView('messages')">Messages</button>
                    <button class="nav-tab" onclick="switchView('account')">My Account</button>
                    <button id="adminTab" class="nav-tab" onclick="switchView('admin')" style="display:none;">Admin</button>
                </nav>
                <div class="user-info">
                    <span id="userName">Welcome</span>
                    <div class="credits-badge">
                        Credits: <span id="creditsCount">0</span>
                    </div>
                    <button class="btn-logout" onclick="handleLogout()">Sign Out</button>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Pools View -->
            <div id="poolsView" class="view-section active">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Your Talent Pools</h1>
                <p style="color: var(--rough-gray); margin-bottom: 2rem; font-size: 1.1rem;">Select a talent pool to browse candidates</p>
                <div class="pools-grid" id="poolsGrid">
                    <!-- Loading skeletons -->
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
            </div>

            <!-- Pool Detail View with Split Layout -->
            <div id="poolDetailView" class="view-section">
                <div class="breadcrumb">
                    <a href="#" onclick="switchView('pools')">Talent Pools</a>
                    <span>→</span>
                    <span id="currentPoolName">Pool Name</span>
                </div>
                
                <!-- Filter Panel -->
                <div class="filter-panel" id="filterPanel">
                    <input type="text" id="searchInput" placeholder="Search by name, role, skills, or location..." 
                           style="width: 100%; padding: 0.875rem; border: 2px solid #e1e8e4; border-radius: 12px; font-size: 1rem; margin-bottom: 1rem;">
                    
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-start;">
                        <select id="locationFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Locations</option>
                        </select>
                        
                        <select id="categoryFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Categories</option>
                            <option value="greenkeeping">Greenkeeping</option>
                            <option value="management">Management</option>
                            <option value="pga">PGA Professional</option>
                            <option value="marketing">Marketing</option>
                            <option value="sales">Sales</option>
                            <option value="hospitality">Hospitality</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="admin">Admin/Office</option>
                            <option value="retail">Retail/Pro Shop</option>
                            <option value="f&b">F&B/Catering</option>
                        </select>
                        
                        <select id="salaryFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Salaries</option>
                            <option value="0-30000">£20-30k</option>
                            <option value="30000-40000">£30-40k</option>
                            <option value="40000-50000">£40-50k</option>
                            <option value="50000-60000">£50-60k</option>
                            <option value="60000-70000">£60-70k</option>
                            <option value="70000+">£70k+</option>
                        </select>
                        
                        <select id="noticeFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Notice Periods</option>
                            <option value="immediately">Available Immediately</option>
                            <option value="1 week">1 Week</option>
                            <option value="1 month">1 Month</option>
                            <option value="2 months">2 Months</option>
                            <option value="3 months">3 Months</option>
                        </select>
                        
                        <select id="lookingFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">Active/Passive</option>
                            <option value="YES">Actively Looking</option>
                            <option value="NO">Not Actively Looking</option>
                        </select>
                        
                        <button onclick="clearFilters()" class="btn btn-small" style="background: #e5e7eb; color: var(--rough-gray);">
                            Clear All
                        </button>
                    </div>
                </div>
                
                <!-- Sorting Bar -->
                <div class="sorting-bar">
                    <div class="sort-options">
                        <label style="margin-right: 0.5rem; color: var(--rough-gray);">Sort by:</label>
                        <select id="sortSelect" onchange="applySort()" style="padding: 0.5rem; border: 1px solid #e1e8e4; border-radius: 8px;">
                            <option value="relevance">Best Match</option>
                            <option value="newest">Newest First</option>
                            <option value="salary-high">Salary (High to Low)</option>
                            <option value="salary-low">Salary (Low to High)</option>
                        </select>
                    </div>
                    
                    <div class="bulk-actions">
                        <button class="btn btn-small btn-secondary" onclick="selectAll()">Select All</button>
                        <button class="btn btn-small btn-secondary" onclick="deselectAll()">Clear Selection</button>
                        <button class="btn btn-small btn-primary" onclick="bulkAddToShortlist()">Add to Shortlist</button>
                    </div>
                </div>
                
                <div id="candidateCount" style="margin-bottom: 1rem; color: var(--rough-gray);"></div>
                
                <!-- Split View Container -->
                <div class="split-view-container" style="display: flex; gap: 1.5rem; height: calc(100vh - 350px); min-height: 600px;">
                    <!-- Left Panel - Candidate List -->
                    <div class="split-view-left" style="width: 40%; overflow-y: auto; padding-right: 1rem; border-right: 1px solid #e5e7eb;">
                        <div id="candidatesListView">
                            <!-- Loading skeletons -->
                            <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
                            <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
                            <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
                        </div>
                        
                        <!-- Load More -->
                        <div class="load-more-container" id="loadMoreContainer" style="display: none; padding: 1rem 0;">
                            <button class="load-more-btn" onclick="loadMore()" style="width: 100%;">Load More</button>
                        </div>
                    </div>
                    
                    <!-- Right Panel - Full Profile View -->
                    <div class="split-view-right" style="flex: 1; overflow-y: auto; padding-left: 1rem;">
                        <button class="mobile-back-btn" onclick="closeMobileProfile()">← Back to List</button>
                        <div id="profileDetailView" style="background: white; border-radius: 16px; padding: 2rem; min-height: 100%;">
                            <div style="text-align: center; color: var(--rough-gray); padding: 4rem 2rem;">
                                <h3 style="margin-bottom: 1rem;">Select a candidate</h3>
                                <p>Click on any candidate from the list to view their full profile</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shortlist View -->
            <div id="shortlistView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Your Shortlist</h1>
                <div style="margin-bottom: 2rem;">
                    <button class="btn btn-primary" onclick="exportShortlist()">Export Shortlist</button>
                </div>
                <div id="shortlistContent"></div>
            </div>

            <!-- Messages View -->
            <div id="messagesView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Messages</h1>
                <div id="conversationsList"></div>
            </div>

            <!-- Account View -->
            <div id="accountView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 2rem;">My Account</h1>
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1rem;">Account Overview</h2>
                    <p style="margin-bottom: 1rem;"><strong>Name:</strong> <span id="accountName">-</span></p>
                    <p style="margin-bottom: 1rem;"><strong>Email:</strong> <span id="accountEmail">-</span></p>
                    <p style="margin-bottom: 1rem;"><strong>Credits Balance:</strong> <span id="accountCredits">0</span></p>
                    <p><strong>Total Messages Sent:</strong> <span id="totalMessages">0</span></p>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 2rem;">Admin Dashboard</h1>
                <div id="adminContent"></div>
            </div>
        </div>
    </div>

    <!-- Candidate Modal -->
    <div id="candidateModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">×</button>
            <h2 id="modalTitle" style="color: var(--augusta-green); margin-bottom: 1rem;"></h2>
            <div id="modalBody"></div>
            
            <!-- Notes Section -->
            <div class="notes-panel">
                <h4 style="color: var(--augusta-green); margin-bottom: 0.5rem;">📝 Private Notes</h4>
                <textarea class="note-textarea" id="candidateNotes" placeholder="Add your notes about this candidate..."></textarea>
                <button class="btn btn-small" onclick="saveNotes()" style="margin-top: 0.5rem;">Save Notes</button>
            </div>
            
            <!-- Message Section -->
            <div class="message-box">
                <h4 style="color: var(--augusta-green); margin-bottom: 0.5rem;">💬 Send Message</h4>
                <p style="font-size: 0.85rem; color: var(--rough-gray); margin-bottom: 0.5rem;">
                    First message to this candidate will use 1 credit. Follow-up messages are free.
                </p>
                <textarea class="message-textarea" id="messageText" 
                          placeholder="Introduce yourself and explain why you're interested in this candidate..."></textarea>
                <button class="btn btn-primary btn-small" onclick="sendMessage()" style="margin-top: 0.5rem;">
                    Send Message <span id="creditCost"></span>
                </button>
            </div>
            
            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="addToShortlist()">Save to Shortlist</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://kbadedwbcjetxiertztv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtiYWRlZHdiY2pldHhpZXJ0enR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDAyNDMsImV4cCI6MjA3Mzg3NjI0M30.igm3XjM8l1OXfilQaAHtmJyCDe9eXILV_P9B3_sUzwg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state
        let currentUser = null;
        let currentPool = null;
        let currentCandidate = null;
        let userProfile = null;
        let userPools = [];
        let shortlist = [];
        let allCandidates = [];
        let filteredCandidates = [];
        let displayedCandidates = [];
        let selectedCandidates = new Set();
        let candidateNotes = {};
        let conversations = {};
        let currentPage = 0;
        const candidatesPerPage = 20;

        // Utility functions
        function toTitleCase(str) {
            if (!str) return str;
            
            const acronyms = ['UK', 'USA', 'US', 'CEO', 'CFO', 'COO', 'CTO', 'PGA', 'HR', 'IT', 'F&B'];
            
            return str.toLowerCase().split(/(\s+|-)/).map(word => {
                const cleanWord = word.replace(/[.,;:!?]/g, '');
                const upperClean = cleanWord.toUpperCase();
                
                if (acronyms.includes(upperClean)) {
                    return word.replace(cleanWord, upperClean);
                }
                
                if (word.length > 0) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }
                return word;
            }).join('');
        }

        function cleanAndFormatLocation(townCity, country) {
            const excludeTerms = ['England', 'United Kingdom', 'UK', 'Scotland', 'Wales', 'Northern Ireland'];
            
            let cleanedTown = townCity ? townCity.trim() : '';
            let cleanedCountry = country ? country.trim() : '';
            
            if (excludeTerms.some(term => cleanedCountry.toLowerCase() === term.toLowerCase())) {
                cleanedCountry = '';
            }
            
            if (cleanedTown) {
                return toTitleCase(cleanedTown);
            }
            
            return 'Location Not Specified';
        }

        function formatSalaryExact(salary) {
            if (!salary) return 'Salary Negotiable';
            const num = parseFloat(salary);
            if (isNaN(num)) return 'Salary Negotiable';
            return `£${num.toLocaleString()}`;
        }

        function formatNoticePeriod(notice) {
            if (!notice) return 'Unknown';
            const lowerNotice = notice.toLowerCase();
            if (lowerNotice.includes('immediately') || lowerNotice.includes('immediate')) return 'Available immediately';
            if (lowerNotice.includes('1 week')) return '1 week notice';
            if (lowerNotice.includes('2 week')) return '2 weeks notice';
            if (lowerNotice.includes('1 month')) return '1 month notice';
            if (lowerNotice.includes('2 month')) return '2 months notice';
            if (lowerNotice.includes('3 month')) return '3 months notice';
            return notice + ' notice';
        }

        // FIXED: Profile scoring function with proper weighting
        function calculateProfileScore(candidate) {
            let score = 0;
            
            // About You section (max 30 points)
            const aboutYou = candidate["About You"] || '';
            if (aboutYou.length > 200) score += 30;
            else if (aboutYou.length > 100) score += 20;
            else if (aboutYou.length > 50) score += 10;
            
            // Skills section (max 20 points)
            const skills = candidate["Your Skills"] || '';
            if (skills.length > 100) score += 20;
            else if (skills.length > 50) score += 15;
            else if (skills.length > 20) score += 10;
            
            // Job Title (10 points) - Handle float/number type
            let jobTitle = candidate["Current Job Title"] || candidate["Job Title"];
            if (typeof jobTitle === 'string' && jobTitle.trim()) score += 10;
            
            // Salary expectations (10 points)
            if (candidate["What are your salary expectations?"]) score += 10;
            
            // Notice period (10 points)
            if (candidate["Notice Period"]) score += 10;
            
            // Location (10 points)
            if (candidate["Town/City"]) score += 10;
            
            // Actively looking (10 points)
            if (candidate["Actively looking for work"]) score += 10;
            
            return score; // Out of 100
        }

        // Initialize
        window.onload = async function() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                await loadUserData(session.user);
                showApp();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
            }
        }

        // Login
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            } else {
                await loadUserData(data.user);
                showApp();
            }
        }

        // FIXED: Load user data with proper pool access
        async function loadUserData(user) {
            currentUser = user;
            
            // Load user profile
            try {
                const { data: profile } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (profile) {
                    userProfile = profile;
                    document.getElementById('userName').textContent = profile.name || user.email.split('@')[0];
                    document.getElementById('creditsCount').textContent = profile.credits || 0;
                    
                    if (profile.role === 'admin') {
                        document.getElementById('adminTab').style.display = 'block';
                    }
                } else {
                    userProfile = { id: user.id, email: user.email, credits: 0 };
                }
            } catch (err) {
                console.error('Error loading user profile:', err);
                userProfile = { id: user.id, email: user.email, credits: 0 };
            }
            
            // Load pool access
            try {
                const { data: poolAccess } = await supabase
                    .from('user_pool_access')
                    .select('pool_id')
                    .eq('user_id', user.id);
                
                userPools = poolAccess ? poolAccess.map(p => p.pool_id) : [];
                console.log('User has access to pools:', userPools);
                
                // If user has 'all' access, they can see everything
                if (userPools.includes('all')) {
                    console.log('User has access to ALL pools');
                }
            } catch (err) {
                console.error('Error loading pool access:', err);
                userPools = [];
            }
            
            await refreshShortlist();
        }

        // Refresh shortlist
        async function refreshShortlist() {
            try {
                const { data: shortlistData } = await supabase
                    .from('shortlists')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (shortlistData && shortlistData.length > 0) {
                    const candidateIds = shortlistData.map(item => item.candidate_id);
                    const { data: candidatesData } = await supabase
                        .from('candidates')
                        .select('*')
                        .in('ID', candidateIds);
                    
                    const byId = new Map((candidatesData || []).map(c => [String(c.ID), c]));
                    
                    shortlist = shortlistData.map(item => ({
                        ...item,
                        candidates: byId.get(String(item.candidate_id)) || null
                    }));
                } else {
                    shortlist = [];
                }
            } catch (err) {
                console.error('Error refreshing shortlist:', err);
                shortlist = [];
            }
            
            updateShortlistBadge();
        }

        function updateShortlistBadge() {
            const badge = document.getElementById('shortlistBadge');
            if (shortlist.length > 0) {
                badge.style.display = 'inline';
                badge.textContent = shortlist.length;
            } else {
                badge.style.display = 'none';
            }
        }

        // Show app
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
            loadPools();
        }

        // Logout
        async function handleLogout() {
            await supabase.auth.signOut();
            location.reload();
        }

        // Switch views
        function switchView(view) {
            // Clear active states
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(section => section.classList.remove('active'));
            
            // Activate new view
            const section = document.getElementById(view + 'View');
            if (section) section.classList.add('active');
            
            // Activate nav tab
            const tabBtn = document.querySelector(`.nav-tabs .nav-tab[onclick="switchView('${view}')"]`);
            if (tabBtn) tabBtn.classList.add('active');
            
            // Load view data
            if (view === 'pools') loadPools();
            else if (view === 'shortlist') loadShortlist();
            else if (view === 'messages') loadMessages();
            else if (view === 'account') loadAccount();
            else if (view === 'admin' && userProfile?.role === 'admin') loadAdmin();
        }

        // COMPLETELY FIXED: Load pools with correct counting
        async function loadPools() {
            console.log('Loading pools...');
            const poolsGrid = document.getElementById('poolsGrid');
            poolsGrid.innerHTML = `
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
            `;
            
            try {
                // Get pools WITHOUT id column (use slug as identifier)
                const { data: pools, error: poolsError } = await supabase
                    .from('talent_pools')
                    .select('slug, label, sort_order')
                    .order('sort_order', { ascending: true });
                
                if (poolsError) {
                    console.error('Error fetching pools:', poolsError);
                    poolsGrid.innerHTML = `<div class="error-message">Error loading pools: ${poolsError.message}</div>`;
                    return;
                }
                
                if (!pools || pools.length === 0) {
                    poolsGrid.innerHTML = '<div class="empty-state"><h3>No talent pools available</h3></div>';
                    return;
                }
                
                // Count candidates for each pool
                for (let pool of pools) {
                    try {
                        if (pool.slug === 'all') {
                            // Count ALL candidates for 'all' pool
                            const { count } = await supabase
                                .from('candidates')
                                .select('*', { count: 'exact', head: true });
                            pool.total_candidates = count || 0;
                        } else {
                            // Count candidates with matching pool_id
                            const { count } = await supabase
                                .from('candidates')
                                .select('*', { count: 'exact', head: true })
                                .eq('pool_id', pool.slug);
                            pool.total_candidates = count || 0;
                        }
                        console.log(`Pool ${pool.slug} has ${pool.total_candidates} candidates`);
                    } catch (err) {
                        console.warn(`Error counting for pool ${pool.slug}:`, err);
                        pool.total_candidates = 0;
                    }
                }
                
                // Render pools
                poolsGrid.innerHTML = '';
                for (const pool of pools) {
                    // Check if user has access (if they have 'all' or the specific pool)
                    const hasAccess = userPools.includes('all') || userPools.includes(pool.slug);
                    
                    const poolCard = document.createElement('div');
                    poolCard.className = hasAccess ? 'pool-card' : 'pool-card locked';
                    poolCard.innerHTML = `
                        <div class="pool-header">
                            <div class="pool-title">${pool.label}</div>
                            <div class="pool-badge">${hasAccess ? 'Available' : 'Locked'}</div>
                        </div>
                        <div class="pool-stats">
                            <div class="pool-stat">
                                <span>Total Candidates</span>
                                <span style="font-size: 1.25rem; font-weight: 700; color: var(--augusta-green);">
                                    ${pool.total_candidates}
                                </span>
                            </div>
                        </div>
                    `;
                    
                    if (hasAccess) {
                        poolCard.onclick = () => openPool(pool);
                    } else {
                        poolCard.onclick = () => alert('Contact graham@golf-jobs.com to request access to this pool.');
                    }
                    
                    poolsGrid.appendChild(poolCard);
                }
                
            } catch (err) {
                console.error('Unexpected error:', err);
                poolsGrid.innerHTML = `<div class="error-message">An error occurred: ${err.message}</div>`;
            }
        }

        // FIXED: Open pool and load candidates
        async function openPool(pool) {
            currentPool = pool;
            currentPage = 0;
            document.getElementById('currentPoolName').textContent = pool.label;
            
            const candidatesListView = document.getElementById('candidatesListView');
            candidatesListView.innerHTML = `
                <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
                <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
                <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
            `;
            
            try {
                let candidates, error;
                
                if (pool.slug === 'all') {
                    // Load ALL candidates for 'all' pool
                    const result = await supabase
                        .from('candidates')
                        .select('*');
                    candidates = result.data;
                    error = result.error;
                } else {
                    // Load candidates for specific pool
                    const result = await supabase
                        .from('candidates')
                        .select('*')
                        .eq('pool_id', pool.slug);
                    candidates = result.data;
                    error = result.error;
                }
                
                if (error) {
                    console.error('Error loading candidates:', error);
                    candidatesListView.innerHTML = `<div class="error-message">Error loading candidates</div>`;
                    return;
                }
                
                // Sort candidates by profile score (BEST PROFILES FIRST)
                allCandidates = (candidates || []).sort((a, b) => {
                    const scoreA = calculateProfileScore(a);
                    const scoreB = calculateProfileScore(b);
                    return scoreB - scoreA; // Higher scores first
                });
                
                console.log(`Loaded ${allCandidates.length} candidates for pool ${pool.label}`);
                
                // Populate filters
                populateLocationFilter(allCandidates);
                categorizeCandidates(allCandidates);
                
                filteredCandidates = [...allCandidates];
                displayCandidatesPage();
                
            } catch (err) {
                console.error('Error in openPool:', err);
                candidatesListView.innerHTML = `<div class="error-message">Error loading candidates</div>`;
            }
            
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.getElementById('poolDetailView').classList.add('active');
        }
        
        // Populate location filter
        function populateLocationFilter(candidates) {
            const locationCounts = {};
            
            candidates.forEach(candidate => {
                const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                if (!locationCounts[location]) {
                    locationCounts[location] = 0;
                }
                locationCounts[location]++;
            });
            
            const sortedLocations = Object.entries(locationCounts).sort((a, b) => {
                if (a[0] === 'Location Not Specified') return 1;
                if (b[0] === 'Location Not Specified') return -1;
                return a[0].localeCompare(b[0]);
            });
            
            const locationFilter = document.getElementById('locationFilter');
            locationFilter.innerHTML = `<option value="">All Locations</option>`;
            
            sortedLocations.forEach(([location, count]) => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = `${location} (${count})`;
                locationFilter.appendChild(option);
            });
        }
        
        // Categorize candidates
        function categorizeCandidates(candidates) {
            const categoryKeywords = {
                'greenkeeping': ['greenkeeper', 'greens', 'course manager', 'turf', 'agronomist'],
                'management': ['manager', 'director', 'head', 'chief', 'ceo', 'coo', 'cfo'],
                'pga': ['pga', 'professional', 'golf professional', 'head pro', 'assistant pro'],
                'marketing': ['marketing', 'social media', 'digital', 'communications', 'brand'],
                'sales': ['sales', 'business development', 'account manager', 'commercial'],
                'hospitality': ['hospitality', 'events', 'wedding', 'conference', 'guest'],
                'maintenance': ['maintenance', 'mechanic', 'technician', 'engineer', 'equipment'],
                'admin': ['admin', 'administrator', 'office', 'reception', 'secretary'],
                'retail': ['retail', 'shop', 'pro shop', 'merchandise'],
                'f&b': ['food', 'beverage', 'chef', 'catering', 'kitchen', 'restaurant', 'bar']
            };
            
            candidates.forEach(candidate => {
                const jobTitle = (candidate["Current Job Title"] || candidate["Job Title"] || '');
                // Handle if job title is a number/float
                const jobTitleStr = typeof jobTitle === 'string' ? jobTitle.toLowerCase() : '';
                const skills = (candidate["Your Skills"] || '').toLowerCase();
                const combinedText = jobTitleStr + ' ' + skills;
                
                candidate.category = 'other';
                
                for (const [category, keywords] of Object.entries(categoryKeywords)) {
                    if (keywords.some(keyword => combinedText.includes(keyword))) {
                        candidate.category = category;
                        break;
                    }
                }
            });
        }

        // Display candidates page
        function displayCandidatesPage() {
            const startIdx = currentPage * candidatesPerPage;
            const endIdx = startIdx + candidatesPerPage;
            displayedCandidates = filteredCandidates.slice(0, endIdx);
            
            displayCandidates(displayedCandidates);
            
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (endIdx < filteredCandidates.length) {
                loadMoreContainer.style.display = 'block';
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }

        // COMPLETELY FIXED: Display candidates with job titles and top pick badges
        function displayCandidates(candidates) {
            const candidatesListView = document.getElementById('candidatesListView');
            
            if (!candidates || candidates.length === 0) {
                candidatesListView.innerHTML = `
                    <div class="empty-state">
                        <h3>No candidates match your criteria</h3>
                        <p>Try adjusting your filters</p>
                        <button class="btn btn-primary" onclick="clearFilters()">Clear Filters</button>
                    </div>
                `;
                return;
            }
            
            document.getElementById('candidateCount').textContent = `Showing ${displayedCandidates.length} of ${filteredCandidates.length} candidates`;
            
            candidatesListView.innerHTML = candidates.map(candidate => {
                // Handle Current Job Title properly (it might be stored as a float/number)
                let rawJobTitle = candidate["Current Job Title"];
                if (typeof rawJobTitle === 'number' || !rawJobTitle || rawJobTitle === '') {
                    rawJobTitle = candidate["Job Title"] || '';
                }
                const jobTitle = rawJobTitle ? toTitleCase(rawJobTitle) : `Candidate #${candidate.ID}`;
                
                const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                const salary = formatSalaryExact(candidate["What are your salary expectations?"]);
                const notice = formatNoticePeriod(candidate["Notice Period"]);
                const profileScore = calculateProfileScore(candidate);
                const isTopPick = profileScore >= 85;
                const isSelected = selectedCandidates.has(candidate.ID);
                const activelyLooking = (candidate["Actively looking for work"] || '').toUpperCase() === 'YES';
                
                // Get summary preview
                const about = candidate["About You"] || '';
                const summaryPreview = about.substring(0, 150) + (about.length > 150 ? '...' : '');
                
                return `
                    <div class="candidate-list-item ${isSelected ? 'selected' : ''}" 
                         id="card-${candidate.ID}"
                         style="background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; 
                                border: 2px solid ${isSelected ? 'var(--masters-green)' : '#e5e7eb'}; 
                                cursor: pointer; transition: all 0.3s ease; position: relative;"
                         onclick='viewCandidateProfile(${candidate.ID})'>
                        
                        <input type="checkbox" 
                               style="position: absolute; top: 1rem; left: 1rem; width: 20px; height: 20px; cursor: pointer; z-index: 10;"
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleCandidateSelection(${candidate.ID})"
                               onclick="event.stopPropagation()">
                        
                        ${isTopPick ? '<div class="top-pick-badge">⭐ TOP PICK</div>' : ''}
                        
                        <div style="padding-left: 2.5rem;">
                            <h3 style="color: var(--augusta-green); margin-bottom: 0.25rem; font-size: 1.2rem; font-weight: 600;">
                                ${jobTitle}
                            </h3>
                            <p style="color: var(--rough-gray); font-size: 0.9rem; margin-bottom: 0.5rem;">${location}</p>
                            
                            ${summaryPreview ? `
                                <p style="color: #555; font-size: 0.85rem; line-height: 1.4; margin-bottom: 0.75rem;">
                                    ${summaryPreview}
                                </p>
                            ` : ''}
                            
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: var(--rough-gray); font-size: 0.85rem;">
                                    ${salary} • ${notice}${activelyLooking ? ' • Actively looking' : ''}
                                </span>
                                <span style="color: var(--masters-green); font-weight: 600;">View →</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View candidate profile (for split view)
        function viewCandidateProfile(candidateId) {
            const candidate = allCandidates.find(c => c.ID === candidateId);
            if (!candidate) return;
            
            currentCandidate = candidate;
            
            // Handle job title
            let rawJobTitle = candidate["Current Job Title"];
            if (typeof rawJobTitle === 'number' || !rawJobTitle || rawJobTitle === '') {
                rawJobTitle = candidate["Job Title"] || '';
            }
            const jobTitle = rawJobTitle ? toTitleCase(rawJobTitle) : `Candidate #${candidate.ID}`;
            
            const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
            const about = candidate["About You"] || 'No summary provided';
            const skills = candidate["Your Skills"] || '';
            const salary = formatSalaryExact(candidate["What are your salary expectations?"]);
            const notice = formatNoticePeriod(candidate["Notice Period"]);
            const activelyLooking = candidate["Actively looking for work"] || 'Not specified';
            const profileScore = calculateProfileScore(candidate);
            const isTopPick = profileScore >= 85;
            
            const profileDetailView = document.getElementById('profileDetailView');
            profileDetailView.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h1 style="color: var(--augusta-green); margin-bottom: 0.5rem; font-size: 1.8rem;">
                        ${jobTitle}
                        ${isTopPick ? '<span class="top-pick-badge" style="position: relative; top: -5px; margin-left: 1rem;">⭐ TOP PICK</span>' : ''}
                    </h1>
                    <p style="color: var(--rough-gray); font-size: 1.1rem;">${location}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                            Salary Expectations
                        </div>
                        <div style="font-weight: 600; font-size: 1.1rem;">${salary}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                            Notice Period
                        </div>
                        <div style="font-weight: 600; font-size: 1.1rem;">${notice}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                            Job Search Status
                        </div>
                        <div style="font-weight: 600; font-size: 1.1rem;">${activelyLooking}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Professional Summary</h3>
                    <p style="line-height: 1.8; color: #333; white-space: pre-wrap;">${about}</p>
                </div>
                
                ${skills ? `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Skills & Expertise</h3>
                        <p style="line-height: 1.6; color: #333; white-space: pre-wrap;">${skills}</p>
                    </div>
                ` : ''}
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-secondary btn-small" onclick="addToShortlist()">Save to Shortlist</button>
                    <button class="btn btn-primary btn-small" onclick="openCandidate(${candidate.ID})">View Full Profile</button>
                </div>
            `;
        }

        // Open candidate modal
        function openCandidate(candidateId) {
            const candidate = allCandidates.find(c => c.ID === candidateId);
            if (!candidate) return;
            
            currentCandidate = candidate;
            
            // Handle job title
            let rawJobTitle = candidate["Current Job Title"];
            if (typeof rawJobTitle === 'number' || !rawJobTitle || rawJobTitle === '') {
                rawJobTitle = candidate["Job Title"] || '';
            }
            const jobTitle = rawJobTitle ? toTitleCase(rawJobTitle) : `Candidate #${candidate.ID}`;
            
            const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
            const about = candidate["About You"] || 'No summary provided';
            const skills = candidate["Your Skills"] || '';
            const salary = formatSalaryExact(candidate["What are your salary expectations?"]);
            const notice = formatNoticePeriod(candidate["Notice Period"]);
            
            document.getElementById('modalTitle').textContent = jobTitle;
            document.getElementById('modalBody').innerHTML = `
                <p style="color: var(--rough-gray); font-size: 1.1rem; margin-bottom: 2rem;">${location}</p>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Professional Summary</h3>
                    <p style="line-height: 1.8;">${about}</p>
                </div>
                
                ${skills ? `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Skills & Expertise</h3>
                        <p style="line-height: 1.6;">${skills}</p>
                    </div>
                ` : ''}
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                            Salary Expectations
                        </div>
                        <div style="font-weight: 600;">${salary}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                            Notice Period
                        </div>
                        <div style="font-weight: 600;">${notice}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('candidateNotes').value = candidateNotes[candidate.ID] || '';
            document.getElementById('candidateModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('candidateModal').classList.remove('active');
        }

        // Load more candidates
        function loadMore() {
            currentPage++;
            displayCandidatesPage();
        }

        // Filters
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(applyFilters, 300));
            }
            
            ['locationFilter', 'categoryFilter', 'salaryFilter', 'noticeFilter', 'lookingFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', applyFilters);
                }
            });
        });

        function debounce(func, delay) {
            let timeout;
            return function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, arguments), delay);
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const salaryFilter = document.getElementById('salaryFilter').value;
            const noticeFilter = document.getElementById('noticeFilter').value;
            const lookingFilter = document.getElementById('lookingFilter').value;
            
            let filtered = [...allCandidates];
            
            if (searchTerm) {
                filtered = filtered.filter(c => {
                    const jobTitle = typeof c["Current Job Title"] === 'string' ? c["Current Job Title"] : '';
                    return (
                        jobTitle.toLowerCase().includes(searchTerm) ||
                        (c["Town/City"] || '').toLowerCase().includes(searchTerm) ||
                        (c["Your Skills"] || '').toLowerCase().includes(searchTerm) ||
                        (c["About You"] || '').toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            if (locationFilter) {
                filtered = filtered.filter(c => {
                    const location = cleanAndFormatLocation(c["Town/City"], c.Country);
                    return location === locationFilter;
                });
            }
            
            if (categoryFilter) {
                filtered = filtered.filter(c => c.category === categoryFilter);
            }
            
            if (salaryFilter) {
                filtered = filtered.filter(c => {
                    const salary = parseFloat(c["What are your salary expectations?"]) || 0;
                    if (salaryFilter === '70000+') return salary >= 70000;
                    const [min, max] = salaryFilter.split('-').map(Number);
                    return salary >= min && salary <= max;
                });
            }
            
            if (noticeFilter) {
                filtered = filtered.filter(c => {
                    const notice = (c["Notice Period"] || '').toLowerCase();
                    return notice.includes(noticeFilter.toLowerCase());
                });
            }
            
            if (lookingFilter) {
                filtered = filtered.filter(c => 
                    (c["Actively looking for work"] || '').toUpperCase() === lookingFilter
                );
            }
            
            filteredCandidates = filtered;
            currentPage = 0;
            displayCandidatesPage();
        }

        function applySort() {
            const sortValue = document.getElementById('sortSelect').value;
            
            switch (sortValue) {
                case 'relevance':
                    filteredCandidates.sort((a, b) => calculateProfileScore(b) - calculateProfileScore(a));
                    break;
                case 'newest':
                    filteredCandidates.sort((a, b) => {
                        const dateA = new Date(a.created_at || 0);
                        const dateB = new Date(b.created_at || 0);
                        return dateB - dateA;
                    });
                    break;
                case 'salary-high':
                    filteredCandidates.sort((a, b) => {
                        const salaryA = parseFloat(a["What are your salary expectations?"]) || 0;
                        const salaryB = parseFloat(b["What are your salary expectations?"]) || 0;
                        return salaryB - salaryA;
                    });
                    break;
                case 'salary-low':
                    filteredCandidates.sort((a, b) => {
                        const salaryA = parseFloat(a["What are your salary expectations?"]) || 0;
                        const salaryB = parseFloat(b["What are your salary expectations?"]) || 0;
                        return salaryA - salaryB;
                    });
                    break;
            }
            
            currentPage = 0;
            displayCandidatesPage();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('locationFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('salaryFilter').value = '';
            document.getElementById('noticeFilter').value = '';
            document.getElementById('lookingFilter').value = '';
            filteredCandidates = [...allCandidates];
            currentPage = 0;
            displayCandidatesPage();
        }

        // Selection functions
        function toggleCandidateSelection(candidateId) {
            if (selectedCandidates.has(candidateId)) {
                selectedCandidates.delete(candidateId);
                document.getElementById(`card-${candidateId}`).classList.remove('selected');
            } else {
                selectedCandidates.add(candidateId);
                document.getElementById(`card-${candidateId}`).classList.add('selected');
            }
        }

        function selectAll() {
            displayedCandidates.forEach(candidate => {
                selectedCandidates.add(candidate.ID);
                const card = document.getElementById(`card-${candidate.ID}`);
                if (card) {
                    card.classList.add('selected');
                    const checkbox = card.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = true;
                }
            });
        }

        function deselectAll() {
            selectedCandidates.clear();
            document.querySelectorAll('.candidate-list-item').forEach(card => {
                card.classList.remove('selected');
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = false;
            });
        }

        // Shortlist functions
        async function addToShortlist() {
            if (!currentCandidate) return;
            
            const existing = shortlist.find(item => item.candidate_id === currentCandidate.ID);
            if (existing) {
                alert('Already in shortlist');
                return;
            }
            
            const { data, error } = await supabase
                .from('shortlists')
                .insert({
                    user_id: currentUser.id,
                    candidate_id: currentCandidate.ID
                })
                .select();
            
            if (!error) {
                alert('Added to shortlist!');
                closeModal();
                await refreshShortlist();
            }
        }

        async function bulkAddToShortlist() {
            if (selectedCandidates.size === 0) {
                alert('Please select candidates first');
                return;
            }
            
            let added = 0;
            for (const candidateId of selectedCandidates) {
                const existing = shortlist.find(item => item.candidate_id === candidateId);
                if (!existing) {
                    const { data } = await supabase
                        .from('shortlists')
                        .insert({
                            user_id: currentUser.id,
                            candidate_id: candidateId
                        })
                        .select();
                    
                    if (data) added++;
                }
            }
            
            alert(`Added ${added} candidates to shortlist`);
            deselectAll();
            await refreshShortlist();
        }

        // Other view functions (simplified for space)
        function loadShortlist() {
            const content = document.getElementById('shortlistContent');
            if (shortlist.length === 0) {
                content.innerHTML = '<div class="section-box">No candidates saved yet</div>';
            } else {
                content.innerHTML = '<div class="candidates-grid">' + 
                    shortlist.map(item => {
                        const c = item.candidates;
                        if (!c) return '';
                        
                        let rawJobTitle = c["Current Job Title"];
                        if (typeof rawJobTitle === 'number' || !rawJobTitle) {
                            rawJobTitle = c["Job Title"] || '';
                        }
                        const jobTitle = rawJobTitle ? toTitleCase(rawJobTitle) : `Candidate #${c.ID}`;
                        
                        return `
                            <div class="candidate-card">
                                <h3>${jobTitle}</h3>
                                <p>${cleanAndFormatLocation(c["Town/City"], c.Country)}</p>
                            </div>
                        `;
                    }).join('') + '</div>';
            }
        }

        function loadMessages() {
            document.getElementById('conversationsList').innerHTML = '<div class="section-box">No messages yet</div>';
        }

        function loadAccount() {
            document.getElementById('accountName').textContent = userProfile?.name || '-';
            document.getElementById('accountEmail').textContent = currentUser?.email || '-';
            document.getElementById('accountCredits').textContent = userProfile?.credits || 0;
        }

        function loadAdmin() {
            if (userProfile?.role !== 'admin') {
                document.getElementById('adminContent').innerHTML = '<p>Access denied.</p>';
                return;
            }
            document.getElementById('adminContent').innerHTML = '<div class="section-box">Admin Dashboard</div>';
        }

        function exportShortlist() {
            if (shortlist.length === 0) {
                alert('No candidates in shortlist');
                return;
            }
            
            let csv = 'Job Title,Location,Salary,Notice Period\n';
            shortlist.forEach(item => {
                const c = item.candidates;
                if (c) {
                    let rawJobTitle = c["Current Job Title"];
                    if (typeof rawJobTitle === 'number' || !rawJobTitle) {
                        rawJobTitle = c["Job Title"] || '';
                    }
                    const jobTitle = rawJobTitle ? toTitleCase(rawJobTitle) : `Candidate #${c.ID}`;
                    const location = cleanAndFormatLocation(c["Town/City"], c.Country);
                    const salary = c["What are your salary expectations?"] || 'Negotiable';
                    const notice = c["Notice Period"] || 'Unknown';
                    
                    csv += `"${jobTitle}","${location}","${salary}","${notice}"\n`;
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'shortlist.csv';
            a.click();
        }

        function saveNotes() {
            if (!currentCandidate) return;
            const notes = document.getElementById('candidateNotes').value;
            candidateNotes[currentCandidate.ID] = notes;
            localStorage.setItem('candidateNotes_' + currentUser.id, JSON.stringify(candidateNotes));
            alert('Notes saved!');
        }

        function sendMessage() {
            alert('Message functionality coming soon!');
        }

        function goHome() {
            switchView('pools');
        }
    </script>
</body>
</html>
