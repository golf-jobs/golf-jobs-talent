<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Jobs - Premium Talent Pools</title>

    <!-- Favicon -->
    <link rel="icon" href="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20white.png?updatedAt=1758280288759">
    <link rel="apple-touch-icon" sizes="180x180" href="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20white.png?updatedAt=1758280288759">

    
    <!-- Add Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">
        // Handle browser back/forward to keep view in sync
        window.addEventListener('popstate', function(e) {
            const v = new URL(window.location).searchParams.get('view') || 'pools';
            switchView(v, {skipPush: true});
        });
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --augusta-green: #004d26;
            --fairway-green: #2d5f3f;
            --masters-green: #3a7858;
            --putting-green: #6b9080;
            --club-gold: #c9a961;
            --trophy-gold: #f4d03f;
            --sand-bunker: #f5e6d3;
            --morning-mist: #f8f9fa;
            --pro-shop-navy: #1a2332;
            --scorecard-white: #ffffff;
            --rough-gray: #6c757d;
            --hazard-red: #c9302c;
            --water-hazard: #2c5aa0;
        }

        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: var(--pro-shop-navy);
            background: linear-gradient(180deg, #f8f9fa 0%, #e8efe8 100%);
            min-height: 100vh;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            height: 250px;
            border-radius: 16px;
            margin-bottom: 1.75rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 77, 38, 0.1);
            border-top-color: var(--augusta-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--augusta-green);
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 450px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-title {
            text-align: center;
            color: var(--augusta-green);
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .login-subtitle {
            text-align: center;
            color: var(--rough-gray);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--pro-shop-navy);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e1e8e4;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--masters-green);
            box-shadow: 0 0 0 3px rgba(58, 120, 88, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--masters-green) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Poppins', sans-serif;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 77, 38, 0.3);
        }

        .login-error {
            background: #fee;
            color: var(--hazard-red);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        /* Main App */
        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--fairway-green) 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
        }

        .logo img {
            height: 60px;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 0.625rem 1.25rem;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: var(--club-gold);
            color: var(--augusta-green);
            font-weight: 600;
        }

        .shortlist-badge {
            background: rgba(255,255,255,0.3);
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            margin-left: 0.25rem;
            font-size: 0.875rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 12px;
        }

        .credits-badge {
            background: linear-gradient(135deg, var(--club-gold) 0%, var(--trophy-gold) 100%);
            color: var(--augusta-green);
            padding: 0.375rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
        }

        .btn-logout {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* View Sections */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Analytics Dashboard */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .analytics-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .analytics-card h3 {
            color: var(--augusta-green);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--masters-green);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--rough-gray);
            font-size: 0.9rem;
        }

        .top-list {
            list-style: none;
            padding: 0;
        }

        .top-list li {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-list li:last-child {
            border-bottom: none;
        }

        .rank-badge {
            background: var(--club-gold);
            color: var(--augusta-green);
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-right: 0.75rem;
        }

        /* Pools Grid */
        .pools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .pool-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .pool-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .pool-card.locked {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .pool-header {
            background: linear-gradient(135deg, var(--fairway-green) 0%, var(--masters-green) 100%);
            padding: 2rem;
            color: white;
            position: relative;
        }

        .pool-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .pool-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--club-gold);
            color: var(--augusta-green);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 700;
        }

        .pool-stats {
            padding: 2rem;
        }

        .pool-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .pool-stat:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        /* Candidates Grid */
        .candidates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 1.75rem;
            margin-bottom: 2rem;
        }

        .candidate-card {
            background: white;
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
            position: relative;
            cursor: pointer;
        }

        .candidate-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 24px rgba(0,0,0,0.1);
            border-color: var(--masters-green);
        }

        .candidate-card.selected {
            background: #f0f8f4;
            border-color: var(--masters-green);
        }

        .candidate-checkbox {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .top-pick-badge {
            position: absolute;
            top: -10px;
            right: 15px;
            background: linear-gradient(135deg, #2d5f3f, #3a7858);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .new-badge {
            position: absolute;
            top: -8px;
            left: 1rem;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Message System Styles */
        .message-box {
            background: #f8f9fa;
            border: 1px solid #e1e8e4;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .message-textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.75rem;
            border: 2px solid #e1e8e4;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
            font-size: 1rem;
        }

        .message-textarea:focus {
            outline: none;
            border-color: var(--masters-green);
        }

        .conversation-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
        }

        .message.sent {
            background: var(--masters-green);
            color: white;
            margin-left: 20%;
            text-align: right;
        }

        .message.received {
            background: #f0f0f0;
            margin-right: 20%;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        /* Sorting Bar */
        .sorting-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .sort-options {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Filter Panel */
        .filter-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 35, 50, 0.95);
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background: white;
            margin: 3% auto;
            padding: 2rem;
            width: 90%;
            max-width: 700px;
            border-radius: 20px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--rough-gray);
        }

        .modal-close:hover {
            color: var(--pro-shop-navy);
        }

        /* Confirmation Dialog */
        .confirmation-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 3000;
            max-width: 500px;
            display: none;
        }

        .confirmation-dialog.active {
            display: block;
        }

        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2999;
            display: none;
        }

        .dialog-overlay.active {
            display: block;
        }

        /* Notes Panel */
        .notes-panel {
            background: #fffef5;
            border: 1px solid var(--club-gold);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .note-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.5rem;
            border: 1px solid #e1e8e4;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
        }

        /* Buttons */
        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--masters-green) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 77, 38, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--augusta-green);
            border: 2px solid var(--augusta-green);
        }

        .btn-secondary:hover {
            background: var(--augusta-green);
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .section-box {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            color: var(--rough-gray);
        }

        .breadcrumb a {
            color: var(--masters-green);
            text-decoration: none;
            font-weight: 600;
        }

        .breadcrumb a:hover {
            color: var(--augusta-green);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .empty-state h3 {
            color: var(--augusta-green);
            margin-bottom: 1rem;
        }

        .empty-state p {
            color: var(--rough-gray);
            margin-bottom: 2rem;
        }

        /* Load More */
        .load-more-container {
            text-align: center;
            padding: 2rem;
        }

        .load-more-btn {
            padding: 0.875rem 2rem;
            background: white;
            color: var(--augusta-green);
            border: 2px solid var(--augusta-green);
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .load-more-btn:hover {
            background: var(--augusta-green);
            color: white;
        }

        /* Mobile Split View */
        @media (max-width: 768px) {
            .pools-grid, .candidates-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .sorting-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .modal-content {
                margin: 10% 1rem;
                width: calc(100% - 2rem);
            }
            
            /* Hide right panel on mobile by default */
            #profileDetailView {
                display: none;
            }
            
            /* Show only list on mobile */
            .split-view-container {
                flex-direction: column !important;
                height: auto !important;
            }
            
            .split-view-left {
                width: 100% !important;
                border-right: none !important;
                padding-right: 0 !important;
            }
            
            .split-view-right {
                display: none;
            }
            
            /* When profile is opened on mobile, show it as modal */
            .mobile-profile-active #candidatesListView {
                display: none;
            }
            
            .mobile-profile-active #profileDetailView {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                z-index: 1000;
                overflow-y: auto;
                padding: 1rem;
            }
            
            .mobile-back-btn {
                display: block !important;
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 1001;
                background: var(--augusta-green);
                color: white;
                border: none;
                padding: 0.5rem 1rem;
                border-radius: 8px;
                cursor: pointer;
            }
        }
        
        .mobile-back-btn {
            display: none;
        }

        .error-message {
            background: #fee;
            color: var(--hazard-red);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div style="text-align: center; margin-bottom: 2rem;">
                <img src="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20black.png?updatedAt=1757017924442" alt="Golf Jobs" style="width: 200px;">
            </div>
            <h1 class="login-title">Talent Pool Access</h1>
            <p class="login-subtitle">Exclusive recruitment platform</p>
            
            <div id="loginError" class="login-error">Invalid credentials. Please try again.</div>
            
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="loginEmail" required placeholder="your@company.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn-login">Sign In</button>
            </form>
            
            <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e1e8e4;">
                <p style="color: var(--rough-gray); font-size: 0.85rem;">¬© 2025 Golf Jobs. Professional recruitment excellence.</p>
                <p style="margin-top: 0.5rem; color: var(--rough-gray); font-size: 0.85rem;">Need access? Contact <strong>graham@golf-jobs.com</strong></p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo" onclick="goHome()">
                    <img src="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20white.png?updatedAt=1758280288759" alt="Golf Jobs">
                </div>
                <nav class="nav-tabs">
                    <button class="nav-tab active" onclick="switchView('pools')">Talent Pools</button>
                    <button class="nav-tab" onclick="switchView('shortlist')">
                        Shortlist <span id="shortlistBadge" class="shortlist-badge" style="display: none;">0</span>
                    </button>
                    <button class="nav-tab" onclick="switchView('messages')">Messages</button>
                    <button class="nav-tab" onclick="switchView('account')">My Account</button>
                    <button id="adminTab" class="nav-tab" onclick="switchView('admin')" style="display:none;">Admin</button>
                </nav>
                <div class="user-info">
                    <span id="userName">Welcome</span>
                    <div class="credits-badge">
                        Credits: <span id="creditsCount">0</span>
                    </div>
                    <button class="btn-logout" onclick="handleLogout()">Sign Out</button>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Pools View -->
            <div id="poolsView" class="view-section active">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Your Talent Pools</h1>
                <p style="color: var(--rough-gray); margin-bottom: 2rem; font-size: 1.1rem;">Select a talent pool to browse candidates</p>
                <div class="pools-grid" id="poolsGrid">
                    <!-- Loading skeletons -->
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
            </div>

            <!-- Pool Detail View with Split Layout -->
            <div id="poolDetailView" class="view-section">
                <div class="breadcrumb">
                    <a href="#" onclick="switchView('pools')">Talent Pools</a>
                    <span>‚Üí</span>
                    <span id="currentPoolName">Pool Name</span>
                </div>
                
                <!-- Filter Panel -->
                <div class="filter-panel" id="filterPanel">
                    <input type="text" id="searchInput" placeholder="Search by name, role, skills, or location..." 
                           style="width: 100%; padding: 0.875rem; border: 2px solid #e1e8e4; border-radius: 12px; font-size: 1rem; margin-bottom: 1rem;">
                    
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-start;">
                        <select id="locationFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Locations</option>
                        </select>
                        
                        <select id="categoryFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Categories</option>
                            <option value="greenkeeping">Greenkeeping</option>
                            <option value="management">Management</option>
                            <option value="pga">PGA Professional</option>
                            <option value="marketing">Marketing</option>
                            <option value="sales">Sales</option>
                            <option value="hospitality">Hospitality</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="admin">Admin/Office</option>
                            <option value="retail">Retail/Pro Shop</option>
                            <option value="f&b">F&B/Catering</option>
                        </select>
                        
                        <select id="salaryFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Salaries</option>
                            <option value="0-30000">¬£20-30k</option>
                            <option value="30000-40000">¬£30-40k</option>
                            <option value="40000-50000">¬£40-50k</option>
                            <option value="50000-60000">¬£50-60k</option>
                            <option value="60000-70000">¬£60-70k</option>
                            <option value="70000+">¬£70k+</option>
                        </select>
                        
                        <select id="noticeFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Notice Periods</option>
                            <option value="immediately">Available Immediately</option>
                            <option value="1 week">1 Week</option>
                            <option value="1 month">1 Month</option>
                            <option value="2 months">2 Months</option>
                            <option value="3 months">3 Months</option>
                        </select>
                        
                        <select id="lookingFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">Active/Passive</option>
                            <option value="YES">Actively Looking</option>
                            <option value="NO">Not Actively Looking</option>
                        </select>
                        
                        <button onclick="clearFilters()" class="btn btn-small" style="background: #e5e7eb; color: var(--rough-gray);">
                            Clear All
                        </button>
                    </div>
                </div>
                
                <!-- Sorting Bar -->
                <div class="sorting-bar">
                    <div class="sort-options">
                        <label style="margin-right: 0.5rem; color: var(--rough-gray);">Sort by:</label>
                        <select id="sortSelect" onchange="applySort()" style="padding: 0.5rem; border: 1px solid #e1e8e4; border-radius: 8px;">
                            <option value="relevance">Best Match</option>
                            <option value="newest">Newest First</option>
                            <option value="salary-high">Salary (High to Low)</option>
                            <option value="salary-low">Salary (Low to High)</option>
                        </select>
                    </div>
                    
                    <div class="bulk-actions">
                        <button class="btn btn-small btn-secondary" onclick="selectAll()">Select All</button>
                        <button class="btn btn-small btn-secondary" onclick="deselectAll()">Clear Selection</button>
                        <button class="btn btn-small btn-primary" onclick="bulkAddToShortlist()">Add to Shortlist</button>
                    </div>
                </div>
                
                <div id="candidateCount" style="margin-bottom: 1rem; color: var(--rough-gray);"></div>
                
                <!-- Split View Container -->
                <div class="split-view-container" style="display: flex; gap: 1.5rem; height: calc(100vh - 350px); min-height: 600px;">
                    <!-- Left Panel - Candidate List -->
                    <div class="split-view-left" style="width: 40%; overflow-y: auto; padding-right: 1rem; border-right: 1px solid #e5e7eb;">
                        <div id="candidatesListView">
                            <!-- Loading skeletons -->
                            <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
                            <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
                            <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
                        </div>
                        
                        <!-- Load More -->
                        <div class="load-more-container" id="loadMoreContainer" style="display: none; padding: 1rem 0;">
                            <button class="load-more-btn" onclick="loadMore()" style="width: 100%;">Load More</button>
                        </div>
                    </div>
                    
                    <!-- Right Panel - Full Profile View -->
                    <div class="split-view-right" style="flex: 1; overflow-y: auto; padding-left: 1rem;">
                        <button class="mobile-back-btn" onclick="closeMobileProfile()">‚Üê Back to List</button>
                        <div id="profileDetailView" style="background: white; border-radius: 16px; padding: 2rem; min-height: 100%;">
                            <div style="text-align: center; color: var(--rough-gray); padding: 4rem 2rem;">
                                <h3 style="margin-bottom: 1rem;">Select a candidate</h3>
                                <p>Click on any candidate from the list to view their full profile</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shortlist View -->
            <div id="shortlistView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Your Shortlist</h1>
                <div style="margin-bottom: 2rem;">
                    <button class="btn btn-primary" onclick="exportShortlist()">Export Shortlist</button>
                </div>
                <div id="shortlistContent"></div>
            </div>

            <!-- Messages View -->
            <div id="messagesView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Messages</h1>
                <div id="conversationsList"></div>
            </div>

            <!-- Account View -->
            <div id="accountView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 2rem;">My Account</h1>
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1rem;">Account Overview</h2>
                    <p style="margin-bottom: 1rem;"><strong>Name:</strong> <span id="accountName">-</span></p>
                    <p style="margin-bottom: 1rem;"><strong>Email:</strong> <span id="accountEmail">-</span></p>
                    <p style="margin-bottom: 1rem;"><strong>Credits Balance:</strong> <span id="accountCredits">0</span></p>
                    <p><strong>Total Messages Sent:</strong> <span id="totalMessages">0</span></p>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 2rem;">Admin Dashboard</h1>
                
                <!-- Analytics Section -->
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1.5rem;">üìä Platform Analytics</h2>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h3>Total Profile Views</h3>
                            <div class="stat-number" id="totalViews">0</div>
                            <div class="stat-label">All time views</div>
                        </div>
                        <div class="analytics-card">
                            <h3>Total Messages</h3>
                            <div class="stat-number" id="totalMessagesAdmin">0</div>
                            <div class="stat-label">Messages sent</div>
                        </div>
                        <div class="analytics-card">
                            <h3>Active Users</h3>
                            <div class="stat-number" id="activeUsers">0</div>
                            <div class="stat-label">Registered employers</div>
                        </div>
                    </div>
                </div>

                <!-- Most Viewed Profiles -->
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1.5rem;">üî• Most Viewed Profiles</h2>
                    <ul class="top-list" id="mostViewedList">
                        <li>Loading...</li>
                    </ul>
                </div>

                <!-- Most Messaged Candidates -->
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1.5rem;">üí¨ Most Messaged Candidates</h2>
                    <ul class="top-list" id="mostMessagedList">
                        <li>Loading...</li>
                    </ul>
                </div>

                <!-- All Messages -->
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1rem;">Recent Messages</h2>
                    <div id="adminMessagesList"></div>
                </div>

                <!-- All Users -->
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1rem;">All Users</h2>
                    <div id="adminUsersList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Candidate Modal -->
    <div id="candidateModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <h2 id="modalTitle" style="color: var(--augusta-green); margin-bottom: 1rem;"></h2>
            <div id="modalBody"></div>
            
            <!-- Notes Section -->
            <div class="notes-panel">
                <h4 style="color: var(--augusta-green); margin-bottom: 0.5rem;">üìù Private Notes</h4>
                <textarea class="note-textarea" id="candidateNotes" placeholder="Add your notes about this candidate..."></textarea>
                <button class="btn btn-small" onclick="saveNotes()" style="margin-top: 0.5rem;">Save Notes</button>
            </div>
            
            <!-- Message Section -->
            <div class="message-box">
                <h4 style="color: var(--augusta-green); margin-bottom: 0.5rem;">üí¨ Send Message</h4>
                <p style="font-size: 0.85rem; color: var(--rough-gray); margin-bottom: 0.5rem;">
                    First message to this candidate will use 1 credit. Follow-up messages are free.
                </p>
                <div id="previousMessages" class="conversation-container" style="display: none;">
                    <!-- Previous messages will appear here -->
                </div>
                <textarea class="message-textarea" id="messageText" 
                          placeholder="Introduce yourself and explain why you're interested in this candidate..."></textarea>
                <button class="btn btn-primary btn-small" onclick="sendMessage()" style="margin-top: 0.5rem;">
                    Send Message <span id="creditCost"></span>
                </button>
            </div>
            
            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="addToShortlist()">Save to Shortlist</button>
            </div>
        </div>
    </div>

    <!-- Message Confirmation Dialog -->
    <div class="dialog-overlay" id="messageDialogOverlay" onclick="cancelMessage()"></div>
    <div class="confirmation-dialog" id="messageConfirmationDialog">
        <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Confirm Message Send</h3>
        <div style="background: #fef3e6; border: 2px solid var(--club-gold); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
            <p style="margin-bottom: 0.75rem;"><strong>‚ö†Ô∏è This will use 1 credit</strong></p>
            <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 0.5rem;">
                By sending this message:
            </p>
            <ul style="font-size: 0.9rem; line-height: 1.6; margin-left: 1.5rem;">
                <li>1 credit will be deducted from your account</li>
                <li>Your message will be sent directly to the candidate</li>
                <li>The candidate's email remains private</li>
                <li>You can continue the conversation for free</li>
                <li>All messages are logged for quality assurance</li>
            </ul>
        </div>
        <p style="margin-bottom: 1.5rem;">Current balance: <strong id="currentCreditsMsg">0</strong> credits</p>
        <p style="margin-bottom: 1.5rem; font-size: 0.85rem; color: var(--rough-gray);">
            After sending: <strong id="afterCreditsMsg">0</strong> credits remaining
        </p>
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="cancelMessage()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmMessage()">Confirm & Send (1 Credit)</button>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://kbadedwbcjetxiertztv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtiYWRlZHdiY2pldHhpZXJ0enR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDAyNDMsImV4cCI6MjA3Mzg3NjI0M30.igm3XjM8l1OXfilQaAHtmJyCDe9eXILV_P9B3_sUzwg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state
        let currentUser = null;
        let currentPool = null;
        let currentCandidate = null;
        let userProfile = null;
        let userPools = [];
        let shortlist = [];
        let allCandidates = [];
        let filteredCandidates = [];
        let displayedCandidates = [];
        let selectedCandidates = new Set();
        let candidateNotes = {};
        let conversations = {};
        let profileViews = {};
        let currentPage = 0;
        const candidatesPerPage = 20;

        // Utility functions
        function toTitleCase(str) {
            if (!str) return str;
            
            const acronyms = ['UK', 'USA', 'US', 'CEO', 'CFO', 'COO', 'CTO', 'PGA', 'HR', 'IT', 'F&B'];
            
            return str.toLowerCase().split(/(\s+|-)/).map(word => {
                const cleanWord = word.replace(/[.,;:!?]/g, '');
                const upperClean = cleanWord.toUpperCase();
                
                if (acronyms.includes(upperClean)) {
                    return word.replace(cleanWord, upperClean);
                }
                
                if (word.length > 0) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }
                return word;
            }).join('');
        }

        function cleanAndFormatLocation(townCity, country) {
            const excludeTerms = ['England', 'United Kingdom', 'UK', 'Scotland', 'Wales', 'Northern Ireland'];
            
            let cleanedTown = townCity ? townCity.trim() : '';
            let cleanedCountry = country ? country.trim() : '';
            
            if (excludeTerms.some(term => cleanedCountry.toLowerCase() === term.toLowerCase())) {
                cleanedCountry = '';
            }
            
            if (cleanedTown) {
                return toTitleCase(cleanedTown);
            }
            
            return 'Location Not Specified';
        }

        function formatSalaryExact(salary) {
            if (!salary) return 'Salary Negotiable';
            const num = parseFloat(salary);
            if (isNaN(num)) return 'Salary Negotiable';
            return `¬£${num.toLocaleString()}`;
        }

        function formatNoticePeriod(notice) {
            if (!notice) return 'Unknown';
            const lowerNotice = notice.toLowerCase();
            if (lowerNotice.includes('immediately') || lowerNotice.includes('immediate')) return 'Available immediately';
            if (lowerNotice.includes('1 week')) return '1 week notice';
            if (lowerNotice.includes('2 week')) return '2 weeks notice';
            if (lowerNotice.includes('1 month')) return '1 month notice';
            if (lowerNotice.includes('2 month')) return '2 months notice';
            if (lowerNotice.includes('3 month')) return '3 months notice';
            return notice + ' notice';
        }

        function calculateProfileScore(candidate) {
            let score = 0;
            let maxScore = 100;
            
            const aboutYou = candidate["About You"] || '';
            if (aboutYou.length > 200) score += 30;
            else if (aboutYou.length > 100) score += 20;
            else if (aboutYou.length > 50) score += 10;
            
            const skills = candidate["Your Skills"] || '';
            if (skills.length > 100) score += 20;
            else if (skills.length > 50) score += 15;
            else if (skills.length > 20) score += 10;
            
            if (candidate["Current Job Title"] || candidate["Job Title"]) score += 10;
            if (candidate["What are your salary expectations?"]) score += 10;
            if (candidate["Notice Period"]) score += 10;
            if (candidate["Town/City"]) score += 5;
            
            return Math.min((score / maxScore) * 100, 100);
        }

        // Track profile view
        async function trackProfileView(candidateId, candidateName) {
            if (!profileViews[candidateId]) {
                profileViews[candidateId] = { count: 0, name: candidateName };
            }
            profileViews[candidateId].count++;
            
            // Save to localStorage for persistence
            localStorage.setItem('profileViews', JSON.stringify(profileViews));
            
            // Also save to database if available
            try {
                await supabase.from('profile_views').insert({
                    candidate_id: candidateId,
                    candidate_name: candidateName,
                    viewer_id: currentUser.id,
                    viewer_email: currentUser.email,
                    viewed_at: new Date().toISOString()
                });
            } catch (err) {
                console.log('Analytics tracking:', err);
            }
        }

        // Initialize
        window.onload = async function() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                await loadUserData(session.user);
                showApp();
                // Apply initial view from URL if present
                try { const v = new URL(window.location).searchParams.get('view'); if (v) { switchView(v, {skipPush: true}); } } catch(e) {}
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
            }
            
            // Load saved profile views
            const savedViews = localStorage.getItem('profileViews');
            if (savedViews) {
                profileViews = JSON.parse(savedViews);
            }
        }

        // Login
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            } else {
                await loadUserData(data.user);
                showApp();
            }
        }

        // Load user data - FIXED with error handling
        async function loadUserData(user) {
            currentUser = user;
            
            try {
                const { data: profile, error: profileError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (profileError) {
                    console.error('Error loading user profile:', profileError);
                    // Continue with basic user info
                    userProfile = { id: user.id, email: user.email, credits: 0 };
                } else if (profile) {
                    userProfile = profile;
                    document.getElementById('userName').textContent = profile.name || user.email.split('@')[0];
                    document.getElementById('creditsCount').textContent = profile.credits || 0;
                    
                    if (profile.role === 'admin') {
                        document.getElementById('adminTab').style.display = 'block';
                    }
                }
            } catch (err) {
                console.error('Error in loadUserData:', err);
                userProfile = { id: user.id, email: user.email, credits: 0 };
            }
            
            try {
                const { data: poolAccess, error: poolAccessError } = await supabase
                    .from('user_pool_access')
                    .select('pool_id')
                    .eq('user_id', user.id);
                
                if (poolAccessError) {
                    console.error('Error loading pool access:', poolAccessError);
                    userPools = [];
                } else {
                    userPools = poolAccess ? poolAccess.map(p => p.pool_id) : [];
                    console.log('User ID:', user.id);
                    console.log('User pool access loaded:', userPools);
                    // If user has 'all' access, they can access everything
                    if (userPools.includes('all')) {
                        console.log('User has access to ALL pools');
                    }
                }
            } catch (err) {
                console.error('Error loading pool access:', err);
                userPools = [];
            }
            
            await refreshShortlist();
            
            // Load saved data
            const savedNotes = localStorage.getItem('candidateNotes_' + currentUser.id);
            if (savedNotes) candidateNotes = JSON.parse(savedNotes);
            
            const savedConversations = localStorage.getItem('conversations_' + currentUser.id);
            if (savedConversations) conversations = JSON.parse(savedConversations);
        }

        // Refresh shortlist - FIXED
        async function refreshShortlist() {
            try {
                const { data: shortlistData, error } = await supabase
                    .from('shortlists')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (error) {
                    console.error('Error loading shortlist:', error);
                    shortlist = [];
                } else if (shortlistData && shortlistData.length > 0) {
                    const candidateIds = shortlistData.map(item => item.candidate_id);
                    const { data: candidatesData } = await supabase
                        .from('candidates')
                        .select('*')
                        .in('ID', candidateIds);
                    
                    // Build a map using string keys to avoid number/string mismatches
                    const byId = new Map((candidatesData || []).map(c => [String(c.ID), c]));
                    
                    shortlist = shortlistData.map(item => ({
                        ...item,
                        candidates: byId.get(String(item.candidate_id)) || null
                    }));
                } else {
                    shortlist = [];
                }
            } catch (err) {
                console.error('Error refreshing shortlist:', err);
                shortlist = [];
            }
            
            updateShortlistBadge();
        }

        function updateShortlistBadge() {
            const badge = document.getElementById('shortlistBadge');
            if (shortlist.length > 0) {
                badge.style.display = 'inline';
                badge.textContent = shortlist.length;
            } else {
                badge.style.display = 'none';
            }
        }

        // Show app
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
            loadPools();
        }

        // Logout
        async function handleLogout() {
            await supabase.auth.signOut();
            location.reload();
        }

        // Switch views
        function switchView(view, options = {}) {
            const skipPush = options.skipPush === true;

            // Clear active states
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(section => section.classList.remove('active'));
            
            // Activate view section
            const section = document.getElementById(view + 'View');
            if (section) section.classList.add('active');
            
            // Activate corresponding nav tab (even when called programmatically)
            const tabBtn = document.querySelector(`.nav-tabs .nav-tab[onclick="switchView('${view}')"]`);
            if (tabBtn) tabBtn.classList.add('active');
            
            // Existing per-view loaders
            if (view === 'pools') loadPools();
            else if (view === 'shortlist') loadShortlist();
            else if (view === 'messages') loadMessages && loadMessages();
            else if (view === 'account') loadAccount();
            else if (view === 'admin' && userProfile?.role === 'admin') loadAdmin && loadAdmin();
            
            // Update URL ?view= param
            if (!skipPush) {
                const url = new URL(window.location);
                url.searchParams.set('view', view);
                window.history.pushState({ view }, '', url);
            }
        }

        // Load pools - FIXED with proper error handling and correct field names
        async function loadPools() {
            console.log('Starting loadPools...');
            const poolsGrid = document.getElementById('poolsGrid');
            poolsGrid.innerHTML = `
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
            `;
            
            try {
                const { data: pools, error: poolsError } = await supabase
                    .from('talent_pools')
                    .select('slug, label, sort_order')
                    .order('sort_order', { ascending: true });
                
                console.log('Pools query result:', { pools, poolsError });
                
                if (poolsError) {
                    console.error('Error fetching pools:', poolsError);
                    poolsGrid.innerHTML = `
                        <div class="error-message">
                            <h3>Error loading talent pools</h3>
                            <p>${poolsError.message}</p>
                            <p style="font-size: 0.9rem; margin-top: 1rem;">Please contact graham@golf-jobs.com if this persists.</p>
                        </div>
                    `;
                    return;
                }
                
                if (!pools || pools.length === 0) {
                    console.log('No pools found in database');
                    poolsGrid.innerHTML = `
                        <div class="empty-state">
                            <h3>No talent pools available yet</h3>
                            <p>Talent pools will appear here once they've been created.</p>
                            <p style="font-size: 0.9rem; margin-top: 1rem;">Contact graham@golf-jobs.com for access.</p>
                        </div>
                    `;
                    return;
                }
                
                // Try to get candidate counts, but don't fail if we can't
                for (let pool of pools) {
                    try {
                        let count, countError;
                        
                        // Special handling for 'all' pool - count all candidates
                        if (pool.slug === 'all') {
                            const result = await supabase
                                .from('candidates')
                                .select('*', { count: 'exact', head: true });
                            count = result.count;
                            countError = result.error;
                        } else {
                            // For specific pools, filter by pool_id matching the slug
                            const result = await supabase
                                .from('candidates')
                                .select('*', { count: 'exact', head: true })
                                .eq('pool_id', pool.slug);
                            count = result.count;
                            countError = result.error;
                        }
                        
                        console.log(`Count for pool ${pool.slug}:`, { count, countError });
                        
                        if (countError) {
                            console.warn(`Could not count candidates for pool ${pool.slug}:`, countError);
                            pool.total_candidates = 0;
                        } else {
                            pool.total_candidates = count || 0;
                        }
                    } catch (err) {
                        console.warn(`Error counting candidates for pool ${pool.slug}:`, err);
                        pool.total_candidates = 0;
                    }
                }
                
                // Sort pools by candidate count (if available)
                pools.sort((a, b) => {
                    const aCount = typeof a.total_candidates === 'number' ? a.total_candidates : -1;
                    const bCount = typeof b.total_candidates === 'number' ? b.total_candidates : -1;
                    return bCount - aCount;
                });
                
                console.log('Pools with counts:', pools);
                
                poolsGrid.innerHTML = '';
                
                for (const pool of pools) {
                    // Check if user has access to this pool
                    const hasAccess = userPools.includes(pool.slug) || userPools.includes('all');
                    
                    const poolCard = document.createElement('div');
                    poolCard.className = hasAccess ? 'pool-card' : 'pool-card locked';
                    poolCard.innerHTML = `
                        <div class="pool-header">
                            <div class="pool-title">${pool.label}</div>
                            <div class="pool-badge">${hasAccess ? 'Available' : 'Locked'}</div>
                        </div>
                        <div class="pool-stats">
                            <div class="pool-stat">
                                <span>Total Candidates</span>
                                <span style="font-size: 1.25rem; font-weight: 700; color: var(--augusta-green);">
                                    ${pool.total_candidates !== undefined ? pool.total_candidates : 'Loading...'}
                                </span>
                            </div>
                        </div>
                    `;
                    
                    if (hasAccess) {
                        poolCard.onclick = () => openPool(pool);
                    } else {
                        poolCard.onclick = () => alert('Contact graham@golf-jobs.com to request access to this pool.');
                    }
                    
                    poolsGrid.appendChild(poolCard);
                }
                
            } catch (err) {
                console.error('Unexpected error in loadPools:', err);
                poolsGrid.innerHTML = `
                    <div class="error-message">
                        <h3>An unexpected error occurred</h3>
                        <p>${err.message}</p>
                        <p style="font-size: 0.9rem; margin-top: 1rem;">Please refresh the page or contact support.</p>
                    </div>
                `;
            }
        }

        // Open pool - FIXED with location filter and categorization
        async function openPool(pool) {
            currentPool = pool;
            currentPage = 0;
            document.getElementById('currentPoolName').textContent = pool.label;
            
            const candidatesListView = document.getElementById('candidatesListView');
            candidatesListView.innerHTML = `
                <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
                <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
                <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
            `;
            
            try {
                let candidates, error;
                
                // Special handling for 'all' pool - load all candidates
                if (pool.slug === 'all') {
                    const result = await supabase
                        .from('candidates')
                        .select('*');
                    candidates = result.data;
                    error = result.error;
                } else {
                    // For specific pools, filter by pool_id
                    const result = await supabase
                        .from('candidates')
                        .select('*')
                        .eq('pool_id', pool.slug);
                    candidates = result.data;
                    error = result.error;
                }
                
                if (error) {
                    console.error('Error loading candidates:', error);
                    candidatesListView.innerHTML = `
                        <div class="error-message">
                            <h3>Error loading candidates</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort candidates by profile score (highest first)
                allCandidates = (candidates || []).sort((a, b) => {
                    const scoreA = calculateProfileScore(a);
                    const scoreB = calculateProfileScore(b);
                    return scoreB - scoreA; // Higher scores first
                });
                
                console.log(`Loaded ${allCandidates.length} candidates for pool ${pool.label}`);
                
                // Populate location filter with counts
                populateLocationFilter(allCandidates);
                
                // Categorize candidates for category filter
                categorizeCandidates(allCandidates);
                
                filteredCandidates = [...allCandidates];
                displayCandidatesPage();
                
            } catch (err) {
                console.error('Error in openPool:', err);
                candidatesListView.innerHTML = `
                    <div class="error-message">
                        <h3>An error occurred</h3>
                        <p>Unable to load candidates.</p>
                    </div>
                `;
            }
            
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.getElementById('poolDetailView').classList.add('active');
        }
        
        // Populate location filter with counts
        function populateLocationFilter(candidates) {
            const locationCounts = {};
            
            candidates.forEach(candidate => {
                const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                if (!locationCounts[location]) {
                    locationCounts[location] = 0;
                }
                locationCounts[location]++;
            });
            
            // Sort locations alphabetically, with "Location Not Specified" at the end
            const sortedLocations = Object.entries(locationCounts).sort((a, b) => {
                if (a[0] === 'Location Not Specified') return 1;
                if (b[0] === 'Location Not Specified') return -1;
                return a[0].localeCompare(b[0]);
            });
            
            const locationFilter = document.getElementById('locationFilter');
            locationFilter.innerHTML = `<option value="">All Locations</option>`;
            
            sortedLocations.forEach(([location, count]) => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = `${location} (${count})`;
                locationFilter.appendChild(option);
            });
        }
        
        // Categorize candidates based on job titles and skills
        function categorizeCandidates(candidates) {
            const categoryKeywords = {
                'greenkeeping': ['greenkeeper', 'greens', 'course manager', 'turf', 'agronomist', 'irrigation'],
                'management': ['manager', 'director', 'head', 'chief', 'ceo', 'coo', 'cfo', 'general manager'],
                'pga': ['pga', 'professional', 'golf professional', 'head pro', 'assistant pro', 'teaching'],
                'marketing': ['marketing', 'social media', 'digital', 'communications', 'brand', 'advertising'],
                'sales': ['sales', 'business development', 'account manager', 'commercial'],
                'hospitality': ['hospitality', 'events', 'wedding', 'conference', 'guest'],
                'maintenance': ['maintenance', 'mechanic', 'technician', 'engineer', 'equipment'],
                'admin': ['admin', 'administrator', 'office', 'reception', 'secretary', 'clerk'],
                'retail': ['retail', 'shop', 'pro shop', 'merchandise'],
                'f&b': ['food', 'beverage', 'chef', 'catering', 'kitchen', 'restaurant', 'bar', 'waitress', 'waiter']
            };
            
            candidates.forEach(candidate => {
                const jobTitle = (candidate["Current Job Title"] || candidate["Job Title"] || '').toLowerCase();
                const skills = (candidate["Your Skills"] || '').toLowerCase();
                const combinedText = jobTitle + ' ' + skills;
                
                candidate.category = 'other';
                
                for (const [category, keywords] of Object.entries(categoryKeywords)) {
                    if (keywords.some(keyword => combinedText.includes(keyword))) {
                        candidate.category = category;
                        break;
                    }
                }
            });
        }

        // Display candidates
        function displayCandidatesPage() {
            const startIdx = currentPage * candidatesPerPage;
            const endIdx = startIdx + candidatesPerPage;
            displayedCandidates = filteredCandidates.slice(0, endIdx);
            
            displayCandidates(displayedCandidates);
            
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (endIdx < filteredCandidates.length) {
                loadMoreContainer.style.display = 'block';
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }

        function displayCandidates(candidates) {
            const candidatesListView = document.getElementById('candidatesListView');
            
            if (!candidates || candidates.length === 0) {
                candidatesListView.innerHTML = `
                    <div class="empty-state">
                        <h3>No candidates match your criteria</h3>
                        <p>Try adjusting your filters</p>
                        <button class="btn btn-primary" onclick="clearFilters()">Clear Filters</button>
                    </div>
                `;
                return;
            }
            
            document.getElementById('candidateCount').textContent = `Showing ${displayedCandidates.length} of ${filteredCandidates.length} candidates`;
            
            candidatesListView.innerHTML = candidates.map(candidate => {
                // Handle Current Job Title - convert from Float to String if needed
                let rawJobTitle = candidate["Current Job Title"];
                if (typeof rawJobTitle === 'number') {
                    rawJobTitle = ''; // If it's a number (float), treat as empty
                }
                const jobTitle = toTitleCase(rawJobTitle || candidate["Job Title"] || `Candidate #${candidate.ID}`);
                
                const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                const salary = formatSalaryExact(candidate["What are your salary expectations?"]);
                const notice = formatNoticePeriod(candidate["Notice Period"]);
                const profileScore = calculateProfileScore(candidate);
                const isTopPick = profileScore >= 85;
                const isSelected = selectedCandidates.has(candidate.ID);
                const activelyLooking = (candidate["Actively looking for work"] || '').toUpperCase() === 'YES';
                const isAvailableNow = (candidate["Notice Period"] || '').toLowerCase().includes('immediate');
                
                // Get summary preview
                const about = candidate["About You"] || candidate.Summary || '';
                const summaryPreview = about.substring(0, 150) + (about.length > 150 ? '...' : '');
                
                const clickHandler = `viewCandidateProfile(${JSON.stringify(candidate).replace(/'/g, "&apos;").replace(/"/g, "&quot;")})`;
                
                return `
                    <div class="candidate-list-item ${isSelected ? 'selected' : ''}" 
                         id="card-${candidate.ID}"
                         style="background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; 
                                border: 2px solid ${isSelected ? 'var(--masters-green)' : '#e5e7eb'}; 
                                cursor: pointer; transition: all 0.3s ease; position: relative;"
                         onclick='${clickHandler}'>
                        
                        <input type="checkbox" 
                               style="position: absolute; top: 1rem; left: 1rem; width: 20px; height: 20px; cursor: pointer;"
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleCandidateSelection(${candidate.ID})"
                               onclick="event.stopPropagation()">
                        
                        ${isTopPick ? '<div class="top-pick-badge" style="position: absolute; top: -8px; right: 10px;">‚≠ê TOP PICK</div>' : ''}
                        
                        <div style="padding-left: 2.5rem;">
                            <h3 style="color: var(--augusta-green); margin-bottom: 0.25rem; font-size: 1.1rem; font-weight: 600;">${jobTitle}</h3>
                            <p style="color: var(--rough-gray); font-size: 0.9rem; margin-bottom: 0.5rem;">${location}</p>
                            
                            ${summaryPreview ? `
                                <p style="color: #555; font-size: 0.85rem; line-height: 1.4; margin-bottom: 0.75rem;">
                                    ${summaryPreview}
                                </p>
                            ` : ''}
                            
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: var(--rough-gray); font-size: 0.85rem;">
                                    ${salary} ‚Ä¢ ${notice}${activelyLooking ? ' ‚Ä¢ Actively looking' : ''}
                                </span>
                                <span style="color: var(--masters-green); font-weight: 600;">View ‚Üí</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // New function to display full profile in right panel
        function viewCandidateProfile(candidate) {
            currentCandidate = candidate;
            
            // On mobile, add class to show profile
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile-profile-active');
            }
            
            // Handle Current Job Title - convert from Float to String if needed
            let rawJobTitle = candidate["Current Job Title"];
            if (typeof rawJobTitle === 'number') {
                rawJobTitle = ''; // If it's a number (float), treat as empty
            }
            const candidateName = toTitleCase(rawJobTitle || candidate["Job Title"] || `Candidate #${candidate.ID}`);
            
            // Track profile view
            trackProfileView(candidate.ID, candidateName);
            
            // Highlight selected item in list
            document.querySelectorAll('.candidate-list-item').forEach(item => {
                item.style.background = 'white';
                item.style.borderColor = '#e5e7eb';
            });
            const selectedCard = document.getElementById(`card-${candidate.ID}`);
            if (selectedCard) {
                selectedCard.style.background = '#f0f8f4';
                selectedCard.style.borderColor = 'var(--masters-green)';
            }
            
            const jobTitle = candidateName;
            const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
            const about = candidate["About You"] || 'No summary provided';
            const skills = candidate["Your Skills"] || '';
            const salary = formatSalaryExact(candidate["What are your salary expectations?"]);
            const notice = formatNoticePeriod(candidate["Notice Period"]);
            const activelyLooking = candidate["Actively looking for work"] || 'Not specified';
            const profileScore = calculateProfileScore(candidate);
            const isTopPick = profileScore >= 85;
            
            const profileDetailView = document.getElementById('profileDetailView');
            profileDetailView.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <div style="flex: 1; min-width: 250px;">
                        <h1 style="color: var(--augusta-green); margin-bottom: 0.5rem; font-size: 1.8rem;">
                            ${jobTitle}
                            ${isTopPick ? '<span class="top-pick-badge" style="position: static; display: inline-block; margin-left: 1rem;">‚≠ê TOP PICK</span>' : ''}
                        </h1>
                        <p style="color: var(--rough-gray); font-size: 1.1rem;">${location}</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary btn-small" onclick="addToShortlistFromProfile()">Save to Shortlist</button>
                        <button class="btn btn-primary btn-small" onclick="openMessageDialog()">Send Message</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                            Salary Expectations
                        </div>
                        <div style="font-weight: 600; font-size: 1.1rem;">${salary}</div>
                    </div>
                    <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                            Notice Period
                        </div>
                        <div style="font-weight: 600; font-size: 1.1rem;">${notice}</div>
                    </div>
                    <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                            Job Search Status
                        </div>
                        <div style="font-weight: 600; font-size: 1.1rem;">${activelyLooking}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Professional Summary</h3>
                    <p style="line-height: 1.8; color: #333; white-space: pre-wrap;">${about}</p>
                </div>
                
                ${skills ? `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Skills & Expertise</h3>
                        <p style="line-height: 1.6; color: #333; white-space: pre-wrap;">${skills}</p>
                    </div>
                ` : ''}
                
                <div class="notes-panel" style="margin-top: 2rem;">
                    <h4 style="color: var(--augusta-green); margin-bottom: 0.5rem;">üìù Private Notes</h4>
                    <textarea id="candidateNotesProfile" class="note-textarea" 
                              placeholder="Add your notes about this candidate...">${candidateNotes[candidate.ID] || ''}</textarea>
                    <button class="btn btn-small" onclick="saveProfileNotes()" style="margin-top: 0.5rem;">Save Notes</button>
                </div>
            `;
        }
        
        // Mobile profile handling
        function closeMobileProfile() {
            document.body.classList.remove('mobile-profile-active');
        }
        
        // Save notes from profile view
        function saveProfileNotes() {
            if (!currentCandidate) return;
            
            const notes = document.getElementById('candidateNotesProfile').value;
            candidateNotes[currentCandidate.ID] = notes;
            localStorage.setItem('candidateNotes_' + currentUser.id, JSON.stringify(candidateNotes));
            alert('Notes saved!');
        }

        // Add functions for profile view actions
        async function addToShortlistFromProfile() {
            if (!currentCandidate) return;
            
            const existing = shortlist.find(item => item.candidate_id === currentCandidate.ID);
            if (existing) {
                alert('Already in shortlist');
                return;
            }
            
            const { data, error } = await supabase
                .from('shortlists')
                .insert({
                    user_id: currentUser.id,
                    candidate_id: currentCandidate.ID
                })
                .select();
            
            if (!error) {
                alert('Added to shortlist!');
                await refreshShortlist();
            }
        }

        function openMessageDialog() {
            if (!currentCandidate) return;
            openCandidate(currentCandidate);
        }

        function loadMore() {
            currentPage++;
            displayCandidatesPage();
        }

        // Filters
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(applyFilters, 300));
            }
            
            ['locationFilter', 'categoryFilter', 'salaryFilter', 'noticeFilter', 'lookingFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', applyFilters);
                }
            });
        });

        function debounce(func, delay) {
            let timeout;
            return function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, arguments), delay);
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const salaryFilter = document.getElementById('salaryFilter').value;
            const noticeFilter = document.getElementById('noticeFilter').value;
            const lookingFilter = document.getElementById('lookingFilter').value;
            
            let filtered = [...allCandidates];
            
            if (searchTerm) {
                filtered = filtered.filter(c => 
                    (c["Current Job Title"] || '').toLowerCase().includes(searchTerm) ||
                    (c["Town/City"] || '').toLowerCase().includes(searchTerm) ||
                    (c["Your Skills"] || '').toLowerCase().includes(searchTerm) ||
                    (c["About You"] || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (locationFilter) {
                filtered = filtered.filter(c => {
                    const location = cleanAndFormatLocation(c["Town/City"], c.Country);
                    return location === locationFilter;
                });
            }
            
            if (categoryFilter) {
                filtered = filtered.filter(c => c.category === categoryFilter);
            }
            
            if (salaryFilter) {
                filtered = filtered.filter(c => {
                    const salary = parseFloat(c["What are your salary expectations?"]) || 0;
                    if (salaryFilter === '70000+') return salary >= 70000;
                    const [min, max] = salaryFilter.split('-').map(Number);
                    return salary >= min && salary <= max;
                });
            }
            
            if (noticeFilter) {
                filtered = filtered.filter(c => {
                    const notice = (c["Notice Period"] || '').toLowerCase();
                    return notice.includes(noticeFilter.toLowerCase());
                });
            }
            
            if (lookingFilter) {
                filtered = filtered.filter(c => 
                    (c["Actively looking for work"] || '').toUpperCase() === lookingFilter
                );
            }
            
            filteredCandidates = filtered;
            currentPage = 0;
            displayCandidatesPage();
        }

        function applySort() {
            const sortValue = document.getElementById('sortSelect').value;
            
            switch (sortValue) {
                case 'relevance':
                    filteredCandidates.sort((a, b) => calculateProfileScore(b) - calculateProfileScore(a));
                    break;
                case 'newest':
                    filteredCandidates.sort((a, b) => {
                        const dateA = new Date(a.created_at || 0);
                        const dateB = new Date(b.created_at || 0);
                        return dateB - dateA;
                    });
                    break;
                case 'salary-high':
                    filteredCandidates.sort((a, b) => {
                        const salaryA = parseFloat(a["What are your salary expectations?"]) || 0;
                        const salaryB = parseFloat(b["What are your salary expectations?"]) || 0;
                        return salaryB - salaryA;
                    });
                    break;
                case 'salary-low':
                    filteredCandidates.sort((a, b) => {
                        const salaryA = parseFloat(a["What are your salary expectations?"]) || 0;
                        const salaryB = parseFloat(b["What are your salary expectations?"]) || 0;
                        return salaryA - salaryB;
                    });
                    break;
            }
            
            currentPage = 0;
            displayCandidatesPage();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('locationFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('salaryFilter').value = '';
            document.getElementById('noticeFilter').value = '';
            document.getElementById('lookingFilter').value = '';
            filteredCandidates = [...allCandidates];
            currentPage = 0;
            displayCandidatesPage();
        }

        // Selection
        function toggleCandidateSelection(candidateId) {
            if (selectedCandidates.has(candidateId)) {
                selectedCandidates.delete(candidateId);
                document.getElementById(`card-${candidateId}`).classList.remove('selected');
            } else {
                selectedCandidates.add(candidateId);
                document.getElementById(`card-${candidateId}`).classList.add('selected');
            }
        }

        function selectAll() {
            displayedCandidates.forEach(candidate => {
                selectedCandidates.add(candidate.ID);
                const card = document.getElementById(`card-${candidate.ID}`);
                if (card) {
                    card.classList.add('selected');
                    const checkbox = card.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = true;
                }
            });
        }

        function deselectAll() {
            selectedCandidates.clear();
            document.querySelectorAll('.candidate-list-item').forEach(card => {
                card.classList.remove('selected');
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = false;
            });
        }

        // Open candidate modal
        async function openCandidate(candidate) {
            currentCandidate = candidate;
            
            // Track profile view
            const candidateName = toTitleCase(candidate["Current Job Title"] || candidate["Job Title"] || `Candidate #${candidate.ID}`);
            await trackProfileView(candidate.ID, candidateName);
            
            const jobTitle = candidateName;
            const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
            const about = candidate["About You"] || 'No summary provided';
            const skills = candidate["Your Skills"] || '';
            const salary = formatSalaryExact(candidate["What are your salary expectations?"]);
            const notice = formatNoticePeriod(candidate["Notice Period"]);
            
            // Check conversation status
            const hasConversation = conversations[candidate.ID]?.messages?.length > 0;
            document.getElementById('creditCost').textContent = hasConversation ? '(Free)' : '(1 Credit)';
            
            // Show previous messages
            const previousMessagesDiv = document.getElementById('previousMessages');
            if (hasConversation) {
                previousMessagesDiv.style.display = 'block';
                previousMessagesDiv.innerHTML = conversations[candidate.ID].messages.map(msg => `
                    <div class="message ${msg.from === 'employer' ? 'sent' : 'received'}">
                        ${msg.text}
                        <div class="message-time">${new Date(msg.timestamp).toLocaleString()}</div>
                    </div>
                `).join('');
            } else {
                previousMessagesDiv.style.display = 'none';
            }
            
            document.getElementById('modalTitle').textContent = jobTitle;
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Professional Summary</h3>
                    <p style="line-height: 1.8;">${about}</p>
                </div>
                ${skills ? `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Skills & Expertise</h3>
                        <p style="line-height: 1.6;">${skills}</p>
                    </div>
                ` : ''}
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Key Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                                Location
                            </div>
                            <div style="font-weight: 600;">${location}</div>
                        </div>
                        <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                                Salary Expectations
                            </div>
                            <div style="font-weight: 600;">${salary}</div>
                        </div>
                        <div style="background: var(--morning-mist); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">
                                Notice Period
                            </div>
                            <div style="font-weight: 600;">${notice}</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('candidateNotes').value = candidateNotes[candidate.ID] || '';
            document.getElementById('candidateModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('candidateModal').classList.remove('active');
        }

        // Notes
        function saveNotes() {
            if (!currentCandidate) return;
            
            const notes = document.getElementById('candidateNotes').value;
            candidateNotes[currentCandidate.ID] = notes;
            localStorage.setItem('candidateNotes_' + currentUser.id, JSON.stringify(candidateNotes));
            alert('Notes saved!');
        }

        // Messaging
        async function sendMessage() {
            if (!currentCandidate) return;
            
            const messageText = document.getElementById('messageText').value.trim();
            if (!messageText) {
                alert('Please enter a message');
                return;
            }
            
            window.pendingMessage = messageText;
            
            const isFirstMessage = !conversations[currentCandidate.ID]?.messages?.length;
            
            if (isFirstMessage) {
                if (userProfile.credits < 1) {
                    alert('Insufficient credits! Contact graham@golf-jobs.com to purchase more.');
                    return;
                }
                
                document.getElementById('currentCreditsMsg').textContent = userProfile.credits;
                document.getElementById('afterCreditsMsg').textContent = userProfile.credits - 1;
                document.getElementById('messageConfirmationDialog').classList.add('active');
                document.getElementById('messageDialogOverlay').classList.add('active');
            } else {
                await processMessage();
            }
        }

        function cancelMessage() {
            document.getElementById('messageConfirmationDialog').classList.remove('active');
            document.getElementById('messageDialogOverlay').classList.remove('active');
            window.pendingMessage = null;
        }

        async function confirmMessage() {
            document.getElementById('messageConfirmationDialog').classList.remove('active');
            document.getElementById('messageDialogOverlay').classList.remove('active');
            await processMessage();
        }

        async function processMessage() {
            if (!currentCandidate || !window.pendingMessage) return;
            
            const messageText = window.pendingMessage;
            const isFirstMessage = !conversations[currentCandidate.ID]?.messages?.length;
            
            if (isFirstMessage) {
                const { error } = await supabase
                    .from('users')
                    .update({ credits: userProfile.credits - 1 })
                    .eq('id', currentUser.id);
                
                if (error) {
                    alert('Error processing message. Please try again.');
                    return;
                }
                
                userProfile.credits--;
                document.getElementById('creditsCount').textContent = userProfile.credits;
            }
            
            if (!conversations[currentCandidate.ID]) {
                conversations[currentCandidate.ID] = {
                    candidateId: currentCandidate.ID,
                    candidateName: toTitleCase(currentCandidate["Current Job Title"] || currentCandidate["Job Title"] || `Candidate #${currentCandidate.ID}`),
                    messages: []
                };
            }
            
            const message = {
                from: 'employer',
                text: messageText,
                timestamp: new Date().toISOString()
            };
            
            conversations[currentCandidate.ID].messages.push(message);
            localStorage.setItem('conversations_' + currentUser.id, JSON.stringify(conversations));
            
            // Save to database
            try {
                await supabase.from('messages').insert({
                    employer_id: currentUser.id,
                    employer_email: currentUser.email,
                    candidate_id: currentCandidate.ID,
                    candidate_name: toTitleCase(currentCandidate["Current Job Title"] || currentCandidate["Job Title"] || `Candidate #${currentCandidate.ID}`),
                    message_text: messageText,
                    is_first_message: isFirstMessage,
                    credit_used: isFirstMessage ? 1 : 0,
                    created_at: new Date().toISOString()
                });
            } catch (err) {
                console.log('Message saved locally');
            }
            
            document.getElementById('messageText').value = '';
            window.pendingMessage = null;
            
            const previousMessagesDiv = document.getElementById('previousMessages');
            previousMessagesDiv.style.display = 'block';
            previousMessagesDiv.innerHTML = conversations[currentCandidate.ID].messages.map(msg => `
                <div class="message ${msg.from === 'employer' ? 'sent' : 'received'}">
                    ${msg.text}
                    <div class="message-time">${new Date(msg.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
            
            document.getElementById('creditCost').textContent = '(Free)';
            alert('Message sent successfully!');
        }

        // Shortlist
        async function addToShortlist() {
            if (!currentCandidate) return;
            
            const existing = shortlist.find(item => item.candidate_id === currentCandidate.ID);
            if (existing) {
                alert('Already in shortlist');
                return;
            }
            
            const { data, error } = await supabase
                .from('shortlists')
                .insert({
                    user_id: currentUser.id,
                    candidate_id: currentCandidate.ID
                })
                .select();
            
            if (!error) {
                alert('Added to shortlist!');
                closeModal();
                await refreshShortlist();
            }
        }

        async function bulkAddToShortlist() {
            if (selectedCandidates.size === 0) {
                alert('Please select candidates first');
                return;
            }
            
            let added = 0;
            
            for (const candidateId of selectedCandidates) {
                const existing = shortlist.find(item => item.candidate_id === candidateId);
                if (!existing) {
                    const { data } = await supabase
                        .from('shortlists')
                        .insert({
                            user_id: currentUser.id,
                            candidate_id: candidateId
                        })
                        .select();
                    
                    if (data) added++;
                }
            }
            
            alert(`Added ${added} candidates to shortlist`);
            deselectAll();
            await refreshShortlist();
        }

        async function loadShortlist() {
            const content = document.getElementById('shortlistContent');
            
            await refreshShortlist();
            
            if (!shortlist || shortlist.length === 0) {
                content.innerHTML = `
                    <div class="section-box" style="text-align: center;">
                        <h2>No candidates saved yet</h2>
                        <p style="color: var(--rough-gray); margin-bottom: 1rem;">Browse talent pools and save candidates you're interested in.</p>
                        <button class="btn btn-primary" onclick="switchView('pools')">Browse Talent Pools</button>
                    </div>
                `;
                return;
            }
            
            // Remove duplicates based on candidate_id
            const uniqueShortlist = [];
            const seenCandidates = new Set();
            
            for (const item of shortlist) {
                if (!seenCandidates.has(item.candidate_id)) {
                    seenCandidates.add(item.candidate_id);
                    uniqueShortlist.push(item);
                }
            }
            
            content.innerHTML = '<div class="candidates-grid" id="shortlistGrid"></div>';
            const grid = document.getElementById('shortlistGrid');
            
            grid.innerHTML = uniqueShortlist.map(item => {
                const candidate = item.candidates;
                if (!candidate) return '';
                
                const jobTitle = toTitleCase(candidate["Current Job Title"] || candidate["Job Title"] || `Candidate #${candidate.ID}`);
                const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                const salary = formatSalaryExact(candidate["What are your salary expectations?"]);
                const notice = formatNoticePeriod(candidate["Notice Period"]);
                const notes = candidateNotes[candidate.ID] || '';
                
                return `
                    <div class="candidate-card" style="position: relative;">
                        <button onclick="removeFromShortlist('${item.id}')" 
                                style="position: absolute; top: 1rem; right: 1rem; 
                                       background: #fee; color: var(--hazard-red); 
                                       border: none; padding: 0.5rem 1rem; 
                                       border-radius: 8px; cursor: pointer; z-index: 10;
                                       font-size: 0.85rem;">
                            Remove
                        </button>
                        <div onclick='openCandidate(${JSON.stringify(candidate).replace(/'/g, "&apos;")})'
                             style="cursor: pointer;">
                            <h3 style="color: var(--augusta-green); margin-bottom: 0.5rem; padding-right: 80px;">
                                ${jobTitle}
                            </h3>
                            <p style="color: var(--rough-gray); font-size: 0.9rem; margin-bottom: 1rem;">
                                ${location}
                            </p>
                            ${notes ? `
                                <div style="background: #fffef5; border-left: 3px solid var(--club-gold); 
                                           padding: 0.5rem; margin: 0.75rem 0; border-radius: 4px;">
                                    <p style="font-size: 0.85rem; color: var(--club-gold); margin: 0;">
                                        üìù Note: ${notes.substring(0, 100)}${notes.length > 100 ? '...' : ''}
                                    </p>
                                </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; align-items: center; 
                                        padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                <span style="color: var(--rough-gray); font-size: 0.9rem;">
                                    ${salary} ‚Ä¢ ${notice}
                                </span>
                                <span style="color: var(--masters-green); font-weight: 600;">View ‚Üí</span>
                            </div>
                        </div>
                    </div>
                `;
            }).filter(html => html !== '').join('');
        }

        async function removeFromShortlist(shortlistId) {
            if (!confirm('Remove from shortlist?')) return;
            
            try {
                const { error } = await supabase
                    .from('shortlists')
                    .delete()
                    .eq('id', shortlistId);
                
                if (error) {
                    console.error('Error removing from shortlist:', error);
                    alert('Error removing candidate. Please try again.');
                    return;
                }
                
                await refreshShortlist();
                await loadShortlist();
            } catch (err) {
                console.error('Error:', err);
                alert('Error removing candidate. Please try again.');
            }
        }

        function exportShortlist() {
            if (shortlist.length === 0) {
                alert('No candidates in shortlist');
                return;
            }
            
            let csv = 'Job Title,Location,Salary,Notice Period,Notes\n';
            
            shortlist.forEach(item => {
                const c = item.candidates;
                if (c) {
                    const jobTitle = toTitleCase(c["Current Job Title"] || c["Job Title"] || '');
                    const location = cleanAndFormatLocation(c["Town/City"], c.Country);
                    const salary = c["What are your salary expectations?"] || 'Negotiable';
                    const notice = c["Notice Period"] || 'Unknown';
                    const notes = candidateNotes[c.ID] || '';
                    
                    csv += `"${jobTitle}","${location}","${salary}","${notice}","${notes}"\n`;
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'shortlist.csv';
            a.click();
        }

        // Messages
        function loadMessages() {
            const content = document.getElementById('conversationsList');
            const conversationsList = Object.values(conversations);
            
            if (conversationsList.length === 0) {
                content.innerHTML = `
                    <div class="section-box" style="text-align: center;">
                        <h2>No messages yet</h2>
                        <p style="color: var(--rough-gray); margin-bottom: 1rem;">Start a conversation by messaging candidates.</p>
                        <button class="btn btn-primary" onclick="switchView('pools')">Browse Candidates</button>
                    </div>
                `;
            } else {
                content.innerHTML = conversationsList.map(conv => {
                    const lastMessage = conv.messages[conv.messages.length - 1];
                    return `
                        <div class="section-box" style="cursor: pointer; margin-bottom: 1rem;" 
                             onclick="openConversation('${conv.candidateId}')">
                            <h3 style="color: var(--augusta-green);">${conv.candidateName}</h3>
                            <p style="color: var(--rough-gray);">Last: ${lastMessage.text.substring(0, 100)}...</p>
                            <p style="font-size: 0.85rem; color: var(--rough-gray);">
                                ${new Date(lastMessage.timestamp).toLocaleString()} ‚Ä¢ ${conv.messages.length} messages
                            </p>
                        </div>
                    `;
                }).join('');
            }
        }

        async function openConversation(candidateId) {
            let candidate = allCandidates.find(c => c.ID == candidateId);
            
            if (!candidate) {
                const { data } = await supabase
                    .from('candidates')
                    .select('*')
                    .eq('ID', candidateId)
                    .single();
                
                if (data) candidate = data;
            }
            
            if (candidate) openCandidate(candidate);
        }

        // Account
        function loadAccount() {
            document.getElementById('accountName').textContent = userProfile?.name || '-';
            document.getElementById('accountEmail').textContent = currentUser?.email || '-';
            document.getElementById('accountCredits').textContent = userProfile?.credits || 0;
            
            let totalMessages = 0;
            Object.values(conversations).forEach(conv => {
                totalMessages += conv.messages.filter(m => m.from === 'employer').length;
            });
            document.getElementById('totalMessages').textContent = totalMessages;
        }

        // Admin
        async function loadAdmin() {
            if (userProfile?.role !== 'admin') {
                document.getElementById('adminView').innerHTML = '<p style="text-align: center; color: var(--hazard-red);">Access denied.</p>';
                return;
            }
            
            // Load analytics
            await loadAnalytics();
            
            // Load users
            try {
                const { data: allUsers } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                const usersList = document.getElementById('adminUsersList');
                if (allUsers && allUsers.length > 0) {
                    document.getElementById('activeUsers').textContent = allUsers.length;
                    
                    usersList.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb;">
                                    <th style="padding: 1rem; text-align: left;">Name</th>
                                    <th style="padding: 1rem; text-align: left;">Email</th>
                                    <th style="padding: 1rem; text-align: left;">Credits</th>
                                    <th style="padding: 1rem; text-align: left;">Joined</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allUsers.map(user => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 1rem;">${user.name || 'Not set'}</td>
                                        <td style="padding: 1rem;">${user.email}</td>
                                        <td style="padding: 1rem;">${user.credits || 0}</td>
                                        <td style="padding: 1rem;">${new Date(user.created_at).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (err) {
                console.error('Error loading users:', err);
            }
            
            // Load messages
            try {
                const { data: allMessages } = await supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (allMessages && allMessages.length > 0) {
                    document.getElementById('totalMessagesAdmin').textContent = allMessages.length;
                    
                    const messagesList = document.getElementById('adminMessagesList');
                    messagesList.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb;">
                                    <th style="padding: 0.75rem; text-align: left;">Date</th>
                                    <th style="padding: 0.75rem; text-align: left;">Employer</th>
                                    <th style="padding: 0.75rem; text-align: left;">Candidate</th>
                                    <th style="padding: 0.75rem; text-align: left;">Message</th>
                                    <th style="padding: 0.75rem; text-align: left;">Credits</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allMessages.map(msg => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 0.75rem; font-size: 0.85rem;">
                                            ${new Date(msg.created_at).toLocaleDateString()}
                                        </td>
                                        <td style="padding: 0.75rem; font-size: 0.85rem;">
                                            ${msg.employer_email}
                                        </td>
                                        <td style="padding: 0.75rem; font-size: 0.85rem;">
                                            ${msg.candidate_name || `ID: ${msg.candidate_id}`}
                                        </td>
                                        <td style="padding: 0.75rem; font-size: 0.85rem;">
                                            ${msg.message_text.substring(0, 100)}...
                                        </td>
                                        <td style="padding: 0.75rem; font-size: 0.85rem;">
                                            ${msg.is_first_message ? 
                                                '<span style="background: #ffc107; padding: 2px 6px; border-radius: 4px;">1</span>' : 
                                                '<span style="background: #e9ecef; padding: 2px 6px; border-radius: 4px;">0</span>'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (err) {
                console.error('Error loading messages:', err);
            }
        }

        async function loadAnalytics() {
            // Get profile views from database
            try {
                const { data: views } = await supabase
                    .from('profile_views')
                    .select('candidate_id, candidate_name');
                
                // Count views per candidate
                const viewCounts = {};
                if (views) {
                    views.forEach(view => {
                        if (!viewCounts[view.candidate_id]) {
                            viewCounts[view.candidate_id] = {
                                name: view.candidate_name,
                                count: 0
                            };
                        }
                        viewCounts[view.candidate_id].count++;
                    });
                }
                
                // Also add local views
                Object.entries(profileViews).forEach(([id, data]) => {
                    if (viewCounts[id]) {
                        viewCounts[id].count += data.count;
                    } else {
                        viewCounts[id] = data;
                    }
                });
                
                // Sort and display most viewed
                const sortedViews = Object.entries(viewCounts)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 10);
                
                const totalViews = Object.values(viewCounts).reduce((sum, v) => sum + v.count, 0);
                document.getElementById('totalViews').textContent = totalViews;
                
                document.getElementById('mostViewedList').innerHTML = sortedViews.map((item, index) => `
                    <li>
                        <div style="display: flex; align-items: center;">
                            <span class="rank-badge">#${index + 1}</span>
                            <span>${item[1].name || `Candidate #${item[0]}`}</span>
                        </div>
                        <span style="color: var(--masters-green); font-weight: 600;">
                            ${item[1].count} views
                        </span>
                    </li>
                `).join('') || '<li>No data yet</li>';
            } catch (err) {
                console.error('Error loading analytics:', err);
            }
            
            // Get message counts
            try {
                const { data: messages } = await supabase
                    .from('messages')
                    .select('candidate_id, candidate_name');
                
                const messageCounts = {};
                if (messages) {
                    messages.forEach(msg => {
                        if (!messageCounts[msg.candidate_id]) {
                            messageCounts[msg.candidate_id] = {
                                name: msg.candidate_name,
                                count: 0
                            };
                        }
                        messageCounts[msg.candidate_id].count++;
                    });
                }
                
                const sortedMessages = Object.entries(messageCounts)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 10);
                
                document.getElementById('mostMessagedList').innerHTML = sortedMessages.map((item, index) => `
                    <li>
                        <div style="display: flex; align-items: center;">
                            <span class="rank-badge">#${index + 1}</span>
                            <span>${item[1].name || `Candidate #${item[0]}`}</span>
                        </div>
                        <span style="color: var(--masters-green); font-weight: 600;">
                            ${item[1].count} messages
                        </span>
                    </li>
                `).join('') || '<li>No messages yet</li>';
            } catch (err) {
                console.error('Error loading message counts:', err);
            }
        }

        function goHome() {
            switchView('pools');
        }

        // Modal close on click outside
        document.getElementById('candidateModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>
</body>
</html>
