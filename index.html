<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Jobs - Premium Talent Pools</title>
    <link rel="icon" href="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20white.png?updatedAt=1758280288759">
    <link rel="apple-touch-icon" sizes="180x180" href="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20white.png?updatedAt=1758280288759">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --augusta-green: #004d26;
            --fairway-green: #2d5f3f;
            --masters-green: #3a7858;
            --putting-green: #6b9080;
            --club-gold: #c9a961;
            --trophy-gold: #f4d03f;
            --sand-bunker: #f5e6d3;
            --morning-mist: #f8f9fa;
            --pro-shop-navy: #1a2332;
            --scorecard-white: #ffffff;
            --rough-gray: #6c757d;
            --hazard-red: #c9302c;
            --water-hazard: #2c5aa0;
        }
        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: var(--pro-shop-navy);
            background: linear-gradient(180deg, #f8f9fa 0%, #e8efe8 100%);
            min-height: 100vh;
        }
        h1, h2, h3, h4, h5, h6 { font-family: 'Poppins', sans-serif; font-weight: 600; }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-card { height: 250px; border-radius: 16px; margin-bottom: 1.75rem; }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--augusta-green);
        }
        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 450px;
            animation: slideUp 0.5s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .login-title {
            text-align: center;
            color: var(--augusta-green);
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
            font-weight: 700;
        }
        .login-subtitle {
            text-align: center;
            color: var(--rough-gray);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }
        .form-group { margin-bottom: 1.5rem; }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--pro-shop-navy);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e1e8e4;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--masters-green);
            box-shadow: 0 0 0 3px rgba(58, 120, 88, 0.1);
        }
        .btn-login {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--masters-green) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Poppins', sans-serif;
        }
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 77, 38, 0.3);
        }
        .login-error {
            background: #fee;
            color: var(--hazard-red);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }
        
        .main-app { display: none; }
        .main-app.active { display: block; }
        
        .header {
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--fairway-green) 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
        }
        .logo img { height: 60px; }
        .nav-tabs { display: flex; gap: 0.5rem; }
        .nav-tab {
            padding: 0.625rem 1.25rem;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        .nav-tab.active {
            background: var(--club-gold);
            color: var(--augusta-green);
            font-weight: 600;
        }
        .shortlist-badge {
            background: rgba(255,255,255,0.3);
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            margin-left: 0.25rem;
            font-size: 0.875rem;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 12px;
        }
        .credits-badge {
            background: linear-gradient(135deg, var(--club-gold) 0%, var(--trophy-gold) 100%);
            color: var(--augusta-green);
            padding: 0.375rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
        }
        .btn-logout {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-logout:hover { background: rgba(255,255,255,0.3); }
        
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.75rem;
            cursor: pointer;
            padding: 0.5rem;
        }
        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 999;
        }
        .mobile-nav-overlay.active { display: block; }
        .mobile-nav-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background: white;
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 4px 0 12px rgba(0,0,0,0.2);
        }
        .mobile-nav-menu.active { left: 0; }
        .mobile-nav-header {
            background: var(--augusta-green);
            color: white;
            padding: 1.5rem;
        }
        .mobile-user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .mobile-nav-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
        }
        .mobile-credits {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .mobile-nav-items { padding: 1rem 0; }
        .mobile-nav-item {
            display: block;
            padding: 1rem 1.5rem;
            color: var(--pro-shop-navy);
            text-decoration: none;
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .mobile-nav-item:hover, .mobile-nav-item.active {
            background: #f8f9fa;
            border-left-color: var(--augusta-green);
            color: var(--augusta-green);
        }
        .mobile-nav-item.logout { color: var(--hazard-red); }
        
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        .view-section { display: none; }
        .view-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .pool-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        .pool-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        .pool-card.locked {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .pool-header {
            background: linear-gradient(135deg, var(--fairway-green) 0%, var(--masters-green) 100%);
            padding: 2rem;
            color: white;
            position: relative;
        }
        .pool-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            padding-right: 120px;
        }
        .pool-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--club-gold);
            color: var(--augusta-green);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 700;
            z-index: 10;
        }
        .pool-stats { padding: 2rem; }
        .pool-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .pool-stat:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .filter-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .sorting-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .sort-options {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .top-pick-badge {
            position: absolute;
            top: -12px;
            right: 15px;
            background: linear-gradient(135deg, var(--club-gold) 0%, var(--trophy-gold) 100%);
            color: var(--augusta-green);
            padding: 0.4rem 0.9rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            z-index: 5;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            color: var(--rough-gray);
        }
        .breadcrumb a {
            color: var(--masters-green);
            text-decoration: none;
            font-weight: 600;
        }
        .breadcrumb a:hover { color: var(--augusta-green); }
        
        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--augusta-green) 0%, var(--masters-green) 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 77, 38, 0.3);
        }
        .btn-secondary {
            background: white;
            color: var(--augusta-green);
            border: 2px solid var(--augusta-green);
        }
        .btn-secondary:hover {
            background: var(--augusta-green);
            color: white;
        }
        .btn-danger {
            background: var(--hazard-red);
            color: white;
        }
        .btn-danger:hover { background: #a02222; }
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .empty-state h3 {
            color: var(--augusta-green);
            margin-bottom: 1rem;
        }
        .empty-state p {
            color: var(--rough-gray);
            margin-bottom: 2rem;
        }
        
        .load-more-container {
            text-align: center;
            padding: 2rem;
        }
        .load-more-btn {
            padding: 0.875rem 2rem;
            background: white;
            color: var(--augusta-green);
            border: 2px solid var(--augusta-green);
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .load-more-btn:hover {
            background: var(--augusta-green);
            color: white;
        }
        
        .section-box {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        .error-message {
            background: #fee;
            color: var(--hazard-red);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }
        
        .candidates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 1.75rem;
            margin-bottom: 2rem;
        }
        .candidate-card {
            background: white;
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
            position: relative;
            cursor: pointer;
        }
        .candidate-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 24px rgba(0,0,0,0.1);
            border-color: var(--masters-green);
        }
        .candidate-card.selected {
            background: #f0f8f4;
            border-color: var(--masters-green);
        }
        
        .split-view-container {
            display: flex;
            gap: 1.5rem;
            height: calc(100vh - 350px);
            min-height: 600px;
        }
        .split-view-left {
            width: 40%;
            overflow-y: auto;
            padding-right: 1rem;
            border-right: 1px solid #e5e7eb;
        }
        .split-view-right {
            flex: 1;
            overflow-y: auto;
            padding-left: 1rem;
        }
        .mobile-back-btn { display: none; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 35, 50, 0.95);
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }
        .modal.active { display: block; }
        .modal-content {
            background: white;
            margin: 3% auto;
            padding: 2rem;
            width: 90%;
            max-width: 700px;
            border-radius: 20px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--rough-gray);
        }
        .modal-close:hover { color: var(--pro-shop-navy); }
        
        .notes-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 2rem;
        }
        .note-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--masters-green);
        }
        .note-text {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }
        .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--rough-gray);
        }
        .note-actions {
            display: flex;
            gap: 0.5rem;
        }
        .note-actions button {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 6px;
        }
        
        .message-thread {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #e5e7eb;
    position: relative;
}
.message-thread:hover {
    border-color: var(--masters-green);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.message-thread.unread {
    background: #f0f8f4;
    border-color: var(--masters-green);
}
.message-thread.starred::before {
    content: '⭐';
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 1.2rem;
}
.message-thread.archived {
    opacity: 0.6;
}
.message-preview {
    color: var(--rough-gray);
    margin-top: 0.5rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.message-conversation {
    max-height: 500px;
    overflow-y: auto;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 12px;
    margin-bottom: 1rem;
}
.message-bubble {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    margin-bottom: 1rem;
    max-width: 80%;
    position: relative;
}
.message-bubble.sent {
    margin-left: auto;
    background: var(--masters-green);
    color: white;
}
.message-bubble.received {
    background: white;
    border: 1px solid #e5e7eb;
}
.message-bubble .message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 0.5rem;
}
.message-attachment {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(0,0,0,0.1);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    margin-top: 0.5rem;
    cursor: pointer;
}
.message-bubble.sent .message-attachment {
    background: rgba(255,255,255,0.2);
}
.message-input-area {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}
.message-editor {
    border: 2px solid #e1e8e4;
    border-radius: 12px;
    background: white;
}
.editor-toolbar {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem;
    border-bottom: 1px solid #e1e8e4;
    flex-wrap: wrap;
}
.editor-btn {
    padding: 0.5rem 0.75rem;
    background: #f8f9fa;
    border: 1px solid #e1e8e4;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
}
.editor-btn:hover {
    background: #e5e7eb;
}
.editor-btn.active {
    background: var(--masters-green);
    color: white;
    border-color: var(--masters-green);
}
.message-input {
    padding: 1rem;
    border: none;
    font-size: 1rem;
    font-family: inherit;
    resize: vertical;
    min-height: 120px;
    outline: none;
}
.message-input:focus {
    outline: none;
}
.attachment-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 0 1rem 1rem 1rem;
}
.attachment-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #f8f9fa;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    font-size: 0.85rem;
}
.attachment-item button {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--hazard-red);
    padding: 0;
    font-size: 1rem;
}
.char-count {
    padding: 0 1rem 0.75rem 1rem;
    text-align: right;
    font-size: 0.85rem;
    color: var(--rough-gray);
}
.char-count.warning {
    color: var(--hazard-red);
}
.message-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.emoji-picker {
    position: relative;
}
.emoji-popup {
    position: absolute;
    bottom: 100%;
    left: 0;
    background: white;
    border: 2px solid #e1e8e4;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: none;
    max-width: 300px;
    z-index: 100;
}
.emoji-popup.active {
    display: block;
}
.emoji-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 0.5rem;
}
.emoji-btn {
    font-size: 1.5rem;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: background 0.2s;
}
.emoji-btn:hover {
    background: #f8f9fa;
}
.message-filters {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}
.filter-row {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}
.unread-badge {
    background: var(--hazard-red);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 600;
}
.thread-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: var(--rough-gray);
}
.thread-actions {
    display: flex;
    gap: 0.5rem;
}
.thread-action-btn {
    background: none;
    border: 1px solid #e1e8e4;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
}
.thread-action-btn:hover {
    background: #f8f9fa;
}
.search-within {
    margin-bottom: 1rem;
}
.search-within input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e1e8e4;
    border-radius: 8px;
    font-size: 0.95rem;
}
.follow-up-reminder {
    background: #fff3cd;
    border-left: 4px solid #f4d03f;
    padding: 0.75rem;
    border-radius: 8px;
    margin-top: 1rem;
    font-size: 0.9rem;
}
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}
.analytics-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
}
.analytics-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--augusta-green);
    margin: 0.5rem 0;
}
.analytics-label {
    font-size: 0.9rem;
    color: var(--rough-gray);
}
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .admin-table thead tr {
            border-bottom: 2px solid var(--augusta-green);
        }
        .admin-table th {
            text-align: left;
            padding: 0.75rem;
            font-weight: 600;
            color: var(--augusta-green);
        }
        .admin-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .admin-table tbody tr:hover { background: #f8f9fa; }
        .admin-table tbody tr { cursor: pointer; }
        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .role-badge.admin {
            background: var(--club-gold);
            color: var(--augusta-green);
        }
        .role-badge.employer {
            background: #e5e7eb;
            color: var(--pro-shop-navy);
        }
        
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .mobile-menu-toggle { display: block; }
            .nav-tabs, .user-info { display: none; }
            .header-content { padding: 0 1rem; }
            .container {
                padding: 0 1rem;
                margin: 1rem auto;
            }
            .split-view-container {
                display: block !important;
                height: auto !important;
            }
            .split-view-left {
                width: 100% !important;
                border-right: none !important;
                padding-right: 0 !important;
            }
            .split-view-right { display: none !important; }
            .split-view-right.mobile-active {
                display: block !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 1500;
                background: white;
                overflow-y: auto;
                padding: 1rem !important;
                width: 100%;
            }
            .mobile-back-btn {
                display: inline-block !important;
                padding: 0.75rem 1.5rem;
                background: var(--augusta-green);
                color: white;
                border: none;
                border-radius: 8px;
                margin-bottom: 1rem;
                cursor: pointer;
                font-weight: 600;
            }
            .filter-panel > div { flex-direction: column; }
            .filter-panel select, .filter-panel input {
                width: 100%;
                margin-bottom: 0.75rem;
            }
            .sorting-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            .sort-options {
                width: 100%;
                justify-content: flex-start;
            }
            .bulk-actions {
                width: 100%;
                justify-content: space-between;
                flex-wrap: nowrap;
            }
            .bulk-actions .btn {
                flex: 1;
                padding: 0.5rem 0.5rem;
                font-size: 0.8rem;
            }
            .pools-grid, .candidates-grid { grid-template-columns: 1fr !important; }
            .pool-card, .candidate-card { margin-bottom: 1rem; }
            .admin-table { font-size: 0.85rem; }
            .admin-table th, .admin-table td { padding: 0.5rem 0.25rem; }
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div style="text-align: center; margin-bottom: 2rem;">
                <img src="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20black.png?updatedAt=1757017924442" alt="Golf Jobs" style="width: 200px;">
            </div>
            <h1 class="login-title">Talent Pool Access</h1>
            <p class="login-subtitle">Exclusive recruitment platform</p>
            <div id="loginError" class="login-error">Invalid credentials. Please try again.</div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="loginEmail" required placeholder="your@company.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn-login">Sign In</button>
            </form>
            <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e1e8e4;">
                <p style="color: var(--rough-gray); font-size: 0.85rem;">© 2025 Golf Jobs. Professional recruitment excellence.</p>
                <p style="margin-top: 0.5rem; color: var(--rough-gray); font-size: 0.85rem;">Need access? Contact <strong>graham@golf-jobs.com</strong></p>
            </div>
        </div>
    </div>

    <div id="mainApp" class="main-app">
        <header class="header">
            <div class="header-content">
                <div class="logo" onclick="goHome()">
                    <img src="https://ik.imagekit.io/golfjobs/Golf%20Jobs%20logo%20white.png?updatedAt=1758280288759" alt="Golf Jobs">
                </div>
                <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
                <nav class="nav-tabs">
                    <button class="nav-tab active" onclick="switchView('pools')">Talent Pools</button>
                    <button class="nav-tab" onclick="switchView('shortlist')">
                        Your Lists <span id="shortlistBadge" class="shortlist-badge" style="display: none;">0</span>
                    </button>
                    <button class="nav-tab" onclick="switchView('messages')">Messages</button>
                    <button class="nav-tab" onclick="switchView('account')">My Account</button>
                    <button id="adminTab" class="nav-tab" onclick="switchView('admin')" style="display:none;">Admin</button>
                </nav>
                <div class="user-info">
                    <span id="userName">Welcome</span>
                    <div class="credits-badge">
                        Credits: <span id="creditsCount">0</span>
                    </div>
                    <button class="btn-logout" onclick="handleLogout()">Sign Out</button>
                </div>
            </div>
        </header>

        <div id="mobileNavOverlay" class="mobile-nav-overlay" onclick="toggleMobileMenu()"></div>
        <nav id="mobileNavMenu" class="mobile-nav-menu">
            <div class="mobile-nav-header">
                <div class="mobile-user-info">
                    <div>
                        <div id="mobileUserName" style="font-weight: 600; margin-bottom: 0.25rem;">Menu</div>
                        <div class="mobile-credits">
                            Credits: <span id="mobileCreditsCount">0</span>
                        </div>
                    </div>
                    <button class="mobile-nav-close" onclick="toggleMobileMenu()">×</button>
                </div>
            </div>
            <div class="mobile-nav-items">
                <a href="#" class="mobile-nav-item active" onclick="switchViewMobile('pools')">Talent Pools</a>
                <a href="#" class="mobile-nav-item" onclick="switchViewMobile('shortlist')">
                    Your Lists <span id="mobileShortlistBadge" style="display:none;"></span>
                </a>
                <a href="#" class="mobile-nav-item" onclick="switchViewMobile('messages')">Messages</a>
                <a href="#" class="mobile-nav-item" onclick="switchViewMobile('account')">My Account</a>
                <a href="#" id="mobileAdminItem" class="mobile-nav-item" style="display:none;" onclick="switchViewMobile('admin')">Admin</a>
                <hr style="margin: 1rem 0; border: none; border-top: 1px solid #e5e7eb;">
                <a href="#" class="mobile-nav-item logout" onclick="handleLogout()">Sign Out</a>
            </div>
        </nav>

        <div class="container">
            <div id="poolsView" class="view-section active">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Your Talent Pools</h1>
                <p style="color: var(--rough-gray); margin-bottom: 2rem; font-size: 1.1rem;">Select a talent pool to browse candidates</p>
                <div class="pools-grid" id="poolsGrid">
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
            </div>

            <div id="poolDetailView" class="view-section">
                <div class="breadcrumb">
                    <a href="#" onclick="switchView('pools')">Talent Pools</a>
                    <span>→</span>
                    <span id="currentPoolName">Pool Name</span>
                </div>
                <div class="filter-panel" id="filterPanel">
                    <input type="text" id="searchInput" placeholder="Search by name, role, skills, or location..." 
                           style="width: 100%; padding: 0.875rem; border: 2px solid #e1e8e4; border-radius: 12px; font-size: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-start;">
                        <select id="locationFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Locations</option>
                        </select>
                        <select id="categoryFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Categories</option>
                            <option value="greenkeeping">Greenkeeping</option>
                            <option value="management">Management</option>
                            <option value="pga">PGA Professional</option>
                            <option value="marketing">Marketing</option>
                            <option value="sales">Sales</option>
                            <option value="hospitality">Hospitality</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="admin">Admin/Office</option>
                            <option value="retail">Retail/Pro Shop</option>
                            <option value="f&b">F&B/Catering</option>
                        </select>
                        <select id="salaryFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Salaries</option>
                            <option value="0-30000">£20-30k</option>
                            <option value="30000-40000">£30-40k</option>
                            <option value="40000-50000">£40-50k</option>
                            <option value="50000-60000">£50-60k</option>
                            <option value="60000-70000">£60-70k</option>
                            <option value="70000+">£70k+</option>
                        </select>
                        <select id="noticeFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">All Notice Periods</option>
                            <option value="immediately">Available Immediately</option>
                            <option value="1 week">1 Week</option>
                            <option value="1 month">1 Month</option>
                            <option value="2 months">2 Months</option>
                            <option value="3 months">3 Months</option>
                        </select>
                        <select id="lookingFilter" style="padding: 0.5rem 1rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                            <option value="">Active/Passive</option>
                            <option value="YES">Actively Looking</option>
                            <option value="NO">Not Actively Looking</option>
                        </select>
                        <button onclick="clearFilters()" class="btn btn-small" style="background: #e5e7eb; color: var(--rough-gray);">
                            Clear All
                        </button>
                    </div>
                </div>
                <div class="sorting-bar">
                    <div class="sort-options">
                        <label style="margin-right: 0.5rem; color: var(--rough-gray);">Sort by:</label>
                        <select id="sortSelect" onchange="applySort()" style="padding: 0.5rem; border: 1px solid #e1e8e4; border-radius: 8px;">
                            <option value="relevance">Best Match</option>
                            <option value="newest">Newest First</option>
                            <option value="salary-high">Salary (High to Low)</option>
                            <option value="salary-low">Salary (Low to High)</option>
                        </select>
                    </div>
                    <div class="bulk-actions">
                        <button class="btn btn-small btn-secondary" onclick="selectAll()">Select All</button>
                        <button class="btn btn-small btn-secondary" onclick="deselectAll()">Clear Selection</button>
                        <button class="btn btn-small btn-primary" onclick="bulkAddToShortlist()">Add to List</button>
                    </div>
                </div>
                <div id="candidateCount" style="margin-bottom: 1rem; color: var(--rough-gray);"></div>
                <div class="split-view-container">
                    <div class="split-view-left">
                        <div id="candidatesListView">
                            <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
                            <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
                            <div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>
                        </div>
                        <div class="load-more-container" id="loadMoreContainer" style="display: none; padding: 1rem 0;">
                            <button class="load-more-btn" onclick="loadMore()" style="width: 100%;">Load More</button>
                        </div>
                    </div>
                    <div class="split-view-right">
                        <button class="mobile-back-btn" onclick="closeMobileProfile()">← Back to List</button>
                        <div id="profileDetailView" style="background: white; border-radius: 16px; padding: 2rem; min-height: 100%;">
                            <div style="text-align: center; color: var(--rough-gray); padding: 4rem 2rem;">
                                <h3 style="margin-bottom: 1rem;">Select a candidate</h3>
                                <p>Click on any candidate from the list to view their full profile</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="shortlistView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Your Lists</h1>
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;">
                        <select id="listSelector" onchange="switchList()" style="padding: 0.875rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 1rem; min-width: 250px; background: white;">
                            <option value="">Select a list...</option>
                        </select>
                        <button id="deleteCurrentListBtn" onclick="deleteCurrentList()" class="btn btn-danger btn-small" style="display: none;">Delete List</button>
                        <button class="btn btn-primary" onclick="showCreateListModal()">+ New List</button>
                    </div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary btn-small" onclick="exportShortlist()">Export List</button>
                        <button class="btn btn-danger btn-small" onclick="bulkDeleteFromShortlist()" id="bulkDeleteBtn" style="display: none;">Delete Selected</button>
                    </div>
                </div>
                <div class="sorting-bar" style="margin-bottom: 1rem;">
                    <div style="color: var(--rough-gray);" id="shortlistCount">Select a list to view candidates</div>
                    <div class="bulk-actions">
                        <button class="btn btn-small btn-secondary" onclick="selectAllShortlist()">Select All</button>
                        <button class="btn btn-small btn-secondary" onclick="deselectAllShortlist()">Clear Selection</button>
                    </div>
                </div>
                <div class="split-view-container">
                    <div class="split-view-left">
                        <div id="shortlistContent"></div>
                    </div>
                    <div class="split-view-right">
                        <button class="mobile-back-btn" onclick="closeMobileProfile()">← Back to List</button>
                        <div id="shortlistProfileView" style="background: white; border-radius: 16px; padding: 2rem; min-height: 100%;">
                            <div style="text-align: center; color: var(--rough-gray); padding: 4rem 2rem;">
                                <h3 style="margin-bottom: 1rem;">Select a candidate</h3>
                                <p>Click on any candidate from your list to view their full profile</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="messagesView" class="view-section">
    <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 1rem;">Messages</h1>
    
    <!-- Analytics Dashboard -->
    <div class="analytics-grid" id="messageAnalytics" style="display: none;">
        <div class="analytics-card">
            <div class="analytics-label">Total Conversations</div>
            <div class="analytics-value" id="totalConversations">0</div>
        </div>
        <div class="analytics-card">
            <div class="analytics-label">Response Rate</div>
            <div class="analytics-value" id="responseRate">0%</div>
        </div>
        <div class="analytics-card">
            <div class="analytics-label">Avg Response Time</div>
            <div class="analytics-value" id="avgResponseTime">-</div>
        </div>
        <div class="analytics-card">
            <div class="analytics-label">Credits Used</div>
            <div class="analytics-value" id="creditsUsed">0</div>
        </div>
    </div>
    
    <!-- Message Filters -->
    <div class="message-filters" id="messageFilters">
        <div class="filter-row">
            <input type="text" id="messageSearchInput" placeholder="Search conversations..." 
                   style="flex: 1; padding: 0.75rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
            <select id="messageFilterSelect" onchange="applyMessageFilters()" 
                    style="padding: 0.75rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                <option value="all">All Messages</option>
                <option value="unread">Unread Only</option>
                <option value="starred">Starred</option>
                <option value="archived">Archived</option>
                <option value="awaiting">Awaiting Response</option>
                <option value="no_response">No Response (7+ days)</option>
            </select>
            <select id="messageSortSelect" onchange="applyMessageFilters()" 
                    style="padding: 0.75rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 0.95rem;">
                <option value="recent">Most Recent</option>
                <option value="oldest">Oldest First</option>
                <option value="unread_first">Unread First</option>
            </select>
            <button class="btn btn-secondary btn-small" onclick="toggleAnalytics()">Analytics</button>
        </div>
    </div>
    
    <!-- Conversations List -->
    <div id="conversationsList"></div>
    
    <!-- Conversation Detail -->
    <div id="conversationDetail" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <button class="btn btn-secondary btn-small" onclick="backToConversations()">← Back to Messages</button>
            <div class="thread-actions">
                <button class="thread-action-btn" onclick="toggleStarConversation()" id="starBtn">⭐ Star</button>
                <button class="thread-action-btn" onclick="archiveConversation()" id="archiveBtn">📦 Archive</button>
                <button class="thread-action-btn" onclick="setFollowUpReminder()">⏰ Reminder</button>
            </div>
        </div>
        
        <div class="section-box">
            <h2 id="conversationTitle" style="color: var(--augusta-green); margin-bottom: 0.5rem;"></h2>
            <p id="conversationSubtitle" style="color: var(--rough-gray); margin-bottom: 1rem; font-size: 0.9rem;"></p>
            
            <!-- Search Within Conversation -->
            <div class="search-within">
                <input type="text" id="searchWithinInput" placeholder="Search in this conversation..." 
                       oninput="searchWithinConversation()">
            </div>
            
            <!-- Follow-up Reminder -->
            <div id="followUpReminderDisplay" class="follow-up-reminder" style="display: none;"></div>
            
            <!-- Message Thread -->
            <div id="messageConversation" class="message-conversation"></div>
            
            <!-- Message Composer -->
            <div class="message-input-area">
                <div class="message-editor">
                    <div class="editor-toolbar">
                        <button class="editor-btn" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                        <button class="editor-btn" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                        <button class="editor-btn" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                        <button class="editor-btn" onclick="formatText('insertUnorderedList')" title="Bullet List">• List</button>
                        <button class="editor-btn" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                        <button class="editor-btn" onclick="insertLink()" title="Insert Link">🔗 Link</button>
                        <label class="editor-btn" style="cursor: pointer;">
                            📎 Attach
                            <input type="file" id="fileInput" multiple style="display: none;" 
                                   onchange="handleFileSelect(event)" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png">
                        </label>
                        <div class="emoji-picker">
                            <button class="editor-btn" onclick="toggleEmojiPicker()">😊 Emoji</button>
                            <div class="emoji-popup" id="emojiPopup">
                                <div class="emoji-grid" id="emojiGrid"></div>
                            </div>
                        </div>
                    </div>
                    <div contenteditable="true" id="messageInput" class="message-input" 
                         placeholder="Type your message..." oninput="updateCharCount()"></div>
                    <div class="attachment-list" id="attachmentList"></div>
                    <div class="char-count" id="charCount">0 / 5000 characters</div>
                </div>
                <div class="message-actions">                    
                    <button class="btn btn-primary" onclick="sendReplyMessage()">Send Message</button>
                </div>
            </div>
        </div>
    </div>
</div>

            <div id="accountView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 2rem;">My Account</h1>
                <div class="section-box">
                    <h2 style="color: var(--augusta-green); margin-bottom: 1rem;">Account Overview</h2>
                    <p style="margin-bottom: 1rem;"><strong>Name:</strong> <span id="accountName">-</span></p>
                    <p style="margin-bottom: 1rem;"><strong>Email:</strong> <span id="accountEmail">-</span></p>
                    <p style="margin-bottom: 1rem;"><strong>Credits Balance:</strong> <span id="accountCredits">0</span></p>
                    <p><strong>Total Messages Sent:</strong> <span id="totalMessages">0</span></p>
                </div>
            </div>

            <div id="adminView" class="view-section">
                <h1 style="font-size: 2.5rem; color: var(--augusta-green); margin-bottom: 2rem;">Admin Dashboard</h1>
                <div id="adminContent">
                    <div class="skeleton" style="height: 300px; border-radius: 16px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="listSelectorModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeListSelectorModal()">×</button>
            <h2 style="color: var(--augusta-green); margin-bottom: 1.5rem;">Add to List</h2>
            <div id="listSelectorContent">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--pro-shop-navy);">Select existing list:</label>
                    <select id="modalListSelector" style="width: 100%; padding: 0.875rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 1rem;">
                        <option value="">Choose a list...</option>
                    </select>
                </div>
                <div style="text-align: center; margin: 1.5rem 0; color: var(--rough-gray);">— or —</div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--pro-shop-navy);">Create new list:</label>
                    <input type="text" id="newListNameInput" placeholder="e.g., Head Greenkeeper Roles" style="width: 100%; padding: 0.875rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 1rem;">
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeListSelectorModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmListSelection()">Add to List</button>
            </div>
        </div>
    </div>

    <div id="createListModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeCreateListModal()">×</button>
            <h2 style="color: var(--augusta-green); margin-bottom: 1.5rem;">Create New List</h2>
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--pro-shop-navy);">List Name:</label>
                <input type="text" id="createListNameInput" placeholder="e.g., Head Greenkeeper Roles, Manchester Positions" style="width: 100%; padding: 0.875rem; border: 2px solid #e1e8e4; border-radius: 8px; font-size: 1rem;">
                <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--rough-gray);">Give your list a descriptive name to help organize candidates</p>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeCreateListModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmCreateList()">Create List</button>
            </div>
        </div>
    </div>

    <div id="messageCreditWarningModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="closeMessageWarningModal()">×</button>
        <h2 style="color: var(--augusta-green); margin-bottom: 1.5rem;">Send Message to Candidate?</h2>
        <div style="background: #fff3cd; border-left: 4px solid #f4d03f; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: var(--augusta-green); margin-bottom: 0.5rem; font-size: 1.1rem;">Important Information:</h3>
            <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                <li><strong>First message to this candidate will deduct 1 credit from your balance</strong></li>
                <li>All subsequent messages in this conversation are completely free</li>
                <li>The candidate will receive your message via email and can reply directly</li>
                <li>Golf Jobs staff can view all messages for quality assurance and safety purposes</li>
                <li>Your email address will never be shared with the candidate</li>
            </ul>
        </div>
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <p style="margin: 0; line-height: 1.6;"><strong>To:</strong> <span id="warningCandidateName"></span></p>
            <p style="margin: 0.5rem 0 0 0; line-height: 1.6;"><strong>Your Credits:</strong> <span id="warningCreditsCount"></span></p>
        </div>
        <div style="margin-bottom: 1.5rem;">
            <label style="display: flex; align-items: start; gap: 0.75rem; cursor: pointer;">
                <input type="checkbox" id="agreeToTerms" style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-size: 0.95rem;">I understand and agree to these terms and confirm I want to send this message</span>
            </label>
        </div>
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="closeMessageWarningModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmSendMessage()" id="confirmSendBtn" disabled 
                    style="opacity: 0.5; cursor: not-allowed;">Send Message (1 Credit)</button>
        </div>
    </div>
</div>

    <script>
        // ============================================================================
        // CONFIGURATION & INITIALIZATION
        // ============================================================================
        
        const SUPABASE_URL = 'https://kbadedwbcjetxiertztv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtiYWRlZHdiY2pldHhpZXJ0enR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDAyNDMsImV4cCI6MjA3Mzg3NjI0M30.igm3XjM8l1OXfilQaAHtmJyCDe9eXILV_P9B3_sUzwg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const CONFIG = {
            PAGE_SIZE: 50,
            ALL_POOL_PAGE_SIZE: 150,
            TOP_PICK_THRESHOLD: 90,
            DEBOUNCE_DELAY: 300
        };

        // State management
        let currentUser = null;
        let currentPool = null;
        let currentCandidate = null;
        let userProfile = null;
        let userPools = [];
        let userLists = [];
        let currentListId = null;
        let shortlist = [];
        let allCandidates = [];
        let displayedCandidates = [];
        let selectedCandidates = new Set();
        let selectedShortlistItems = new Set();
        let currentPage = 0;
        let currentFilters = { search: '', location: '', category: '', salary: '', notice: '', looking: '' };
        let currentSort = 'relevance';
        let hasMoreCandidates = true;
        let currentMessageThread = null;
        let pendingCandidatesForList = [];
        let messageAttachments = [];        
        let allConversations = [];
        let filteredConversations = [];
        let conversationMetadata = new Map();
        let pendingMessage = null;
        let isFirstMessageToCandidate = false;

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        
        function sanitizeSearchInput(input) {
            // Escape SQL wildcards and special characters
            return input
                .replace(/[%_\\]/g, '\\$&')  // Escape wildcards
                .replace(/"/g, '""')          // Escape quotes
                .trim();
        }

        function showError(message, error = null) {
            console.error('Application Error:', message, error);
            let errorToast = document.getElementById('errorToast');
            if (!errorToast) {
                errorToast = document.createElement('div');
                errorToast.id = 'errorToast';
                errorToast.style.cssText = `position: fixed; top: 100px; right: 20px; background: white; border-left: 4px solid var(--hazard-red); padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; max-width: 400px; animation: slideInRight 0.3s ease;`;
                document.body.appendChild(errorToast);
            }
            errorToast.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;"><div><div style="font-weight: 600; color: var(--hazard-red); margin-bottom: 0.5rem;">Error</div><div style="color: var(--pro-shop-navy);">${message}</div></div><button onclick="closeError()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--rough-gray);">×</button></div>`;
            errorToast.style.display = 'block';
            setTimeout(() => closeError(), 5000);
        }

        function closeError() {
            const errorToast = document.getElementById('errorToast');
            if (errorToast) errorToast.style.display = 'none';
        }

        function toTitleCase(str) {
            if (!str) return str;
            const acronyms = ['UK', 'USA', 'US', 'CEO', 'CFO', 'COO', 'CTO', 'PGA', 'HR', 'IT', 'F&B'];
            return str.toLowerCase().split(/(\s+|-)/).map(word => {
                const cleanWord = word.replace(/[.,;:!?]/g, '');
                const upperClean = cleanWord.toUpperCase();
                if (acronyms.includes(upperClean)) return word.replace(cleanWord, upperClean);
                if (word.length > 0) return word.charAt(0).toUpperCase() + word.slice(1);
                return word;
            }).join('');
        }

        function cleanAndFormatLocation(townCity, country) {
            const excludeTerms = ['England', 'United Kingdom', 'UK', 'Scotland', 'Wales', 'Northern Ireland'];
            let cleanedTown = townCity ? townCity.trim() : '';
            let cleanedCountry = country ? country.trim() : '';
            if (excludeTerms.some(term => cleanedCountry.toLowerCase() === term.toLowerCase())) cleanedCountry = '';
            if (cleanedTown) return toTitleCase(cleanedTown);
            return 'Location Not Specified';
        }

        function formatSalaryExact(salary) {
            if (!salary) return 'Salary Negotiable';
            const num = parseFloat(salary);
            if (isNaN(num)) return 'Salary Negotiable';
            return `£${num.toLocaleString()}`;
        }

        function formatNoticePeriod(notice) {
            if (!notice) return 'Unknown';
            const lowerNotice = notice.toLowerCase();
            if (lowerNotice.includes('immediately') || lowerNotice.includes('immediate')) return 'Available immediately';
            if (lowerNotice.includes('1 week')) return '1 week notice';
            if (lowerNotice.includes('2 week')) return '2 weeks notice';
            if (lowerNotice.includes('1 month')) return '1 month notice';
            if (lowerNotice.includes('2 month')) return '2 months notice';
            if (lowerNotice.includes('3 month')) return '3 months notice';
            return notice + ' notice';
        }

        function calculateProfileScore(candidate) {
    let score = 0;
    const aboutYou = candidate["About You"] || '';
    const skills = candidate["Your Skills"] || '';
    let jobTitle = candidate["Current Job Title"] || candidate["Job Title"] || '';
    if (typeof jobTitle === 'number') jobTitle = '';
    jobTitle = String(jobTitle).toLowerCase();
    
    const combinedText = (aboutYou + ' ' + skills + ' ' + jobTitle).toLowerCase();
    
    // CRITICAL: Golf industry terms - this is the most important factor
    const golfIndustryTerms = [
        'golf club', 'golf course', 'country club', 'golf resort',
        'greenkeeper', 'head greenkeeper', 'greens superintendent', 'course manager',
        'pga professional', 'pga', 'golf professional', 'teaching professional',
        'club manager', 'general manager', 'golf operations', 'club operations',
        'turf management', 'agronomy', 'irrigation', 'course maintenance',
        'golf retail', 'pro shop', 'golf merchandising',
        'golf events', 'tournament director', 'golf tournament',
        'golf hospitality', 'clubhouse manager', 'f&b manager',
        'golf marketing', 'golf sales', 'membership sales',
        'assistant greenkeeper', 'mechanic golf', 'golf course superintendent',
        'toro', 'jacobsen', 'john deere', 'turfgrass', 'greens management'
    ];
    
    let golfTermMatches = 0;
    golfIndustryTerms.forEach(term => {
        if (combinedText.includes(term)) golfTermMatches++;
    });
    
    // MAJOR CHANGE: Golf terms are now worth MUCH more (up to 100 points instead of 40)
    // This ensures golf professionals always score higher
    score += Math.min(golfTermMatches * 12, 100);
    
    // Check if job title itself contains golf terms - extra bonus
    const jobTitleIsGolfRelated = golfIndustryTerms.some(term => jobTitle.includes(term));
    if (jobTitleIsGolfRelated) {
        score += 30; // Huge bonus for golf-related job title
    }
    
    // REDUCED: Profile completeness is now worth less
    // About You section - now capped at 20 points instead of 30
    if (aboutYou.length > 300) score += 20;
    else if (aboutYou.length > 200) score += 15;
    else if (aboutYou.length > 100) score += 10;
    else if (aboutYou.length > 50) score += 5;
    
    // Skills section - now capped at 15 points instead of 20
    if (skills.length > 150) score += 15;
    else if (skills.length > 100) score += 12;
    else if (skills.length > 50) score += 8;
    else if (skills.length > 20) score += 5;
    
    // Basic profile completion - reduced points
    if (jobTitle && jobTitle.trim()) score += 5; // Was 10
    if (candidate["What are your salary expectations?"]) score += 3; // Was 10
    if (candidate["Notice Period"]) score += 3; // Was 10
    if (candidate["Town/City"]) score += 3; // Was 10
    if (candidate["Actively looking for work"]) score += 3; // Was 10
    
    return score;
}

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // ============================================================================
        // AUTHENTICATION
        // ============================================================================
        
        window.onload = async function() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    await loadUserData(session.user);
                    showApp();
                } else {
                    document.getElementById('loginScreen').style.display = 'flex';
                }
                setupHistoryHandling();
            } catch (error) {
                showError('Failed to initialize application', error);
                document.getElementById('loginScreen').style.display = 'flex';
            }
        };

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ 
                    email: email, 
                    password: password 
                });
                
                if (error) throw error;
                
                await loadUserData(data.user);
                showApp();
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => { 
                    document.getElementById('loginError').style.display = 'none'; 
                }, 3000);
            }
        }

        async function loadUserData(user) {
            currentUser = user;
            try {
                const { data: profile, error: profileError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (profileError) throw profileError;
                
                if (profile) {
                    userProfile = profile;
                    document.getElementById('userName').textContent = profile.name || user.email.split('@')[0];
                    document.getElementById('mobileUserName').textContent = profile.name || user.email.split('@')[0];
                    updateCreditsDisplay(profile.credits || 0);
                    
                    if (profile.role === 'admin') {
                        document.getElementById('adminTab').style.display = 'block';
                        document.getElementById('mobileAdminItem').style.display = 'block';
                    }
                } else {
                    userProfile = { id: user.id, email: user.email, credits: 0 };
                }
            } catch (err) {
                console.error('Error loading user profile:', err);
                userProfile = { id: user.id, email: user.email, credits: 0 };
            }
            
            try {
                const { data: poolAccess, error: poolError } = await supabase
                    .from('user_pool_access')
                    .select('pool_id')
                    .eq('user_id', user.id);
                
                if (poolError) throw poolError;
                
                userPools = poolAccess ? poolAccess.map(p => p.pool_id) : [];
            } catch (err) {
                console.error('Error loading pool access:', err);
                userPools = [];
            }
            
            await loadUserLists();
        }

        function updateCreditsDisplay(credits) {
            document.getElementById('creditsCount').textContent = credits;
            document.getElementById('mobileCreditsCount').textContent = credits;
        }

        async function handleLogout() {
            try {
                await supabase.auth.signOut();
                location.reload();
            } catch (error) {
                showError('Failed to logout', error);
            }
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
            loadPools();
        }

        // ============================================================================
        // NAVIGATION & HISTORY
        // ============================================================================
        
        function goHome() {
            switchView('pools');
        }

        function setupHistoryHandling() {
            window.addEventListener('popstate', function(event) {
                if (event.state && event.state.view) {
                    switchView(event.state.view, true);
                } else {
                    const hash = window.location.hash.slice(1);
                    if (hash && ['pools', 'shortlist', 'messages', 'account', 'admin'].includes(hash)) {
                        switchView(hash, true);
                    }
                }
            });
            
            const hash = window.location.hash.slice(1);
            if (hash && ['pools', 'shortlist', 'messages', 'account', 'admin'].includes(hash)) {
                switchView(hash, true);
            }
        }

        function switchView(view, skipHistory = false) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
            
            const section = document.getElementById(view + 'View');
            if (section) section.classList.add('active');
            
            const tabBtn = document.querySelector(`.nav-tabs .nav-tab[onclick*="'${view}'"]`);
            if (tabBtn) tabBtn.classList.add('active');
            
            const mobileItem = document.querySelector(`.mobile-nav-item[onclick*="'${view}'"]`);
            if (mobileItem) mobileItem.classList.add('active');
            
            if (!skipHistory) {
                window.history.pushState({ view: view }, '', `#${view}`);
            }
            
            if (view === 'pools') loadPools();
            else if (view === 'shortlist') loadShortlist();
            else if (view === 'messages') loadMessages();
            else if (view === 'account') loadAccount();
            else if (view === 'admin' && userProfile?.role === 'admin') loadAdmin();
        }

        function toggleMobileMenu() {
            const overlay = document.getElementById('mobileNavOverlay');
            const menu = document.getElementById('mobileNavMenu');
            overlay.classList.toggle('active');
            menu.classList.toggle('active');
        }

        function switchViewMobile(view) {
            switchView(view);
            toggleMobileMenu();
        }

        function closeMobileProfile() {
            document.querySelectorAll('.split-view-right').forEach(panel => {
                panel.classList.remove('mobile-active');
            });
        }

        // ============================================================================
        // TALENT POOLS
        // ============================================================================
        
        async function loadPools() {
            const poolsGrid = document.getElementById('poolsGrid');
            poolsGrid.innerHTML = '<div class="skeleton skeleton-card"></div><div class="skeleton skeleton-card"></div><div class="skeleton skeleton-card"></div>';
            
            try {
                const { data: pools, error: poolsError } = await supabase
                    .from('talent_pools')
                    .select('slug, label, sort_order')
                    .order('sort_order', { ascending: true });
                
                if (poolsError) throw poolsError;
                
                if (!pools || pools.length === 0) {
                    poolsGrid.innerHTML = '<div class="empty-state"><h3>No talent pools available</h3></div>';
                    return;
                }
                
                // FIXED: Load all pool counts in parallel instead of sequentially
                const countPromises = pools.map(async (pool) => {
                    try {
                        if (pool.slug === 'all') {
                            const { count } = await supabase
                                .from('candidates')
                                .select('*', { count: 'exact', head: true });
                            return { slug: pool.slug, count: count || 0 };
                        } else {
                            const { count } = await supabase
                                .from('candidate_pools')
                                .select('*', { count: 'exact', head: true })
                                .eq('pool_slug', pool.slug);
                            return { slug: pool.slug, count: count || 0 };
                        }
                    } catch (err) {
                        console.warn(`Error counting for pool ${pool.slug}:`, err);
                        return { slug: pool.slug, count: 0 };
                    }
                });
                
                const counts = await Promise.all(countPromises);
                const countMap = new Map(counts.map(c => [c.slug, c.count]));
                
                pools.forEach(pool => {
                    pool.total_candidates = countMap.get(pool.slug) || 0;
                });
                
                poolsGrid.innerHTML = '';
                for (const pool of pools) {
                    const hasAccess = userPools.includes('all') || userPools.includes(pool.slug);
                    const poolCard = document.createElement('div');
                    poolCard.className = hasAccess ? 'pool-card' : 'pool-card locked';
                    poolCard.innerHTML = `
                        <div class="pool-header">
                            <div class="pool-title">${pool.label}</div>
                            <div class="pool-badge">${hasAccess ? 'Available' : 'Locked'}</div>
                        </div>
                        <div class="pool-stats">
                            <div class="pool-stat">
                                <span>Total Candidates</span>
                                <span style="font-size: 1.25rem; font-weight: 700; color: var(--augusta-green);">${pool.total_candidates}</span>
                            </div>
                        </div>
                    `;
                    
                    if (hasAccess) {
                        poolCard.onclick = () => openPool(pool);
                    } else {
                        poolCard.onclick = () => alert('Contact graham@golf-jobs.com to request access to this pool.');
                    }
                    
                    poolsGrid.appendChild(poolCard);
                }
            } catch (err) {
                showError('Failed to load talent pools', err);
                poolsGrid.innerHTML = '<div class="empty-state"><h3>Error loading pools</h3><button class="btn btn-primary" onclick="loadPools()">Try Again</button></div>';
            }
        }

        async function openPool(pool) {
            currentPool = pool;
            currentPage = 0;
            selectedCandidates.clear();
            hasMoreCandidates = true;
            allCandidates = [];
            displayedCandidates = [];
            currentFilters = { search: '', location: '', category: '', salary: '', notice: '', looking: '' };
            currentSort = 'relevance';
            
            document.getElementById('currentPoolName').textContent = pool.label;
            document.getElementById('searchInput').value = '';
            document.getElementById('locationFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('salaryFilter').value = '';
            document.getElementById('noticeFilter').value = '';
            document.getElementById('lookingFilter').value = '';
            document.getElementById('sortSelect').value = 'relevance';
            
            const candidatesListView = document.getElementById('candidatesListView');
            candidatesListView.innerHTML = '<div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div><div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div><div class="skeleton" style="height: 120px; margin-bottom: 1rem; border-radius: 12px;"></div>';
            
            try {
                await loadCandidatesForLocationFilter();
                await loadCandidatesPage(true);
            } catch (err) {
                showError('Failed to load candidates', err);
                candidatesListView.innerHTML = '<div class="empty-state"><h3>Error loading candidates</h3><button class="btn btn-primary" onclick="openPool(currentPool)">Try Again</button></div>';
            }
            
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.getElementById('poolDetailView').classList.add('active');
        }

        // ============================================================================
        // CANDIDATES LOADING & FILTERING
        // ============================================================================
        
        async function loadCandidatesForLocationFilter() {
            try {
                let query = supabase.from('candidates').select('"Town/City", Country');
                
                if (currentPool.slug !== 'all') {
                    const { data: poolCandidates } = await supabase
                        .from('candidate_pools')
                        .select('candidate_id')
                        .eq('pool_slug', currentPool.slug);
                    
                    if (poolCandidates && poolCandidates.length > 0) {
                        const candidateIds = poolCandidates.map(pc => String(pc.candidate_id));
                        query = query.in('ID', candidateIds);
                    } else {
                        return;
                    }
                }
                
                const { data: candidates } = await query;
                if (candidates) populateLocationFilter(candidates);
            } catch (err) {
                console.error('Error loading location data:', err);
            }
        }

        function populateLocationFilter(candidates) {
            const locationCounts = {};
            candidates.forEach(candidate => {
                const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
                if (!locationCounts[location]) locationCounts[location] = 0;
                locationCounts[location]++;
            });
            
            const sortedLocations = Object.entries(locationCounts).sort((a, b) => {
                if (a[0] === 'Location Not Specified') return 1;
                if (b[0] === 'Location Not Specified') return -1;
                return a[0].localeCompare(b[0]);
            });
            
            const locationFilter = document.getElementById('locationFilter');
            locationFilter.innerHTML = `<option value="">All Locations</option>`;
            sortedLocations.forEach(([location, count]) => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = `${location} (${count})`;
                locationFilter.appendChild(option);
            });
        }

        async function loadCandidatesPage(resetList = false) {
            if (resetList) {
                currentPage = 0;
                displayedCandidates = [];
                hasMoreCandidates = true;
            }
            
            const candidatesListView = document.getElementById('candidatesListView');
            if (resetList) {
                candidatesListView.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading...</div>';
            }
            
            try {
                let query = supabase.from('candidates').select('*');
                
                // Filter by pool
                if (currentPool.slug !== 'all') {
                    const { data: poolCandidates, error: poolError } = await supabase
                        .from('candidate_pools')
                        .select('candidate_id')
                        .eq('pool_slug', currentPool.slug);
                    
                    if (poolError) throw poolError;
                    
                    if (!poolCandidates || poolCandidates.length === 0) {
                        if (resetList) {
                            candidatesListView.innerHTML = '<div class="empty-state"><h3>No candidates in this pool</h3></div>';
                        }
                        hasMoreCandidates = false;
                        document.getElementById('loadMoreContainer').style.display = 'none';
                        return;
                    }
                    
                    const candidateIds = poolCandidates.map(pc => String(pc.candidate_id));
                    query = query.in('ID', candidateIds);
                }
                
                // FIXED: Properly sanitized search filter
                if (currentFilters.search) {
                    const sanitized = sanitizeSearchInput(currentFilters.search);
                    if (sanitized) {
                        query = query.or(
                            `"Current Job Title".ilike.%${sanitized}%,` +
                            `"Town/City".ilike.%${sanitized}%,` +
                            `"Your Skills".ilike.%${sanitized}%,` +
                            `"About You".ilike.%${sanitized}%`
                        );
                    }
                }
                
                // Location filter
                if (currentFilters.location && currentFilters.location !== 'Location Not Specified') {
                    const sanitized = sanitizeSearchInput(currentFilters.location);
                    query = query.ilike('"Town/City"', `%${sanitized}%`);
                }
                
                // Category filter
                if (currentFilters.category) {
                    query = query.eq('category', currentFilters.category);
                }
                
                // Salary filter
                if (currentFilters.salary) {
                    if (currentFilters.salary === '70000+') {
                        query = query.gte('"What are your salary expectations?"', 70000);
                    } else {
                        const [min, max] = currentFilters.salary.split('-').map(Number);
                        if (!isNaN(min) && !isNaN(max)) {
                            query = query.gte('"What are your salary expectations?"', min)
                                         .lte('"What are your salary expectations?"', max);
                        }
                    }
                }
                
                // Notice period filter
                if (currentFilters.notice) {
                    query = query.ilike('"Notice Period"', `%${currentFilters.notice}%`);
                }
                
                // Looking filter
                if (currentFilters.looking) {
                    query = query.eq('"Actively looking for work"', currentFilters.looking);
                }
                
                // Sorting (except relevance which is done client-side)                            
                const pageSize = CONFIG.PAGE_SIZE;

                // Sort based on selected option - database handles all sorting now
switch (currentSort) {
    case 'relevance':
        query = query.order('profile_score', { ascending: false, nullsFirst: false });
        break;
    case 'newest':
        query = query.order('"Created At"', { ascending: false, nullsFirst: false });
        break;
    case 'salary-high':
        query = query.order('"What are your salary expectations?"', { ascending: false, nullsFirst: false });
        break;
    case 'salary-low':
        query = query.order('"What are your salary expectations?"', { ascending: true, nullsFirst: false });
        break;
                    }
                
                // Pagination
                const from = currentPage * pageSize;
                const to = from + pageSize - 1;
                query = query.range(from, to);
                
                const { data: candidates, error } = await query;
                if (error) throw error;
                
                if (!candidates || candidates.length === 0) {
                    hasMoreCandidates = false;
                    if (resetList) {
                        candidatesListView.innerHTML = '<div class="empty-state"><h3>No candidates match your criteria</h3><p>Try adjusting your filters</p><button class="btn btn-primary" onclick="clearFilters()">Clear Filters</button></div>';
                    }
                    document.getElementById('loadMoreContainer').style.display = 'none';
                    return;
                }
                
                // Apply relevance scoring if needed
                                
                if (resetList) {
                    displayedCandidates = candidates;
                    allCandidates = candidates;
                } else {
                    displayedCandidates = [...displayedCandidates, ...candidates];
                    allCandidates = [...allCandidates, ...candidates];
                }
                
                hasMoreCandidates = candidates.length === pageSize;
                
                if (resetList) {
                    displayCandidates(displayedCandidates);
                } else {
                    const newHtml = candidates.map(candidate => generateCandidateCardHTML(candidate)).join('');
                    candidatesListView.insertAdjacentHTML('beforeend', newHtml);
                }
                
                document.getElementById('candidateCount').textContent = `Showing ${displayedCandidates.length} candidates`;
                
                const loadMoreContainer = document.getElementById('loadMoreContainer');
                loadMoreContainer.style.display = hasMoreCandidates ? 'block' : 'none';
                
            } catch (err) {
                showError('Failed to load candidates', err);
                if (resetList) {
                    candidatesListView.innerHTML = '<div class="empty-state"><h3>Error loading candidates</h3><button class="btn btn-primary" onclick="loadCandidatesPage(true)">Try Again</button></div>';
                }
            }
        }

        function displayCandidates(candidates) {
            const candidatesListView = document.getElementById('candidatesListView');
            if (!candidates || candidates.length === 0) {
                candidatesListView.innerHTML = '<div class="empty-state"><h3>No candidates match your criteria</h3><p>Try adjusting your filters</p><button class="btn btn-primary" onclick="clearFilters()">Clear Filters</button></div>';
                return;
            }
            candidatesListView.innerHTML = candidates.map(candidate => generateCandidateCardHTML(candidate)).join('');
        }

        function generateCandidateCardHTML(candidate) {
            let rawJobTitle = candidate["Current Job Title"];
            if (typeof rawJobTitle === 'number' || !rawJobTitle || rawJobTitle === '') {
                rawJobTitle = candidate["Job Title"] || '';
            }
            const jobTitle = rawJobTitle ? toTitleCase(String(rawJobTitle)) : `Candidate #${candidate.ID}`;
            const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
            const salary = formatSalaryExact(candidate["What are your salary expectations?"]);
            const notice = formatNoticePeriod(candidate["Notice Period"]);
            const profileScore = candidate.profile_score || 0;
            const isTopPick = profileScore >= CONFIG.TOP_PICK_THRESHOLD;
            const isSelected = selectedCandidates.has(String(candidate.ID));
            const activelyLooking = (candidate["Actively looking for work"] || '').toUpperCase() === 'YES';
            const about = candidate["About You"] || '';
            const summaryPreview = about.substring(0, 150) + (about.length > 150 ? '...' : '');
            
            return `
                <div class="candidate-list-item ${isSelected ? 'selected' : ''}" 
                     id="card-${candidate.ID}" 
                     style="background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border: 2px solid ${isSelected ? 'var(--masters-green)' : '#e5e7eb'}; cursor: pointer; transition: all 0.3s ease; position: relative;" 
                     onclick='viewCandidateProfile("${candidate.ID}")'>
                    <input type="checkbox" 
                           style="position: absolute; top: 1rem; left: 1rem; width: 20px; height: 20px; cursor: pointer; z-index: 10;" 
                           ${isSelected ? 'checked' : ''} 
                           onchange='toggleCandidateSelection("${candidate.ID}")' 
                           onclick="event.stopPropagation()">
                    ${isTopPick ? '<div class="top-pick-badge">⭐ TOP PICK</div>' : ''}
                    <div style="padding-left: 2.5rem;">
                        <h3 style="color: var(--augusta-green); margin-bottom: 0.25rem; font-size: 1.2rem; font-weight: 600;">${jobTitle}</h3>
                        <p style="color: var(--rough-gray); font-size: 0.9rem; margin-bottom: 0.5rem;">${location}</p>
                        ${summaryPreview ? `<p style="color: #555; font-size: 0.85rem; line-height: 1.4; margin-bottom: 0.75rem;">${summaryPreview}</p>` : ''}
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--rough-gray); font-size: 0.85rem;">${salary} • ${notice}${activelyLooking ? ' • Actively looking' : ''}</span>
                            <span style="color: var(--masters-green); font-weight: 600;">View →</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadMore() {
            currentPage++;
            loadCandidatesPage(false);
        }

        // Setup event listeners for filters
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(applyFilters, CONFIG.DEBOUNCE_DELAY));
            }
            
            ['locationFilter', 'categoryFilter', 'salaryFilter', 'noticeFilter', 'lookingFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.addEventListener('change', applyFilters);
            });
        });

        function applyFilters() {
            currentFilters.search = document.getElementById('searchInput').value.toLowerCase();
            currentFilters.location = document.getElementById('locationFilter').value;
            currentFilters.category = document.getElementById('categoryFilter').value;
            currentFilters.salary = document.getElementById('salaryFilter').value;
            currentFilters.notice = document.getElementById('noticeFilter').value;
            currentFilters.looking = document.getElementById('lookingFilter').value;
            loadCandidatesPage(true);
        }

        function applySort() {
            currentSort = document.getElementById('sortSelect').value;
            loadCandidatesPage(true);
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('locationFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('salaryFilter').value = '';
            document.getElementById('noticeFilter').value = '';
            document.getElementById('lookingFilter').value = '';
            document.getElementById('sortSelect').value = 'relevance';
            currentFilters = { search: '', location: '', category: '', salary: '', notice: '', looking: '' };
            currentSort = 'relevance';
            loadCandidatesPage(true);
        }

        // ============================================================================
        // CANDIDATE SELECTION
        // ============================================================================
        
        function toggleCandidateSelection(candidateId) {
            const id = String(candidateId);
            if (selectedCandidates.has(id)) {
                selectedCandidates.delete(id);
                const card = document.getElementById(`card-${candidateId}`);
                if (card) {
                    card.classList.remove('selected');
                    card.style.borderColor = '#e5e7eb';
                }
            } else {
                selectedCandidates.add(id);
                const card = document.getElementById(`card-${candidateId}`);
                if (card) {
                    card.classList.add('selected');
                    card.style.borderColor = 'var(--masters-green)';
                }
            }
        }

        function selectAll() {
            displayedCandidates.forEach(candidate => {
                const id = String(candidate.ID);
                selectedCandidates.add(id);
                const card = document.getElementById(`card-${candidate.ID}`);
                if (card) {
                    card.classList.add('selected');
                    card.style.borderColor = 'var(--masters-green)';
                    const checkbox = card.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = true;
                }
            });
        }

        function deselectAll() {
            selectedCandidates.clear();
            document.querySelectorAll('.candidate-list-item').forEach(card => {
                card.classList.remove('selected');
                card.style.borderColor = '#e5e7eb';
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = false;
            });
        }

        // ============================================================================
        // CANDIDATE PROFILE VIEW
        // ============================================================================
        
        async function viewCandidateProfile(candidateId) {
            const candidate = allCandidates.find(c => String(c.ID) === String(candidateId));
            if (!candidate) {
                showError('Candidate not found');
                return;
            }
            
            currentCandidate = candidate;
            
            let rawJobTitle = candidate["Current Job Title"];
            if (typeof rawJobTitle === 'number' || !rawJobTitle || rawJobTitle === '') {
                rawJobTitle = candidate["Job Title"] || '';
            }
            const jobTitle = rawJobTitle ? toTitleCase(String(rawJobTitle)) : `Candidate #${candidate.ID}`;
            const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
            const about = candidate["About You"] || 'No summary provided';
            const skills = candidate["Your Skills"] || '';
            const salary = formatSalaryExact(candidate["What are your salary expectations?"]);
            const notice = formatNoticePeriod(candidate["Notice Period"]);
            const activelyLooking = candidate["Actively looking for work"];
            const activeStatus = (activelyLooking && activelyLooking.toUpperCase() === 'YES') 
                ? 'Actively Looking For Work' 
                : 'Not Actively Looking';
            const profileScore = calculateProfileScore(candidate);
            const isTopPick = profileScore >= CONFIG.TOP_PICK_THRESHOLD;
            const notes = await loadCandidateNotes(candidateId);
            
            const profileDetailView = document.getElementById('profileDetailView');
            profileDetailView.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h1 style="color: var(--augusta-green); margin-bottom: 0.5rem; font-size: 1.8rem;">${jobTitle}</h1>
                    ${isTopPick ? '<div class="top-pick-badge" style="position: relative; top: 0; right: auto; margin-top: 0.5rem; display: inline-flex;">⭐ TOP PICK</div>' : ''}
                    <p style="color: var(--rough-gray); font-size: 1.1rem; margin-top: 0.5rem;">${location}</p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">Salary Expectations</div>
                        <div style="font-weight: 600; font-size: 1.1rem;">${salary}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">Notice Period</div>
                        <div style="font-weight: 600; font-size: 1.1rem;">${notice}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">Job Search Status</div>
                        <div style="font-weight: 600; font-size: 1.1rem;">${activeStatus}</div>
                    </div>
                </div>
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Professional Summary</h3>
                    <p style="line-height: 1.8; color: #333; white-space: pre-wrap;">${about}</p>
                </div>
                ${skills ? `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Skills & Expertise</h3>
                        <p style="line-height: 1.6; color: #333; white-space: pre-wrap;">${skills}</p>
                    </div>
                ` : ''}
                <div class="notes-section">
                    <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Your Notes</h3>
                    <div style="margin-bottom: 1rem;">
                        <textarea id="newNoteInput" placeholder="Add a note about this candidate..." 
                                  style="width: 100%; padding: 0.75rem; border: 2px solid #e1e8e4; border-radius: 8px; font-family: inherit; resize: vertical; min-height: 80px;"></textarea>
                        <button class="btn btn-primary btn-small" 
                                onclick='saveNote("${candidateId}", document.getElementById("newNoteInput").value)' 
                                style="margin-top: 0.5rem;">Save Note</button>
                    </div>
                    ${notes.length > 0 ? `
                        <div style="margin-top: 1.5rem;">
                            ${notes.map(note => `
                                <div class="note-item">
                                    <div class="note-text">${note.note}</div>
                                    <div class="note-meta">
                                        <span>${new Date(note.created_at).toLocaleDateString()}</span>
                                        <div class="note-actions">
                                            <button class="btn btn-secondary btn-small" 
                                                    onclick='const newText = prompt("Edit note:", ${JSON.stringify(note.note)}); if (newText) editNote("${note.id}", newText);'>Edit</button>
                                            <button class="btn btn-danger btn-small" 
                                                    onclick='deleteNote("${note.id}")'>Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: var(--rough-gray); font-style: italic;">No notes yet. Add one above!</p>'}
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary btn-small" onclick="addToShortlist()">Save to List</button>
                    <button class="btn btn-primary btn-small" onclick='sendMessageToCandidate("${candidate.ID}")'>Send Message (1 Credit)</button>
                </div>
            `;
            
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                document.querySelector('.split-view-right').classList.add('mobile-active');
            }
        }

        // ============================================================================
        // CANDIDATE NOTES
        // ============================================================================
        
        async function loadCandidateNotes(candidateId) {
            try {
                const { data: notes, error } = await supabase
                    .from('candidate_notes')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('candidate_id', String(candidateId))
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                return notes || [];
            } catch (err) {
                console.error('Error loading notes:', err);
                return [];
            }
        }

        async function saveNote(candidateId, noteText) {
            if (!noteText.trim()) {
                showError('Please enter a note');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('candidate_notes')
                    .insert({
                        user_id: currentUser.id,
                        candidate_id: String(candidateId),
                        note: noteText.trim()
                    })
                    .select();
                
                if (error) throw error;
                
                await viewCandidateProfile(candidateId);
            } catch (err) {
                showError('Failed to save note', err);
            }
        }

        async function editNote(noteId, newText) {
            if (!newText || !newText.trim()) return;
            
            try {
                const { error } = await supabase
                    .from('candidate_notes')
                    .update({
                        note: newText.trim(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', noteId);
                
                if (error) throw error;
                
                await viewCandidateProfile(currentCandidate.ID);
            } catch (err) {
                showError('Failed to update note', err);
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('Delete this note?')) return;
            
            try {
                const { error } = await supabase
                    .from('candidate_notes')
                    .delete()
                    .eq('id', noteId);
                
                if (error) throw error;
                
                await viewCandidateProfile(currentCandidate.ID);
            } catch (err) {
                showError('Failed to delete note', err);
            }
        }

// ============================================================================
// MESSAGING
// ============================================================================

// Initialize emoji picker
const commonEmojis = ['😊', '👍', '👋', '🎉', '⛳', '🏌️', '✅', '❤️', '🔥', '💼', '📧', '📞', '✨', '💪', '🤝', '🙏', '😀', '😃', '😄', '😁', '🤔', '👏', '🎯', '💯'];

function initializeEmojiPicker() {
    const emojiGrid = document.getElementById('emojiGrid');
    if (emojiGrid) {
        emojiGrid.innerHTML = commonEmojis.map(emoji => 
            `<button class="emoji-btn" onclick="insertEmoji('${emoji}')">${emoji}</button>`
        ).join('');
    }
}

// Setup event listeners for messaging
document.addEventListener('DOMContentLoaded', function() {
    const messageSearchInput = document.getElementById('messageSearchInput');
    if (messageSearchInput) {
        messageSearchInput.addEventListener('input', debounce(applyMessageFilters, CONFIG.DEBOUNCE_DELAY));
    }
    
    const agreeCheckbox = document.getElementById('agreeToTerms');
    if (agreeCheckbox) {
        agreeCheckbox.addEventListener('change', function() {
            const confirmBtn = document.getElementById('confirmSendBtn');
            if (this.checked) {
                confirmBtn.disabled = false;
                confirmBtn.style.opacity = '1';
                confirmBtn.style.cursor = 'pointer';
            } else {
                confirmBtn.disabled = true;
                confirmBtn.style.opacity = '0.5';
                confirmBtn.style.cursor = 'not-allowed';
            }
        });
    }
    
    initializeEmojiPicker();
});

async function sendMessageToCandidate(candidateId) {
    const candidate = allCandidates.find(c => String(c.ID) === String(candidateId));
    if (!candidate) return;
    
    // Check if this is the first message to this candidate
    const { data: existingMessages } = await supabase
        .from('messages')
        .select('id')
        .eq('employer_id', currentUser.id)
        .eq('candidate_id', String(candidateId))
        .limit(1);
    
    isFirstMessageToCandidate = !existingMessages || existingMessages.length === 0;
    
    // Check credits for first message
    if (isFirstMessageToCandidate && (!userProfile || userProfile.credits <= 0)) {
        alert('Insufficient credits. Please contact graham@golf-jobs.com to purchase more credits.');
        return;
    }
    
    // Show the message composer with candidate context
    pendingMessage = { candidateId, candidate };
    
    // Switch to messages view and start new conversation
    switchView('messages');
    await loadMessages();
    startNewConversation(candidate);
}

function startNewConversation(candidate) {
    // Hide conversations list, show conversation detail
    document.getElementById('conversationsList').style.display = 'none';
    document.getElementById('conversationDetail').style.display = 'block';
    document.getElementById('messageFilters').style.display = 'none';
    
    let rawJobTitle = candidate["Current Job Title"];
    if (typeof rawJobTitle === 'number' || !rawJobTitle) rawJobTitle = candidate["Job Title"] || '';
    const jobTitle = rawJobTitle ? toTitleCase(String(rawJobTitle)) : `Candidate #${candidate.ID}`;
    
    document.getElementById('conversationTitle').textContent = `New Message: ${jobTitle}`;
    document.getElementById('conversationSubtitle').textContent = 'Start a conversation with this candidate';
    document.getElementById('messageConversation').innerHTML = '';
    document.getElementById('messageInput').innerHTML = '';
    
    currentMessageThread = {
        candidate_id: candidate.ID,
        candidate_name: jobTitle,
        messages: [],
        isNew: true
    };
    
    // Clear any existing attachments
    messageAttachments = [];
    document.getElementById('attachmentList').innerHTML = '';
    updateCharCount();
}

function showMessageWarningModal(messageContent) {
    if (!isFirstMessageToCandidate) {
        // If not first message, send directly
        actuallySendMessage(messageContent);
        return;
    }
    
    // Show warning modal for first message
    const candidate = allCandidates.find(c => String(c.ID) === String(pendingMessage.candidateId));
    let rawJobTitle = candidate["Current Job Title"];
    if (typeof rawJobTitle === 'number' || !rawJobTitle) rawJobTitle = candidate["Job Title"] || '';
    const jobTitle = rawJobTitle ? toTitleCase(String(rawJobTitle)) : `Candidate #${candidate.ID}`;
    
    document.getElementById('warningCandidateName').textContent = jobTitle;
    document.getElementById('warningCreditsCount').textContent = userProfile.credits;
    document.getElementById('agreeToTerms').checked = false;
    document.getElementById('confirmSendBtn').disabled = true;
    document.getElementById('confirmSendBtn').style.opacity = '0.5';
    document.getElementById('confirmSendBtn').style.cursor = 'not-allowed';
    
    // Store the message to send after confirmation
    pendingMessage.messageContent = messageContent;
    
    document.getElementById('messageCreditWarningModal').classList.add('active');
}

function closeMessageWarningModal() {
    document.getElementById('messageCreditWarningModal').classList.remove('active');
    document.getElementById('agreeToTerms').checked = false;
}

function closeMessageWarningModal() {
    document.getElementById('messageCreditWarningModal').classList.remove('active');
    document.getElementById('agreeToTerms').checked = false;
}

function closeSuccessAndRedirect() {
    document.getElementById('messageCreditWarningModal').classList.remove('active');
    backToConversations();
}
        
async function confirmSendMessage() {
    if (!document.getElementById('agreeToTerms').checked) return;
    
    closeMessageWarningModal();
    await actuallySendMessage(pendingMessage.messageContent);
}

async function sendReplyMessage() {
    if (!currentMessageThread) return;
    
    const messageInput = document.getElementById('messageInput');
    const messageContent = messageInput.innerHTML.trim();
    
    if (!messageContent && messageAttachments.length === 0) {
        showError('Please enter a message or attach a file');
        return;
    }
    
    // Check character limit
    const textContent = messageInput.textContent || messageInput.innerText;
    if (textContent.length > 5000) {
        showError('Message is too long. Maximum 5000 characters.');
        return;
    }
    
    // For new conversations, show warning modal
    if (currentMessageThread.isNew) {
        showMessageWarningModal(messageContent);
    } else {
        await actuallySendMessage(messageContent);
    }
}

async function actuallySendMessage(messageContent) {
    try {
        const candidateId = pendingMessage?.candidateId || currentMessageThread.candidate_id;
        const candidate = allCandidates.find(c => String(c.ID) === String(candidateId));
        
        // Deduct credit for first message
        if (isFirstMessageToCandidate) {
            const { data: updatedUser, error: creditError } = await supabase
                .from('users')
                .update({ credits: userProfile.credits - 1 })
                .eq('id', currentUser.id)
                .select()
                .single();
            
            if (creditError) throw creditError;
            
            userProfile.credits = updatedUser.credits;
            updateCreditsDisplay(userProfile.credits);
        }
        
        // Prepare message data
        const messageData = {
            employer_id: currentUser.id,
            employer_email: currentUser.email,
            employer_name: userProfile.name || currentUser.email.split('@')[0],
            candidate_id: String(candidateId),
            candidate_name: currentMessageThread.candidate_name,
            message_text: messageContent,
            sender_type: 'employer',
            has_attachments: messageAttachments.length > 0,
            attachments: messageAttachments.length > 0 ? JSON.stringify(messageAttachments) : null,
            created_at: new Date().toISOString()
        };
        
        const { data: insertedMessage, error: messageError } = await supabase
            .from('messages')
            .insert(messageData)
            .select()
            .single();
        
        if (messageError) {
            // Refund credit if message failed
            if (isFirstMessageToCandidate) {
                await supabase
                    .from('users')
                    .update({ credits: userProfile.credits + 1 })
                    .eq('id', currentUser.id);
                userProfile.credits += 1;
                updateCreditsDisplay(userProfile.credits);
            }
            throw messageError;
        }
        
        // Track conversation metadata
        if (!conversationMetadata.has(candidateId)) {
            conversationMetadata.set(candidateId, {
                starred: false,
                archived: false,
                unread: false,
                followUpDate: null,
                firstMessageAt: new Date().toISOString(),
                lastResponseAt: null
            });
        }
        
        // Send email notification to candidate
        await sendEmailNotification(candidate, messageContent);
        
        // Clear input and attachments
        document.getElementById('messageInput').innerHTML = '';
        messageAttachments = [];
        document.getElementById('attachmentList').innerHTML = '';
        updateCharCount();
        
        // Reload the conversation
        await loadMessages();
        if (currentMessageThread) {
            const updatedThread = allConversations.find(t => t.candidate_id === candidateId);
            if (updatedThread) {
                openMessageThread(updatedThread);
            }
        }
        
        // Show success message in the existing modal style
        const modal = document.getElementById('messageCreditWarningModal');
        modal.querySelector('h2').textContent = 'Message Sent Successfully!';
        modal.querySelector('.modal-content > div:nth-child(2)').innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
                <p style="font-size: 1.1rem; margin-bottom: 1rem;">Your message has been sent to the candidate.</p>
                ${isFirstMessageToCandidate ? '<p style="color: var(--rough-gray);">1 credit has been deducted from your balance.</p>' : ''}
                <p style="color: var(--rough-gray); margin-top: 1rem;">The candidate will receive your message via email.</p>
            </div>
        `;
        modal.querySelector('.modal-content > div:last-child').innerHTML = `
            <button class="btn btn-primary" onclick="closeSuccessAndRedirect()" style="width: 100%;">Back to Messages</button>
        `;
        modal.classList.add('active');
            
        isFirstMessageToCandidate = false;
        pendingMessage = null;
        
    } catch (err) {
        showError('Failed to send message', err);
    }
}

async function sendEmailNotification(candidate, messageContent) {
    try {
        const plainText = messageContent.replace(/<[^>]*>/g, '');
        
        await supabase
            .from('email_notifications')
            .insert({
                to_email: candidate.Email,
                candidate_name: candidate["Current Job Title"] || `Candidate ${candidate.ID}`,
                employer_name: userProfile.name || 'A Golf Jobs Employer',
                message_preview: plainText.substring(0, 150),
                conversation_id: currentMessageThread.candidate_id,
                sent_at: new Date().toISOString(),
                status: 'pending'
            });
        
        console.log('Email notification queued');
    } catch (err) {
        console.error('Failed to queue email notification:', err);
    }
}

async function loadMessages() {
    const conversationsList = document.getElementById('conversationsList');
    conversationsList.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading messages...</div>';
    
    try {
        const { data: messages, error } = await supabase
            .from('messages')
            .select('*')
            .eq('employer_id', currentUser.id)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        if (!messages || messages.length === 0) {
            conversationsList.innerHTML = '<div class="empty-state"><h3>No messages yet</h3><p>Start a conversation by messaging a candidate from their profile</p></div>';
            document.getElementById('messageAnalytics').style.display = 'none';
            return;
        }
        
        // Group messages by candidate
        const threadMap = new Map();
        messages.forEach(msg => {
            const key = msg.candidate_id;
            if (!threadMap.has(key)) {
                threadMap.set(key, {
                    candidate_id: msg.candidate_id,
                    candidate_name: msg.candidate_name,
                    messages: [],
                    last_message: msg.created_at,
                    last_message_text: msg.message_text
                });
            }
            threadMap.get(key).messages.push(msg);
        });
        
        allConversations = Array.from(threadMap.values());
        
        // Load conversation metadata
        await loadConversationMetadata();
        
        // Calculate analytics
        calculateMessageAnalytics();
        
        // Apply filters
        applyMessageFilters();
        
    } catch (err) {
        showError('Failed to load messages', err);
        conversationsList.innerHTML = '<div class="error-message">Failed to load messages</div>';
    }
}

async function loadConversationMetadata() {
    try {
        const { data: metadata } = await supabase
            .from('conversation_metadata')
            .select('*')
            .eq('user_id', currentUser.id);
        
        if (metadata) {
            metadata.forEach(meta => {
                conversationMetadata.set(meta.candidate_id, {
                    starred: meta.starred || false,
                    archived: meta.archived || false,
                    unread: meta.unread || false,
                    followUpDate: meta.follow_up_date,
                    firstMessageAt: meta.first_message_at,
                    lastResponseAt: meta.last_response_at
                });
            });
        }
    } catch (err) {
        console.error('Failed to load conversation metadata:', err);
    }
}

async function saveConversationMetadata(candidateId, updates) {
    try {
        const existing = conversationMetadata.get(candidateId) || {};
        const updated = { ...existing, ...updates };
        conversationMetadata.set(candidateId, updated);
        
        await supabase
            .from('conversation_metadata')
            .upsert({
                user_id: currentUser.id,
                candidate_id: candidateId,
                starred: updated.starred,
                archived: updated.archived,
                unread: updated.unread,
                follow_up_date: updated.followUpDate,
                first_message_at: updated.firstMessageAt,
                last_response_at: updated.lastResponseAt
            });
    } catch (err) {
        console.error('Failed to save conversation metadata:', err);
    }
}

function applyMessageFilters() {
    const searchTerm = document.getElementById('messageSearchInput').value.toLowerCase();
    const filterType = document.getElementById('messageFilterSelect').value;
    const sortType = document.getElementById('messageSortSelect').value;
    
    // Filter conversations
    filteredConversations = allConversations.filter(thread => {
        const meta = conversationMetadata.get(thread.candidate_id) || {};
        
        // Apply filter type
        if (filterType === 'unread' && !meta.unread) return false;
        if (filterType === 'starred' && !meta.starred) return false;
        if (filterType === 'archived' && !meta.archived) return false;
        if (filterType === 'archived' && meta.archived) return true;
        if (meta.archived && filterType !== 'archived') return false;
        
        if (filterType === 'awaiting') {
            const lastMsg = thread.messages[0];
            if (lastMsg.sender_type !== 'employer') return false;
        }
        
        if (filterType === 'no_response') {
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const lastMsg = thread.messages[0];
            if (lastMsg.sender_type !== 'employer') return false;
            if (new Date(lastMsg.created_at) > sevenDaysAgo) return false;
        }
        
        // Apply search term
        if (searchTerm) {
            const candidateName = thread.candidate_name.toLowerCase();
            const messageText = thread.last_message_text.toLowerCase();
            if (!candidateName.includes(searchTerm) && !messageText.includes(searchTerm)) return false;
        }
        
        return true;
    });
    
    // Sort conversations
    filteredConversations.sort((a, b) => {
        if (sortType === 'recent') {
            return new Date(b.last_message) - new Date(a.last_message);
        } else if (sortType === 'oldest') {
            return new Date(a.last_message) - new Date(b.last_message);
        } else if (sortType === 'unread_first') {
            const aUnread = conversationMetadata.get(a.candidate_id)?.unread || false;
            const bUnread = conversationMetadata.get(b.candidate_id)?.unread || false;
            if (aUnread && !bUnread) return -1;
            if (!aUnread && bUnread) return 1;
            return new Date(b.last_message) - new Date(a.last_message);
        }
        return 0;
    });
    
    displayConversations();
}

function displayConversations() {
    const conversationsList = document.getElementById('conversationsList');
    
    if (filteredConversations.length === 0) {
        conversationsList.innerHTML = '<div class="empty-state"><h3>No conversations found</h3><p>Try adjusting your filters</p></div>';
        return;
    }
    
    conversationsList.innerHTML = filteredConversations.map(thread => {
        const meta = conversationMetadata.get(thread.candidate_id) || {};
        const unreadClass = meta.unread ? 'unread' : '';
        const starredClass = meta.starred ? 'starred' : '';
        const archivedClass = meta.archived ? 'archived' : '';
        
        return `
            <div class="message-thread ${unreadClass} ${starredClass} ${archivedClass}" 
                 onclick='openMessageThread(${JSON.stringify(thread).replace(/'/g, "&apos;")})'>
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <h3 style="color: var(--augusta-green); margin-bottom: 0.5rem; flex: 1;">
                        ${thread.candidate_name}
                        ${meta.unread ? '<span class="unread-badge">New</span>' : ''}
                    </h3>
                    <div class="thread-actions" onclick="event.stopPropagation()">
                        <button class="thread-action-btn" onclick="quickToggleStar('${thread.candidate_id}')" title="Star">
                            ${meta.starred ? '⭐' : '☆'}
                        </button>
                        <button class="thread-action-btn" onclick="quickArchive('${thread.candidate_id}')" title="Archive">
                            📦
                        </button>
                    </div>
                </div>
                <div class="message-preview">${thread.last_message_text.replace(/<[^>]*>/g, '').substring(0, 100)}</div>
                <div class="thread-meta">
                    <span>${thread.messages.length} message${thread.messages.length !== 1 ? 's' : ''}</span>
                    <span>${new Date(thread.last_message).toLocaleDateString()}</span>
                </div>
                ${meta.followUpDate ? `
                    <div style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; background: #fff3cd; border-radius: 4px; font-size: 0.85rem;">
                        ⏰ Follow-up: ${new Date(meta.followUpDate).toLocaleDateString()}
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function openMessageThread(thread) {
    currentMessageThread = thread;
    
    // Mark as read
    const meta = conversationMetadata.get(thread.candidate_id) || {};
    if (meta.unread) {
        saveConversationMetadata(thread.candidate_id, { unread: false });
    }
    
    document.getElementById('conversationsList').style.display = 'none';
    document.getElementById('conversationDetail').style.display = 'block';
    document.getElementById('messageFilters').style.display = 'none';
    document.getElementById('conversationTitle').textContent = thread.candidate_name;
    document.getElementById('conversationSubtitle').textContent = `${thread.messages.length} messages in this conversation`;
    
    // Update button states
    document.getElementById('starBtn').textContent = meta.starred ? '⭐ Starred' : '☆ Star';
    document.getElementById('archiveBtn').textContent = meta.archived ? '📦 Unarchive' : '📦 Archive';
    
    // Display follow-up reminder if exists
    const reminderDisplay = document.getElementById('followUpReminderDisplay');
    if (meta.followUpDate) {
        const followUpDate = new Date(meta.followUpDate);
        const isOverdue = followUpDate < new Date();
        reminderDisplay.innerHTML = `
            <strong>${isOverdue ? '⚠️ Overdue' : '⏰'} Follow-up reminder:</strong> 
            ${followUpDate.toLocaleDateString()} at ${followUpDate.toLocaleTimeString()}
            <button class="btn btn-small btn-secondary" onclick="clearFollowUpReminder()" style="margin-left: 1rem;">Clear</button>
        `;
        reminderDisplay.style.display = 'block';
    } else {
        reminderDisplay.style.display = 'none';
    }
    
    displayMessageThread(thread.messages);
}

function displayMessageThread(messages) {
    const messageConversation = document.getElementById('messageConversation');
    
    const sortedMessages = messages.sort((a, b) => 
        new Date(a.created_at) - new Date(b.created_at)
    );
    
    messageConversation.innerHTML = sortedMessages.map(msg => {
        const isSent = msg.sender_type === 'employer';
        const attachments = msg.attachments ? JSON.parse(msg.attachments) : [];
        
        return `
            <div class="message-bubble ${isSent ? 'sent' : 'received'}">
                <div style="margin-bottom: 0.5rem;">${msg.message_text}</div>
                ${attachments.length > 0 ? `
                    <div>
                        ${attachments.map(att => `
                            <div class="message-attachment" onclick="downloadAttachment('${att.url}', '${att.name}')">
                                📎 ${att.name}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                <div class="message-time">
                    ${new Date(msg.created_at).toLocaleString()}
                    ${isSent ? '' : ' • ' + (msg.sender_name || 'Candidate')}
                </div>
            </div>
        `;
    }).join('');
    
    messageConversation.scrollTop = messageConversation.scrollHeight;
}

function searchWithinConversation() {
    const searchTerm = document.getElementById('searchWithinInput').value.toLowerCase();
    if (!searchTerm) {
        displayMessageThread(currentMessageThread.messages);
        return;
    }
    
    const filtered = currentMessageThread.messages.filter(msg => 
        msg.message_text.toLowerCase().includes(searchTerm) ||
        msg.sender_name?.toLowerCase().includes(searchTerm)
    );
    
    displayMessageThread(filtered);
}

function backToConversations() {
    document.getElementById('conversationsList').style.display = 'block';
    document.getElementById('conversationDetail').style.display = 'none';
    document.getElementById('messageFilters').style.display = 'block';
    currentMessageThread = null;
    applyMessageFilters();
}

async function toggleStarConversation() {
    if (!currentMessageThread) return;
    
    const meta = conversationMetadata.get(currentMessageThread.candidate_id) || {};
    const newStarred = !meta.starred;
    
    await saveConversationMetadata(currentMessageThread.candidate_id, { starred: newStarred });
    
    document.getElementById('starBtn').textContent = newStarred ? '⭐ Starred' : '☆ Star';
}

async function quickToggleStar(candidateId) {
    const meta = conversationMetadata.get(candidateId) || {};
    await saveConversationMetadata(candidateId, { starred: !meta.starred });
    applyMessageFilters();
}

async function archiveConversation() {
    if (!currentMessageThread) return;
    
    const meta = conversationMetadata.get(currentMessageThread.candidate_id) || {};
    const newArchived = !meta.archived;
    
    await saveConversationMetadata(currentMessageThread.candidate_id, { archived: newArchived });
    
    backToConversations();
}

async function quickArchive(candidateId) {
    const meta = conversationMetadata.get(candidateId) || {};
    await saveConversationMetadata(candidateId, { archived: !meta.archived });
    applyMessageFilters();
}

function setFollowUpReminder() {
    const dateStr = prompt('Set follow-up reminder date and time:\n\nFormat: YYYY-MM-DD HH:MM\nExample: 2025-10-15 14:30');
    
    if (!dateStr) return;
    
    try {
        const followUpDate = new Date(dateStr);
        if (isNaN(followUpDate.getTime())) {
            throw new Error('Invalid date');
        }
        
        saveConversationMetadata(currentMessageThread.candidate_id, { 
            followUpDate: followUpDate.toISOString() 
        });
        
        const meta = conversationMetadata.get(currentMessageThread.candidate_id);
        const reminderDisplay = document.getElementById('followUpReminderDisplay');
        reminderDisplay.innerHTML = `
            <strong>⏰ Follow-up reminder:</strong> 
            ${followUpDate.toLocaleDateString()} at ${followUpDate.toLocaleTimeString()}
            <button class="btn btn-small btn-secondary" onclick="clearFollowUpReminder()" style="margin-left: 1rem;">Clear</button>
        `;
        reminderDisplay.style.display = 'block';
        
    } catch (err) {
        alert('Invalid date format. Please use: YYYY-MM-DD HH:MM');
    }
}

function clearFollowUpReminder() {
    saveConversationMetadata(currentMessageThread.candidate_id, { followUpDate: null });
    document.getElementById('followUpReminderDisplay').style.display = 'none';
}

function toggleAnalytics() {
    const analyticsDiv = document.getElementById('messageAnalytics');
    if (analyticsDiv.style.display === 'none' || !analyticsDiv.style.display) {
        analyticsDiv.style.display = 'grid';
    } else {
        analyticsDiv.style.display = 'none';
    }
}

function calculateMessageAnalytics() {
    const totalConversations = allConversations.length;
    
    let conversationsWithResponse = 0;
    let totalResponseTime = 0;
    let responseCount = 0;
    
    allConversations.forEach(thread => {
        const employerMessages = thread.messages.filter(m => m.sender_type === 'employer');
        const candidateMessages = thread.messages.filter(m => m.sender_type === 'candidate');
        
        if (candidateMessages.length > 0) {
            conversationsWithResponse++;
            
            employerMessages.forEach(empMsg => {
                const laterCandidateMsg = candidateMessages.find(candMsg => 
                    new Date(candMsg.created_at) > new Date(empMsg.created_at)
                );
                
                if (laterCandidateMsg) {
                    const responseTime = new Date(laterCandidateMsg.created_at) - new Date(empMsg.created_at);
                    totalResponseTime += responseTime;
                    responseCount++;
                }
            });
        }
    });
    
    const responseRate = totalConversations > 0 
        ? Math.round((conversationsWithResponse / totalConversations) * 100) 
        : 0;
    
    const avgResponseTime = responseCount > 0
        ? totalResponseTime / responseCount
        : 0;
    
    let avgResponseFormatted = '-';
    if (avgResponseTime > 0) {
        const hours = Math.floor(avgResponseTime / (1000 * 60 * 60));
        const minutes = Math.floor((avgResponseTime % (1000 * 60 * 60)) / (1000 * 60));
        if (hours > 24) {
            avgResponseFormatted = `${Math.floor(hours / 24)}d ${hours % 24}h`;
        } else if (hours > 0) {
            avgResponseFormatted = `${hours}h ${minutes}m`;
        } else {
            avgResponseFormatted = `${minutes}m`;
        }
    }
    
    const uniqueCandidates = new Set(allConversations.map(t => t.candidate_id));
    const creditsUsed = uniqueCandidates.size;
    
    document.getElementById('totalConversations').textContent = totalConversations;
    document.getElementById('responseRate').textContent = responseRate + '%';
    document.getElementById('avgResponseTime').textContent = avgResponseFormatted;
    document.getElementById('creditsUsed').textContent = creditsUsed;
}

// Rich text editor functions
function formatText(command) {
    document.execCommand(command, false, null);
    document.getElementById('messageInput').focus();
}

function insertLink() {
    const url = prompt('Enter URL:');
    if (url) {
        document.execCommand('createLink', false, url);
    }
}

function toggleEmojiPicker() {
    const popup = document.getElementById('emojiPopup');
    popup.classList.toggle('active');
}

function insertEmoji(emoji) {
    const messageInput = document.getElementById('messageInput');
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);
    const textNode = document.createTextNode(emoji);
    range.insertNode(textNode);
    range.setStartAfter(textNode);
    range.setEndAfter(textNode);
    selection.removeAllRanges();
    selection.addRange(range);
    messageInput.focus();
    toggleEmojiPicker();
    updateCharCount();
}

async function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    
    for (const file of files) {
        if (file.size > 10 * 1024 * 1024) {
            alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
            continue;
        }
        
        try {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch(
                'https://kbadedwbcjetxiertztv.supabase.co/functions/v1/upload-attachment',
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: formData
                }
            );
            
            if (!response.ok) throw new Error('Upload failed');
            
            const uploaded = await response.json();
            messageAttachments.push(uploaded);
        } catch (err) {
            showError(`Failed to upload ${file.name}`);
        }
    }
    
    displayAttachments();
    event.target.value = '';
}

function displayAttachments() {
    const attachmentList = document.getElementById('attachmentList');
    attachmentList.innerHTML = messageAttachments.map((att, index) => `
        <div class="attachment-item">
            📎 ${att.name} (${formatFileSize(att.size)})
            <button onclick="removeAttachment(${index})">×</button>
        </div>
    `).join('');
}

function removeAttachment(index) {
    messageAttachments.splice(index, 1);
    displayAttachments();
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function downloadAttachment(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
}

function updateCharCount() {
    const messageInput = document.getElementById('messageInput');
    const charCount = document.getElementById('charCount');
    const text = messageInput.textContent || messageInput.innerText || '';
    const count = text.length;
    
    charCount.textContent = `${count} / 5000 characters`;
    
    if (count > 5000) {
        charCount.classList.add('warning');
    } else {
        charCount.classList.remove('warning');
    }
}

function bulkArchiveMessages() {
    alert('Bulk archive feature - select conversations to archive multiple at once');
}

        // ============================================================================
        // USER LISTS & SHORTLIST
        // ============================================================================
        
        async function loadUserLists() {
            try {
                const { data: lists, error } = await supabase
                    .from('user_lists')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                userLists = lists || [];
                
                const listSelector = document.getElementById('listSelector');
                listSelector.innerHTML = '<option value="">Select a list...</option>';
                userLists.forEach(list => {
                    const option = document.createElement('option');
                    option.value = list.id;
                    option.textContent = list.name;
                    listSelector.appendChild(option);
                });
                
                if (userLists.length > 0 && !currentListId) {
                    currentListId = userLists[0].id;
                    listSelector.value = currentListId;
                    await loadShortlistForList(currentListId);
                }
                
                updateShortlistBadge();
            } catch (err) {
                console.error('Error loading lists:', err);
            }
        }

        function updateShortlistBadge() {
            const badge = document.getElementById('shortlistBadge');
            const mobileBadge = document.getElementById('mobileShortlistBadge');
            if (userLists.length > 0) {
                badge.style.display = 'inline';
                badge.textContent = userLists.length;
                mobileBadge.style.display = 'inline';
                mobileBadge.textContent = `(${userLists.length})`;
            } else {
                badge.style.display = 'none';
                mobileBadge.style.display = 'none';
            }
        }

        async function switchList() {
            const listId = document.getElementById('listSelector').value;
            const deleteBtn = document.getElementById('deleteCurrentListBtn');
            
            if (listId) {
                currentListId = listId;
                await loadShortlistForList(listId);
                deleteBtn.style.display = 'block';
            } else {
                currentListId = null;
                shortlist = [];
                displayShortlistContent();
                deleteBtn.style.display = 'none';
            }
        }

        async function loadShortlistForList(listId) {
            try {
                const { data: shortlistData, error: shortlistError } = await supabase
                    .from('shortlists')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('list_id', listId);
                
                if (shortlistError) throw shortlistError;
                
                if (shortlistData && shortlistData.length > 0) {
                    const candidateIds = shortlistData.map(item => String(item.candidate_id));
                    
                    const { data: candidatesData, error: candidatesError } = await supabase
                        .from('candidates')
                        .select('*')
                        .in('ID', candidateIds);
                    
                    if (candidatesError) throw candidatesError;
                    
                    const byId = new Map((candidatesData || []).map(c => [String(c.ID), c]));
                    shortlist = shortlistData.map(item => ({
                        ...item,
                        candidate: byId.get(String(item.candidate_id)) || null
                    }));
                } else {
                    shortlist = [];
                }
                
                selectedShortlistItems.clear();
                displayShortlistContent();
            } catch (err) {
                showError('Failed to load shortlist', err);
                shortlist = [];
                displayShortlistContent();
            }
        }

        function loadShortlist() {
            loadUserLists();
        }

        function displayShortlistContent() {
            const content = document.getElementById('shortlistContent');
            const countElem = document.getElementById('shortlistCount');
            
            if (!currentListId) {
                countElem.textContent = 'Select a list to view candidates';
                content.innerHTML = '<div class="empty-state"><h3>Select a list to view candidates</h3></div>';
                return;
            }
            
            countElem.textContent = `${shortlist.length} candidate${shortlist.length !== 1 ? 's' : ''} in this list`;
            
            if (shortlist.length === 0) {
                content.innerHTML = '<div class="empty-state"><h3>No candidates in this list</h3><p>Browse talent pools and add candidates to this list</p></div>';
                return;
            }
            
            content.innerHTML = shortlist.map(item => {
                const c = item.candidate;
                if (!c) return '';
                
                let rawJobTitle = c["Current Job Title"];
                if (typeof rawJobTitle === 'number' || !rawJobTitle) rawJobTitle = c["Job Title"] || '';
                const jobTitle = rawJobTitle ? toTitleCase(String(rawJobTitle)) : `Candidate #${c.ID}`;
                const location = cleanAndFormatLocation(c["Town/City"], c.Country);
                const salary = formatSalaryExact(c["What are your salary expectations?"]);
                const notice = formatNoticePeriod(c["Notice Period"]);
                const isSelected = selectedShortlistItems.has(String(item.id));
                const about = c["About You"] || '';
                const summaryPreview = about.substring(0, 150) + (about.length > 150 ? '...' : '');
                
                return `
                    <div class="candidate-list-item ${isSelected ? 'selected' : ''}" 
                         id="shortlist-card-${item.id}" 
                         style="background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border: 2px solid ${isSelected ? 'var(--masters-green)' : '#e5e7eb'}; cursor: pointer; transition: all 0.3s ease; position: relative;" 
                         onclick='viewShortlistCandidate("${c.ID}")'>
                        <input type="checkbox" 
                               style="position: absolute; top: 1rem; left: 1rem; width: 20px; height: 20px; cursor: pointer; z-index: 10;" 
                               ${isSelected ? 'checked' : ''} 
                               onchange='toggleShortlistSelection("${item.id}")' 
                               onclick="event.stopPropagation()">
                        <div style="padding-left: 2.5rem;">
                            <h3 style="color: var(--augusta-green); margin-bottom: 0.25rem; font-size: 1.2rem; font-weight: 600;">${jobTitle}</h3>
                            <p style="color: var(--rough-gray); font-size: 0.9rem; margin-bottom: 0.5rem;">${location}</p>
                            ${summaryPreview ? `<p style="color: #555; font-size: 0.85rem; line-height: 1.4; margin-bottom: 0.75rem;">${summaryPreview}</p>` : ''}
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: var(--rough-gray); font-size: 0.85rem;">${salary} • ${notice}</span>
                                <span style="color: var(--masters-green); font-weight: 600;">View →</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            bulkDeleteBtn.style.display = selectedShortlistItems.size > 0 ? 'inline-block' : 'none';
        }

        async function viewShortlistCandidate(candidateId) {
            const shortlistItem = shortlist.find(item => String(item.candidate?.ID) === String(candidateId));
            if (!shortlistItem || !shortlistItem.candidate) return;
            
            const candidate = shortlistItem.candidate;
            
            if (!allCandidates.find(c => String(c.ID) === String(candidateId))) {
                allCandidates = [candidate, ...allCandidates];
            }
            
            currentCandidate = candidate;
            
            let rawJobTitle = candidate["Current Job Title"];
            if (typeof rawJobTitle === 'number' || !rawJobTitle || rawJobTitle === '') {
                rawJobTitle = candidate["Job Title"] || '';
            }
            const jobTitle = rawJobTitle ? toTitleCase(String(rawJobTitle)) : `Candidate #${candidate.ID}`;
            const location = cleanAndFormatLocation(candidate["Town/City"], candidate.Country);
            const about = candidate["About You"] || 'No summary provided';
            const skills = candidate["Your Skills"] || '';
            const salary = formatSalaryExact(candidate["What are your salary expectations?"]);
            const notice = formatNoticePeriod(candidate["Notice Period"]);
            const activelyLooking = candidate["Actively looking for work"];
            const activeStatus = (activelyLooking && activelyLooking.toUpperCase() === 'YES') 
                ? 'Actively Looking For Work' 
                : 'Not Actively Looking';
            const profileScore = calculateProfileScore(candidate);
            const isTopPick = profileScore >= CONFIG.TOP_PICK_THRESHOLD;
            const notes = await loadCandidateNotes(candidateId);
            
            const profileHTML = `
                <div style="margin-bottom: 2rem;">
                    <h1 style="color: var(--augusta-green); margin-bottom: 0.5rem; font-size: 1.8rem;">${jobTitle}</h1>
                    ${isTopPick ? '<div class="top-pick-badge" style="position: relative; top: 0; right: auto; margin-top: 0.5rem; display: inline-flex;">⭐ TOP PICK</div>' : ''}
                    <p style="color: var(--rough-gray); font-size: 1.1rem; margin-top: 0.5rem;">${location}</p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">Salary Expectations</div>
                        <div style="font-weight: 600; font-size: 1.1rem;">${salary}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">Notice Period</div>
                        <div style="font-weight: 600; font-size: 1.1rem;">${notice}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.8rem; color: var(--rough-gray); text-transform: uppercase; margin-bottom: 0.25rem;">Job Search Status</div>
                        <div style="font-weight: 600; font-size: 1.1rem;">${activeStatus}</div>
                    </div>
                </div>
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Professional Summary</h3>
                    <p style="line-height: 1.8; color: #333; white-space: pre-wrap;">${about}</p>
                </div>
                ${skills ? `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Skills & Expertise</h3>
                        <p style="line-height: 1.6; color: #333; white-space: pre-wrap;">${skills}</p>
                    </div>
                ` : ''}
                <div class="notes-section">
                    <h3 style="color: var(--augusta-green); margin-bottom: 1rem;">Your Notes</h3>
                    <div style="margin-bottom: 1rem;">
                        <textarea id="newNoteInput" placeholder="Add a note about this candidate..." 
                                  style="width: 100%; padding: 0.75rem; border: 2px solid #e1e8e4; border-radius: 8px; font-family: inherit; resize: vertical; min-height: 80px;"></textarea>
                        <button class="btn btn-primary btn-small" 
                                onclick='saveNote("${candidateId}", document.getElementById("newNoteInput").value)' 
                                style="margin-top: 0.5rem;">Save Note</button>
                    </div>
                    ${notes.length > 0 ? `
                        <div style="margin-top: 1.5rem;">
                            ${notes.map(note => `
                                <div class="note-item">
                                    <div class="note-text">${note.note}</div>
                                    <div class="note-meta">
                                        <span>${new Date(note.created_at).toLocaleDateString()}</span>
                                        <div class="note-actions">
                                            <button class="btn btn-secondary btn-small" 
                                                    onclick='const newText = prompt("Edit note:", ${JSON.stringify(note.note)}); if (newText) editNote("${note.id}", newText);'>Edit</button>
                                            <button class="btn btn-danger btn-small" 
                                                    onclick='deleteNote("${note.id}")'>Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: var(--rough-gray); font-style: italic;">No notes yet. Add one above!</p>'}
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary btn-small" onclick="addToShortlist()">Add to Another List</button>
                    <button class="btn btn-primary btn-small" onclick='sendMessageToCandidate("${candidate.ID}")'>Send Message (1 Credit)</button>
                    <button class="btn btn-danger btn-small" onclick='removeFromShortlistByCandidate("${candidate.ID}")'>Remove from List</button>
                </div>
            `;
            
            document.getElementById('shortlistProfileView').innerHTML = profileHTML;
            
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                const rightPanel = document.querySelector('#shortlistView .split-view-right');
                if (rightPanel) rightPanel.classList.add('mobile-active');
            }
        }

        async function removeFromShortlistByCandidate(candidateId) {
            const item = shortlist.find(i => String(i.candidate?.ID) === String(candidateId));
            if (item) {
                await removeFromShortlist(item.id);
            }
        }

        function toggleShortlistSelection(itemId) {
            const id = String(itemId);
            if (selectedShortlistItems.has(id)) {
                selectedShortlistItems.delete(id);
                const card = document.getElementById(`shortlist-card-${itemId}`);
                if (card) {
                    card.classList.remove('selected');
                    card.style.borderColor = '#e5e7eb';
                }
            } else {
                selectedShortlistItems.add(id);
                const card = document.getElementById(`shortlist-card-${itemId}`);
                if (card) {
                    card.classList.add('selected');
                    card.style.borderColor = 'var(--masters-green)';
                }
            }
            
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            bulkDeleteBtn.style.display = selectedShortlistItems.size > 0 ? 'inline-block' : 'none';
        }

        function selectAllShortlist() {
            shortlist.forEach(item => {
                const id = String(item.id);
                selectedShortlistItems.add(id);
                const card = document.getElementById(`shortlist-card-${item.id}`);
                if (card) {
                    card.classList.add('selected');
                    card.style.borderColor = 'var(--masters-green)';
                    const checkbox = card.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = true;
                }
            });
            document.getElementById('bulkDeleteBtn').style.display = 'inline-block';
        }

        function deselectAllShortlist() {
            selectedShortlistItems.clear();
            document.querySelectorAll('[id^="shortlist-card-"]').forEach(card => {
                card.classList.remove('selected');
                card.style.borderColor = '#e5e7eb';
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = false;
            });
            document.getElementById('bulkDeleteBtn').style.display = 'none';
        }

        async function addToShortlist() {
            if (!currentCandidate) return;
            pendingCandidatesForList = [String(currentCandidate.ID)];
            showListSelectorModal();
        }

        async function bulkAddToShortlist() {
            if (selectedCandidates.size === 0) {
                alert('Please select candidates first');
                return;
            }
            pendingCandidatesForList = Array.from(selectedCandidates);
            showListSelectorModal();
        }

        function showListSelectorModal() {
            const modalListSelector = document.getElementById('modalListSelector');
            modalListSelector.innerHTML = '<option value="">Choose a list...</option>';
            userLists.forEach(list => {
                const option = document.createElement('option');
                option.value = list.id;
                option.textContent = list.name;
                modalListSelector.appendChild(option);
            });
            
            document.getElementById('newListNameInput').value = '';
            document.getElementById('listSelectorModal').classList.add('active');
        }

        function closeListSelectorModal() {
            document.getElementById('listSelectorModal').classList.remove('active');
            pendingCandidatesForList = [];
        }

        async function confirmListSelection() {
            const selectedListId = document.getElementById('modalListSelector').value;
            const newListName = document.getElementById('newListNameInput').value.trim();
            
            let targetListId = null;
            
            if (newListName) {
                try {
                    const { data, error } = await supabase
                        .from('user_lists')
                        .insert({ 
                            user_id: currentUser.id, 
                            name: newListName 
                        })
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    targetListId = data.id;
                    await loadUserLists();
                } catch (err) {
                    showError('Failed to create list', err);
                    return;
                }
            } else if (selectedListId) {
                targetListId = selectedListId;
            } else {
                alert('Please select a list or create a new one');
                return;
            }
            
            let added = 0;
            let skipped = 0;
            
            for (const candidateId of pendingCandidatesForList) {
                const { data: existing } = await supabase
                    .from('shortlists')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('candidate_id', String(candidateId))
                    .eq('list_id', targetListId)
                    .single();
                
                if (!existing) {
                    const { error } = await supabase
                        .from('shortlists')
                        .insert({ 
                            user_id: currentUser.id, 
                            candidate_id: String(candidateId), 
                            list_id: targetListId 
                        });
                    
                    if (!error) added++;
                } else {
                    skipped++;
                }
            }
            
            closeListSelectorModal();
            
            if (added > 0) {
                const listName = userLists.find(l => l.id === targetListId)?.name || 'list';
                alert(`Added ${added} candidate${added !== 1 ? 's' : ''} to "${listName}"${skipped > 0 ? ` (${skipped} already in list)` : ''}`);
            } else if (skipped > 0) {
                alert('All selected candidates are already in this list');
            }
            
            deselectAll();
            closeMobileProfile();
            
            if (document.getElementById('shortlistView').classList.contains('active')) {
                currentListId = targetListId;
                document.getElementById('listSelector').value = targetListId;
                await loadShortlistForList(targetListId);
            }
        }

        function showCreateListModal() {
            document.getElementById('createListNameInput').value = '';
            document.getElementById('createListModal').classList.add('active');
        }

        function closeCreateListModal() {
            document.getElementById('createListModal').classList.remove('active');
        }

        async function confirmCreateList() {
            const listName = document.getElementById('createListNameInput').value.trim();
            if (!listName) {
                alert('Please enter a list name');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('user_lists')
                    .insert({ 
                        user_id: currentUser.id, 
                        name: listName 
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                await loadUserLists();
                
                currentListId = data.id;
                document.getElementById('listSelector').value = currentListId;
                await loadShortlistForList(currentListId);
                
                closeCreateListModal();
            } catch (err) {
                showError('Failed to create list', err);
            }
        }

        async function deleteCurrentList() {
            if (!currentListId) return;
            
            const listName = userLists.find(l => l.id === currentListId)?.name || 'this list';
            if (!confirm(`Delete "${listName}" and all its candidates?\n\nThis cannot be undone.`)) return;
            
            try {
                const { error } = await supabase
                    .from('user_lists')
                    .delete()
                    .eq('id', currentListId);
                
                if (error) throw error;
                
                currentListId = null;
                await loadUserLists();
                
                if (userLists.length > 0) {
                    currentListId = userLists[0].id;
                    document.getElementById('listSelector').value = currentListId;
                    await loadShortlistForList(currentListId);
                } else {
                    document.getElementById('listSelector').value = '';
                    shortlist = [];
                    displayShortlistContent();
                    document.getElementById('deleteCurrentListBtn').style.display = 'none';
                }
            } catch (err) {
                showError('Failed to delete list', err);
            }
        }

        async function removeFromShortlist(itemId) {
            if (!confirm('Remove this candidate from your list?')) return;
            
            try {
                const { error } = await supabase
                    .from('shortlists')
                    .delete()
                    .eq('id', itemId);
                
                if (error) throw error;
                
                await loadShortlistForList(currentListId);
            } catch (err) {
                showError('Failed to remove from list', err);
            }
        }

        async function bulkDeleteFromShortlist() {
            if (selectedShortlistItems.size === 0) {
                alert('Please select candidates first');
                return;
            }
            
            if (!confirm(`Remove ${selectedShortlistItems.size} candidates from your list?`)) return;
            
            try {
                const ids = Array.from(selectedShortlistItems);
                const { error } = await supabase
                    .from('shortlists')
                    .delete()
                    .in('id', ids);
                
                if (error) throw error;
                
                selectedShortlistItems.clear();
                await loadShortlistForList(currentListId);
            } catch (err) {
                showError('Failed to remove candidates', err);
            }
        }

        function exportShortlist() {
            if (shortlist.length === 0) {
                alert('No candidates in current list');
                return;
            }
            
            let csv = 'Job Title,Location,Salary,Notice Period\n';
            shortlist.forEach(item => {
                const c = item.candidate;
                if (c) {
                    let rawJobTitle = c["Current Job Title"];
                    if (typeof rawJobTitle === 'number' || !rawJobTitle) rawJobTitle = c["Job Title"] || '';
                    const jobTitle = rawJobTitle ? toTitleCase(String(rawJobTitle)) : `Candidate #${c.ID}`;
                    const location = cleanAndFormatLocation(c["Town/City"], c.Country);
                    const salary = c["What are your salary expectations?"] || 'Negotiable';
                    const notice = c["Notice Period"] || 'Unknown';
                    csv += `"${jobTitle}","${location}","${salary}","${notice}"\n`;
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const listName = userLists.find(l => l.id === currentListId)?.name || 'shortlist';
            a.download = `${listName.replace(/\s+/g, '_')}.csv`;
            a.click();
        }

        // ============================================================================
        // ACCOUNT PAGE
        // ============================================================================
        
        async function loadAccount() {
            document.getElementById('accountName').textContent = userProfile?.name || '-';
            document.getElementById('accountEmail').textContent = currentUser?.email || '-';
            document.getElementById('accountCredits').textContent = userProfile?.credits || 0;
            
            try {
                const { data: messages } = await supabase
                    .from('messages')
                    .select('id')
                    .eq('employer_id', currentUser.id);
                
                document.getElementById('totalMessages').textContent = messages ? messages.length : 0;
            } catch (err) {
                console.error('Error loading message count:', err);
                document.getElementById('totalMessages').textContent = '0';
            }
        }

        // ============================================================================
        // ADMIN PAGE
        // ============================================================================
        
        async function loadAdmin() {
            if (userProfile?.role !== 'admin') {
                document.getElementById('adminContent').innerHTML = '<p>Access denied.</p>';
                return;
            }
            
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = '<div class="skeleton" style="height: 300px; border-radius: 16px;"></div>';
            
            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                const { data: messages } = await supabase
                    .from('messages')
                    .select('employer_id, employer_email, created_at, candidate_name, message_text');
                
                const { data: views } = await supabase
                    .from('profile_views')
                    .select('candidate_id, candidate_name, viewed_at');
                
                const messagesByUser = (messages || []).reduce((acc, msg) => {
                    acc[msg.employer_id] = (acc[msg.employer_id] || 0) + 1;
                    return acc;
                }, {});
                
                const viewsByCandidate = (views || []).reduce((acc, view) => {
                    const key = view.candidate_id;
                    if (!acc[key]) {
                        acc[key] = { id: view.candidate_id, name: view.candidate_name, count: 0 };
                    }
                    acc[key].count++;
                    return acc;
                }, {});
                
                const topViewedCandidates = Object.values(viewsByCandidate)
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10);
                
                adminContent.innerHTML = `
                    <div class="section-box">
                        <h2 style="color: var(--augusta-green); margin-bottom: 1.5rem;">User Management</h2>
                        <div style="overflow-x: auto;">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th style="text-align: center;">Credits</th>
                                        <th style="text-align: center;">Messages Sent</th>
                                        <th style="text-align: center;">Role</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(users || []).map(user => `
                                        <tr>
                                            <td>${user.name || '-'}</td>
                                            <td>${user.email}</td>
                                            <td style="text-align: center; font-weight: 600;">${user.credits || 0}</td>
                                            <td style="text-align: center;">${messagesByUser[user.id] || 0}</td>
                                            <td style="text-align: center;">
                                                <span class="role-badge ${user.role === 'admin' ? 'admin' : 'employer'}">
                                                    ${user.role || 'employer'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="section-box">
                        <h2 style="color: var(--augusta-green); margin-bottom: 1.5rem;">Most Viewed Candidates</h2>
                        <div style="overflow-x: auto;">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Candidate ID</th>
                                        <th>Name</th>
                                        <th style="text-align: center;">View Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topViewedCandidates.map(candidate => `
                                        <tr>
                                            <td>${candidate.id}</td>
                                            <td>${candidate.name || 'Unknown'}</td>
                                            <td style="text-align: center; font-weight: 700; color: var(--augusta-green);">
                                                ${candidate.count}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="section-box">
                        <h2 style="color: var(--augusta-green); margin-bottom: 1.5rem;">All Messages</h2>
                        <div style="overflow-x: auto;">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>From</th>
                                        <th>To Candidate</th>
                                        <th>Message Preview</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(messages || []).map(msg => `
                                        <tr>
                                            <td>${new Date(msg.created_at).toLocaleString()}</td>
                                            <td>${msg.employer_email}</td>
                                            <td>${msg.candidate_name}</td>
                                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                ${msg.message_text}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (err) {
                showError('Failed to load admin data', err);
                adminContent.innerHTML = '<div class="error-message">Failed to load admin data</div>';
            }
        }
    </script>
</body>
</html>
